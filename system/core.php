<?php $stopwatch=microtime(); define('IGNORE_VERSION_MISMATCH',false); define('E2_VERSION',3254); define('E2_RELEASE','2.7'); define('E2_UA_STRING','E2 (v'. E2_VERSION .'; Aegea)'); define('E2_MINIMUM_PHP','5.3.9'); define('RSS_AS_TEXT',0); define('BUILDER_OBFUSCATE',1); define('BUILDER_FLATTEN',1); header('X-Powered-By: E2 Aegea v'. E2_VERSION); if(version_compare(PHP_VERSION,E2_MINIMUM_PHP) < 0){ die ('PHP version must be '. E2_MINIMUM_PHP .' or later, you are running '. PHP_VERSION); } define('OUTPUT_CHARSET','UTF-8'); setlocale(LC_CTYPE,'ru_RU.UTF'); mb_internal_encoding('UTF-8'); define('HSC_ENC','UTF-8'); if(function_exists('date_default_timezone_set'))date_default_timezone_set('GMT'); error_reporting(E_ALL); define('RUN_ID',chr(rand(65,90))); define('DEV_TRACK_TIME',false); define('DEV_HOST','e2'); define('SECONDS_IN_A_MINUTE',60); define('SECONDS_IN_AN_HOUR',3600); define('SECONDS_IN_A_DAY',86400); define('SECONDS_IN_A_MONTH',2592000); define('SECONDS_IN_A_YEAR',31536000); define('YEAR_DISPLAY_THRESH',7884000); define('KILO_THRESH',768); define('BYTES_DECIMALS',1); define('FILE_READ_BUFFER',64*1024); define('KEYWORDS_MANY_THRESH',50); if(defined('JSON_PRETTY_PRINT')) { define('E2_JSON_STYLE',JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); } else { define('E2_JSON_STYLE',0); } define('NEW_FILES_RIGHTS',0777); if(is_file('multiuser')) { define('USER_MODE','multi'); } else { define('USER_MODE','single'); } if(is_file('superconfig.php')) { include 'superconfig.php'; } $_protocol=( !empty ($_SERVER['HTTPS']) && $_SERVER['HTTPS']!=='off' or $_SERVER['SERVER_PORT']==443 or isset ($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO']=='https' or isset ($_SERVER['HTTP_X_HTTPS']) && ($_SERVER['HTTP_X_HTTPS']) ) ? 'https':'http'; if(is_file('force-https')) { $_protocol='https'; } $ya57c1=substr( $_SERVER['PHP_SELF'],0,strpos($_SERVER['PHP_SELF'],'/index.php') ); list ($s57de2, ) = explode(':',$_SERVER['HTTP_HOST']); $full_blog_url=$_protocol. '://'. $s57de2.$ya57c1; $_user_folder_name=str_replace('/','--',$s57de2.$ya57c1); if(substr($_user_folder_name,0,4)=='www.'){ $_user_folder_name=substr($_user_folder_name,4); } if(USER_MODE=='multi'){ if (@array_key_exists($_user_folder_name,$_superconfig['rewrites'])) { $_user_folder_name=$_superconfig['rewrites'][$_user_folder_name]; } define('USER_FOLDER','users/'. $_user_folder_name .'/'); } else { define('USER_FOLDER', @$__E2_FOLDER_PREFIX__.'user/'); } if(@$_superconfig['store_files_by_users']) { define('MEDIA_ROOT_FOLDER',USER_FOLDER .'files/'); } else { define('MEDIA_ROOT_FOLDER',''); } define('EXTRAS_FOLDER',USER_FOLDER.'extras/'); define('BACKUP_FOLDER',USER_FOLDER.'backup/'); define('CACHES_FOLDER',USER_FOLDER.'caches/'); define('USER_LIBRARY_FOLDER',USER_FOLDER.'library/'); define('LOG_FILE',USER_FOLDER.'log.txt'); define('LOG_SPECIAL_FILE',USER_FOLDER.'log-special.txt'); define('PICTURES_FOLDER','pictures/'); define('THUMBNAILS_FOLDER','pictures/thumbs/'); define('AUDIO_FOLDER','audio/'); define('TEMPLATES_FOLDER','themes/'); define('SYSTEM_FOLDER','system/'); define('SCRIPTS_FOLDER','system/js/'); define('SYSTEM_LIBRARY_FOLDER','system/library/'); define('SYSTEM_TEMPLATE_FOLDER','system/theme/'); define('DEFAULT_USERPIC_FILENAME','system/theme/images/userpic.svg'); define('DEFAULT_USERPIC_PLACEHOLDER_FILENAME','system/theme/images/userpic-placeholder.svg'); define('AUDIO_ICON_IMAGE','system/theme/images/audio.svg'); define('AUDIO_ICON_WIDTH',64); define('AUDIO_ICON_HEIGHT',64); define('LANGUAGES_FOLDER','system/languages/'); define('DEFAULTS_FOLDER','system/default/'); define('MTMPL_FOLDER','system/default/mail/'); define('DEFAULT_TEMPLATE','plain'); if(substr(@$_SERVER['HTTP_ACCEPT_LANGUAGE'],0,2)=='ru'){ define('DEFAULT_LANGUAGE','ru'); } else { define('DEFAULT_LANGUAGE','en'); } @include DEFAULTS_FOLDER. 'config.php'; $_default_config=$_config; @include USER_FOLDER. 'config.php'; $_config=array_merge($_default_config,$_config); if( $_config['write_log'] and ($_config['write_log_create'] or is_file(LOG_FILE)) )define('__LOG',1); else define('__LOG',0); if(@$_config['write_log_limit'] and is_file(LOG_FILE)) { $vbc7b3=@stat(LOG_FILE); $vbc7b3=$vbc7b3['size']; if ($vbc7b3 > $_config['write_log_limit']) { @rename(LOG_FILE,LOG_FILE .'.bak'); @chmod(LOG_FILE .'.bak',NEW_FILES_RIGHTS); @file_put_contents(LOG_FILE,''); } } define('CACHE',true); define('CACHE_NOTES',CACHE and true); define('CACHE_NOTES_COMMENTS',CACHE and true); define('CACHE_POPULAR',CACHE and true); define('CACHE_HOT',CACHE and true); define('CACHE_FAVS',CACHE and true); define('CACHE_TAGS',CACHE and true); define('CACHE_FAVTAGS',CACHE and true); define('CACHE_NOTES_COUNTS',CACHE and true); define('CACHE_EDGE_TIMEINFO',CACHE and true); define('CACHE_FRONTPAGE',CACHE and true); define('CACHE_FRONTPAGE_FEED',CACHE and true); define('CACHE_FULLLIST',CACHE and true); define('CACHE_DRAFTS',CACHE and true); define('CACHE_DRAFTS_ALIAS_USE_COUNTS',CACHE and true); define('CACHE_LASTMODIFIEDS',CACHE and true); define('CACHE_FILENAMES_NOTES',CACHES_FOLDER.'note-*.ctree.psa'); define('CACHE_FILENAMES_NOTES_COMMENTS', CACHES_FOLDER.'note-*-comments.ctree.psa' ); define('CACHE_FILENAMES_NOTES_COUNTS',CACHES_FOLDER.'notes-count-*.txt'); define('CACHE_FILENAMES_EDGE_TIMEINFO',CACHES_FOLDER.'*.e2time.psa'); define('CACHE_FILENAME_POPULAR',CACHES_FOLDER.'popular.ctree.psa'); define('CACHE_FILENAME_POPULAR_EXPIRES',CACHES_FOLDER.'popular-expires.txt'); define('CACHE_FILENAME_HOT',CACHES_FOLDER.'hot.ctree.psa'); define('CACHE_FILENAME_HOT_EXPIRES',CACHES_FOLDER.'hot-expires.txt'); define('CACHE_FILENAME_FAVS',CACHES_FOLDER.'favourites.ctree.psa'); define('CACHE_FILENAME_TAGS',CACHES_FOLDER.'tags.ctree.psa'); define('CACHE_FILENAME_TAGS_AUTHOR',CACHES_FOLDER.'tags-author.ctree.psa'); define('CACHE_FILENAME_FAVTAGS',CACHES_FOLDER.'favtags.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE',CACHES_FOLDER.'frontpage.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_AUTHOR',CACHES_FOLDER.'frontpage-author.ctree.psa'); define('CACHE_FILENAME_FRONTPAGE_FEED',CACHES_FOLDER.'frontpage-feed.psa'); define('CACHE_FILENAME_FULLLIST',CACHES_FOLDER.'notes-list.ctree.psa'); define('CACHE_FILENAME_DRAFTS',CACHES_FOLDER.'drafts.psa'); define('CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS',CACHES_FOLDER.'drafts-auc.psa'); define('CACHE_FILENAME_LASTMODIFIEDS',CACHES_FOLDER.'last-modifieds-by-id.psa'); define('E2E_STRANGE_ERROR',10); define('E2E_USER_ERROR',20); define('E2E_PERMISSIONS_ERROR',30); define('E2E_DATABASE_ERROR',40); define('E2E_MESSAGE',100); define('E2E_DIAGNOSTICS_MESSAGE',110); define('DB_PASSWORD_RECOVER_AND_SHOW',false); define('DEFAULT_ITEMS_PER_PAGE',10); define('MAX_ITEMS_PER_PAGE',100); define('DB_OK',0); define('DB_CANNOT_FIND', -1); define('DB_CANNOT_CONNECT', -2); define('DB_DB_QUERY_ERROR', -3); define('FP_NO_ID_OR_NEW', -1); define('FP_INSERT_ERROR', -10); define('FP_UPDATE_ERROR', -11); define('FP_EMPTY_FIELD', -20); define('FP_TITLE_OR_TEXT_EMPTY', -21); define('FP_NOT_COMMENTABLE', -30); define('FP_COMMENT_DOUBLE_POST', -101); define('FP_COMMENT_TOO_LONG', -102); define('FP_COMMENT_SPAM_SUSPECT', -103); define('NOTE_COMMENTABLE_NOW', -1); define('NOTE_COMMENTABLE_NOW_CONDITIONALLY', -2); define('ENTITY_TYPE_UNSPECIFIED',''); define('ENTITY_TYPE_NOTE','n'); define('ENTITY_TYPE_TAG','t'); define('THUMB_WIDTH',200); define('THUMB_HEIGHT',160); define('THUMB_JPG_QUALITY',90); define('SCALED_IMAGE_JPG_QUALITY',80); define('USERPIC_WIDTH',80); define('USERPIC_HEIGHT',80); define('USERPIC_JPG_QUALITY',90); define('RESOURCES_ALL',0); define('RESOURCES_LOCAL',1); $b5269f=@$_SERVER['HTTP_USER_AGENT'] or $b5269f=''; $_ios=strstr($b5269f,'iPhone') || strstr($b5269f,'iPad'); $_macintosh=strstr($b5269f,'Macintosh'); error_reporting(E_ALL); $_db_error=false; $_fp_error=false; $t589b3=true; if(strstr(__FILE__,'all.php'))$t589b3=false; function __log($e1cb25,$bc9e9a=0){ global$stopwatch,$_log_depth; if ($e1cb25===null){ if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,''); @chmod(LOG_FILE,NEW_FILES_RIGHTS); } return; } $z605ac=''; $vaf240=str_pad(round(s7f78()-$stopwatch,5),10,' ',STR_PAD_RIGHT); if ($e1cb25[0]=='}'){ -- $_log_depth; if($_log_depth < 0)$_log_depth=0; } $q8e13f=( RUN_ID .' '. $z605ac .''. $vaf240 .' '. str_repeat(' ',$_log_depth*2). $e1cb25."\n" ); if ($e1cb25[strlen($e1cb25)-1]=='{'){ ++ $_log_depth; } $u15d61=FILE_APPEND; if(function_exists('file_put_contents')) { @file_put_contents(LOG_FILE,$q8e13f,$u15d61); @chmod(LOG_FILE,NEW_FILES_RIGHTS); if ($e1cb25[0]=='#'){ @file_put_contents(LOG_SPECIAL_FILE,$q8e13f,$u15d61); @chmod(LOG_SPECIAL_FILE,NEW_FILES_RIGHTS); } } } function e2_go_to($y56790=''){ global$_protocol,$errors,$s57de2,$ya57c1; @session_start(); $_SESSION['errors']=$errors; if(substr($y56790,0,strlen($_protocol)+3)!=$_protocol .'://'){ header('Location: '. $_protocol .'://'. $s57de2.$ya57c1 .'/'. $y56790); } else { header('Location: '. $y56790); } flush(); return true; } function f4930(){ $o469bb=$_SERVER['HTTP_REFERER']; return e2_go_to($o469bb); } function o4924($y56790){ if($_SERVER['HTTP_REFERER'])$y56790=$_SERVER['HTTP_REFERER']; return e2_go_to($y56790); } function l8c3b($yb2145=''){ $v9dd4e=substr_count($_SERVER['HTTP_HOST'],'.'); $v2cb9d=@str_repeat('_',$v9dd4e).$yb2145; return $v2cb9d; } function gc64a($yb2145,$b2063c='',$ob0b70=true){ $acd91e=$ob0b70? (time()+3600*24*365) : (0); $sad5f8=$_SERVER['HTTP_HOST']; $se9c6c=substr_count($sad5f8,'.'); if ($se9c6c < 3)$sad5f8=str_repeat('.',3-$se9c6c).$sad5f8; $v9dd4e=setcookie(l8c3b($yb2145),$b2063c,$acd91e,'/'); } function i163d($z183d6,$zb45cf,$acadc8=''){ if(trim($zb45cf)!=''){ $zb45cf=explode($z183d6,$zb45cf); foreach ($zb45cf as $q865c0 => $w8ce4b)$zb45cf[$q865c0]=trim($w8ce4b); foreach ($zb45cf as $q865c0 => $w8ce4b) if ($w8ce4b=='') unset ($zb45cf[$q865c0]); $z7b774=array_unique($zb45cf); if ('sort'==$acadc8)sort($z7b774); return $z7b774; } else return array (); } function ce1e7($vcdaee,$action,$n4a202){ if (!is_array($vcdaee))$vcdaee=array(); if($action=='add'){ $vcdaee=array_unique(array_merge($vcdaee,$n4a202)); } if($action=='remove'){ unset ($vcdaee[array_search($n4a202,$vcdaee)]); } if (!is_array($vcdaee))$vcdaee=array(); return $vcdaee; } function wbb8d($zb45cf){ global$_macintosh,$_ios; if($_ios) return ''; if ($zb45cf=='submit'){ if($_macintosh){ return '&#x2303; &#x21a9;'; } else { return 'Ctrl + Enter'; } } if ($zb45cf=='livesave'){ if($_macintosh){ return '&#x2318; S'; } else { return 'Ctrl + S'; } } if ($zb45cf=='navigation'){ if($_macintosh){ return '&#x2325;'; } else { return 'Ctrl'; } } if ($zb45cf=='navigation-later'){ if($_macintosh){ return '&#x2325; &uarr;'; } else { return 'Ctrl + &uarr;'; } } if ($zb45cf=='navigation-earlier'){ if($_macintosh){ return '&#x2325; &darr;'; } else { return 'Ctrl + &darr;'; } } } function y7b91($e1cb25){ $e1cb25=str_replace('<','&lt;',$e1cb25); $e1cb25=str_replace('>','&gt;',$e1cb25); return $e1cb25; } function dc4b6($e1cb25){ $e1cb25=str_replace('"','&quot;',$e1cb25); return $e1cb25; } function qd056($b2063c,$v5d6db){ return str_replace('.',',',round($b2063c,$v5d6db)); } function e2_stripslashes_array($lf1f71){ return is_array($lf1f71)?array_map('e2_stripslashes_array',$lf1f71):stripslashes($lf1f71); } function c269a(){ if(get_magic_quotes_runtime()) { set_magic_quotes_runtime(0); } if(get_magic_quotes_gpc()) { $_GET=e2_stripslashes_array($_GET); $_POST=e2_stripslashes_array($_POST); $_COOKIE=e2_stripslashes_array($_COOKIE); $_REQUEST=e2_stripslashes_array($_REQUEST); } } function f0786($a957b5){ return sprintf('%u',ip2long($a957b5)); } function r7c85($cb1bc2){ return long2ip(sprintf('%d',$cb1bc2)); } function e2_decline_for_number($e1cb25,$cb1bc2=null){ $j2f713=$e1cb25; if ($cb1bc2===null){ $cb1bc2=substr($e1cb25,0,strpos($e1cb25,' ')); $j2f713=substr($e1cb25,strpos($e1cb25,' ')+1); } $pf07c9=strpos($j2f713,'('); $r46901=strpos($j2f713,')'); if ($r46901 > $pf07c9)$g22b9f=substr($j2f713,$pf07c9,$r46901-$pf07c9+1); $u93da6=explode(',',trim(@$g22b9f,'()')); if(count($u93da6)==2)array_unshift($u93da6,''); $yc78bd=array (2,0,1,1,1,2,2,2,2,2); if ($cb1bc2%100 > 10 and $cb1bc2%100 < 20)$ucd14c=2; else $ucd14c=$yc78bd[$cb1bc2%10]; $kef3e3=$u93da6[$ucd14c]; $e1cb25=str_replace($g22b9f,$kef3e3,$e1cb25); if(strstr($e1cb25,'(') and strstr($e1cb25,')')) { return e2_decline_for_number($e1cb25,$cb1bc2); } else { return $e1cb25; } } function bc5a6($ff2ce1){ $a87e9e=glob($ff2ce1,GLOB_NOSORT); if(is_array($a87e9e)) { foreach ($a87e9e as $i435ed){ @unlink($i435ed); } } } function f74dc($q73600){ $a87e9e=glob($q73600 .'*',GLOB_NOSORT); if(is_array($a87e9e)) { foreach ($a87e9e as $i435ed){ if(basename($i435ed)!='.' and basename($i435ed)!='..'){ if(is_dir($i435ed)) { if (f74dc($i435ed .'/')) { if (!rmdir($i435ed)) { return false; } } else { return false; } } else { @unlink($i435ed); } } } return true; } else { return false; } } function iaf42($id6fe1){ $id6fe1=trim($id6fe1,'/'); $id6fe1=explode('/',$id6fe1); $q73600=''; foreach ($id6fe1 as $f83878){ $q73600=$q73600.$f83878; if (!is_dir($q73600)) { if (@mkdir($q73600)) { @chmod($q73600,NEW_FILES_RIGHTS); } else { return false; } } $q73600=$q73600.'/'; } return true; } function d4d36($id6fe1){ return preg_replace('/\/([^\/]+?)\/\.\./','',$id6fe1); } function jce9b($zb45cf){ $ucee6f=get_html_translation_table(HTML_ENTITIES); $ucee6f=array_flip($ucee6f); return strtr($zb45cf,$ucee6f); } function s7f78($k32c11=NULL){ if(NULL==$k32c11)$k32c11=microtime(); list ($q6021b,$c74459)=explode(' ',$k32c11); return ((float)$q6021b + (float)$c74459); } $stopwatch=s7f78($stopwatch); function n3aa5($v9dd4e){ global$_e2utf8__unformat_htmlentity_neasden; if($_e2utf8__unformat_htmlentity_neasden){ return $v9dd4e; } else { return '((html '. $v9dd4e .'))'; } } function fedd9($re98a6,$q98df3=false){ $l80a41=''; $yf5a8e=strlen($re98a6); for ($q865c0=0; $q865c0 < 256; ++ $q865c0){ $df3d13[$q865c0]=0; $y0fc3c=$q865c0; while ($y0fc3c & 0x00000080){ $y0fc3c <<= 1; ++ $df3d13[$q865c0]; } } for ($q865c0=0xd090; $q865c0 <= 0xd0bf; $q865c0++)$q84a26[$q865c0]=chr(($q865c0 & 0x000000ff)+48); for ($q865c0=0xd180; $q865c0 <= 0xd18f; $q865c0++)$q84a26[$q865c0]=chr(($q865c0 & 0x000000ff)+112); $q84a26[0xd081]="\xa8"; $q84a26[0xd191]="\xb8"; $q84a26[0xc299]="\x99"; $q84a26[0xc2a9]="\xa9"; $q84a26[0xc2ae]="\xae"; $q84a26[0xc2ab]="\xab"; $q84a26[0xc2bb]="\xbb"; $q84a26[0xc2a0]="\xa0"; $q865c0=0; while ($q865c0 < $yf5a8e){ $lac558=$re98a6{$q865c0}; $vc267c=ord($lac558); if ($df3d13[$vc267c]==0){ $l80a41.=$lac558; ++ $q865c0; } elseif ($df3d13[$vc267c]==2){ $b06214=$q84a26[($vc267c << 8) | ord($re98a6{$q865c0+1})]; $l80a41 .= ($b06214!=null)? $b06214 : ( $q98df3? (n3aa5( lebe5(substr($re98a6,$q865c0,2)) )) : '?' ); $q865c0+=2; } else { $hdfbc9=substr($re98a6,$q865c0,$df3d13[$vc267c]); if ($hdfbc9=="\xe2\x84\x96")$l80a41.="\xb9"; elseif ($hdfbc9=="\xe2\x80\x93")$l80a41.="\x96"; elseif ($hdfbc9=="\xe2\x80\x94")$l80a41.="\x97"; elseif ($hdfbc9=="\xe2\x80\x98")$l80a41.="\x91"; elseif ($hdfbc9=="\xe2\x80\x99")$l80a41.="\x92"; elseif ($hdfbc9=="\xe2\x80\x9a")$l80a41.="\x82"; elseif ($hdfbc9=="\xe2\x80\x9c")$l80a41.="\x93"; elseif ($hdfbc9=="\xe2\x80\x9d")$l80a41.="\x94"; elseif ($hdfbc9=="\xe2\x80\x9e")$l80a41.="\x84"; elseif ($hdfbc9=="\xe2\x80\xa6")$l80a41.="\x85"; elseif ($hdfbc9=="\xe2\x80\xb9")$l80a41.="\x8b"; elseif ($hdfbc9=="\xe2\x80\xba")$l80a41.="\x9b"; elseif ($hdfbc9=="\xe2\x82\xac")$l80a41.="\x88"; elseif ($hdfbc9=="\xe2\x84\xa2")$l80a41.="\x99"; else $l80a41.=$q98df3? (n3aa5( lebe5($hdfbc9) )) : '?'; $q865c0+=$df3d13[$vc267c]; } } return $l80a41; } function lebe5($u4a8a0){ $dcc411=''; $yf5a8e=strlen($u4a8a0); for ($q865c0=0; $q865c0 < $yf5a8e; ++ $q865c0){ $dcc411.=preg_replace('/^1*0/','',decbin(ord($u4a8a0{$q865c0}))); } return '&#'. bindec($dcc411) .';'; } function pfd97($t341be) { $v2cb9d=$t341be; $v2cb9d=preg_replace_callback('/([\x80-\xFF])/','e2_utf_from_windows_1251_char',$v2cb9d); return $v2cb9d; } function e2_utf_from_windows_1251_char($u4a8a0){ list (, $u4a8a0)=$u4a8a0; if ($u4a8a0=="\xa8") return "\xd0\x81"; if ($u4a8a0=="\xb8") return "\xd1\x91"; if ($u4a8a0 >= "\xc0" && $u4a8a0 <= "\xef") return "\xd0".chr(ord($u4a8a0)-48); if ($u4a8a0 >= "\xf0") return "\xd1".chr(ord($u4a8a0)-112); if ($u4a8a0=="\x85") return "\xe2\x80\xa6"; if ($u4a8a0=="\x96") return "\xe2\x80\x93"; if ($u4a8a0=="\x97") return "\xe2\x80\x94"; if ($u4a8a0=="\xab") return "\xc2\xab"; if ($u4a8a0=="\xbb") return "\xc2\xbb"; if ($u4a8a0=="\x91") return "\xe2\x80\x98"; if ($u4a8a0=="\x92") return "\xe2\x80\x99"; if ($u4a8a0=="\x93") return "\xe2\x80\x9c"; if ($u4a8a0=="\x94") return "\xe2\x80\x9d"; if ($u4a8a0=="\x84") return "\xe2\x80\x9e"; if ($u4a8a0=="\x99") return "\xe2\x84\xa2"; if ($u4a8a0=="\xb9") return "\xe2\x84\x96"; if ($u4a8a0=="\xa0") return "\xc2\xa0"; return '?'; }; function e2_utf8_version_of_array_($lf1f71){ foreach ($lf1f71 as $w8ce4b => $o9e366){ if (!array_key_exists($w8ce4b.'.u?',$lf1f71)) { if(is_string($lf1f71[$w8ce4b])) { $lf1f71[$w8ce4b]=pfd97($lf1f71[$w8ce4b]); } elseif(is_array($lf1f71[$w8ce4b])) { $lf1f71[$w8ce4b]=e2_utf8_version_of_array_($lf1f71[$w8ce4b]); } } } return $lf1f71; } function rff7c($t341be){ return preg_replace('/[\x{10000}-\x{fffff}]/u','?',$t341be); } $_folders_written=array ( '.', USER_FOLDER, CACHES_FOLDER, BACKUP_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER, MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER, MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/', MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/', MEDIA_ROOT_FOLDER.AUDIO_FOLDER, ); $_files_written=array ( USER_FOLDER.'password-hash.psa', USER_FOLDER.'password-wait.psa', USER_FOLDER.'last-comment.psa', USER_FOLDER.'new-uploads.psa', USER_FOLDER.'settings.json', USER_FOLDER.'indexing.psa', USER_FOLDER.'auth.psa', USER_FOLDER.'log.txt', ); define('CROP_NONE',0); define('CROP_SQUARE',1); define('PROVIDE_DATA_SPAWN',10); define('PROVIDE_DATA_NOW',20); function xea70(){ global$_folders_written,$_files_written; clearstatcache(); $h10ae9=array(); foreach($_folders_written as $g8fa14){ if(is_dir($g8fa14) and !is_writable($g8fa14)) { $h10ae9[] = $g8fa14; } } foreach($_files_written as $g8fa14){ if(is_file($g8fa14) and !is_writable($g8fa14)) { $h10ae9[] = $g8fa14; } } return $h10ae9; } function k6e52($k8c7dd,$zb45cf){ if (!@file_put_contents($k8c7dd,$zb45cf,LOCK_EX)) { return false; } @chmod($k8c7dd,NEW_FILES_RIGHTS); return true; } function j25cb($i435ed,$d3dbb8){ if ($d3dbb8){ $a80127=explode('/',$i435ed); $r954eb=array_pop($a80127); $u35b88=explode('.',$r954eb); if(count($u35b88) < 2)$u35b88[] = ''; $wabf77=array_pop($u35b88); $u35b88[] = $d3dbb8; if ($wabf77)$u35b88[] = $wabf77; $r954eb=implode('.',$u35b88); $a80127[] = $r954eb; $i435ed=implode('/',$a80127); } return $i435ed; } function p291d($i435ed,$f6890f=false){ $vd1789=array ( 'w' => THUMB_WIDTH, 'h' => THUMB_HEIGHT, 'q' => THUMB_JPG_QUALITY ); if(preg_match('/^https?\:\/\//iu',$i435ed)) { $faf721=$i435ed; $m6efa1=$i435ed; $m6efa1=preg_replace('/^https?\:\/\//iu','',$m6efa1); $m6efa1=str_replace('/','--',$m6efa1); $m6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$m6efa1; } else { $faf721=MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$i435ed; $m6efa1=MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$i435ed; } $m6efa1=j25cb($m6efa1,'thumb@2x'); $se70c4=s8611( $faf721, $m6efa1, $vd1789, CROP_NONE, $f6890f ); $yf5a8e=strlen(MEDIA_ROOT_FOLDER); if(substr($se70c4,0,$yf5a8e)==MEDIA_ROOT_FOLDER){ $se70c4=substr($se70c4,$yf5a8e); } return $se70c4; } function c30f2($faf721){ $m8743c=pathinfo($faf721); $wabf77=$m8743c['extension']; return (in_array(strtolower($wabf77), array ('jpg','jpeg','gif','png','svg'))); } function nb6c5($faf721){ $m8743c=pathinfo($faf721); $wabf77=$m8743c['extension']; return (in_array(strtolower($wabf77), array ('jpg','jpeg','gif','png'))); } function mef67($faf721){ $m8743c=pathinfo($faf721); $wabf77=$m8743c['extension']; if ($wabf77=='png') return IMAGETYPE_PNG; if ($wabf77=='gif') return IMAGETYPE_GIF; if ($wabf77=='jpg' or $wabf77=='jpeg') return IMAGETYPE_JPEG; } function t19a4($i435ed){ if (nb6c5($i435ed)) { list ($weaae2,$vb435e)=getimagesize($i435ed); } else { $we2da9=simplexml_load_string(file_get_contents($i435ed)); if ($we2da9){ $zd0a5e=$we2da9->attributes(); list ($weaae2,$vb435e) = array ((string)$zd0a5e -> width, (string)$zd0a5e -> height); } else { return false; } } if(substr($i435ed,strrpos($i435ed,'.')-3,3)=='@2x'){ $weaae2=(int)floor($weaae2/2); $vb435e=(int)floor($vb435e/2); } return array ($weaae2,$vb435e); } function e2s_retrieve($parameters){ $x36cd3=urldecode(base64_decode($parameters['source'])); if(__LOG)__log('Retrieve: '. $x36cd3); o1066($x36cd3,PROVIDE_DATA_NOW); } function ybcd0($q447b7){ global$full_blog_url; $y78f08=parse_url($q447b7); if (isset ($y78f08['scheme'])) { if (c30f2($y78f08['path'])) { return array ( 'type' => 'remote-image', 'is-local?' => false, ); } elseif ($y78f08['host']=='www.youtube.com'){ $fb80bb=basename($y78f08['path']); $j15ba8='remote/youtube-'. $fb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'youtube', 'video-id' => $fb80bb, 'local-cover-name' => $j15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$j15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$j15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$j15ba8.'.failed', ); } elseif ($y78f08['host']=='player.vimeo.com'){ $fb80bb=basename($y78f08['path']); $j15ba8='remote/vimeo-'. $fb80bb .'-cover.jpg'; return array ( 'type' => 'online-video', 'is-local?' => false, 'video-service' => 'vimeo', 'video-id' => $fb80bb, 'local-cover-name' => $j15ba8, 'local-cover-href' => $full_blog_url .'/'. PICTURES_FOLDER.$j15ba8, 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$j15ba8, 'local-full-failname' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$j15ba8.'.failed', ); } } else { if (c30f2($y78f08['path'])) { return array ( 'type' => 'local-image', 'is-local?' => true, 'local-href' => $full_blog_url .'/'. PICTURES_FOLDER.$y78f08['path'], 'local-full-filename' => MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$y78f08['path'] ); } else { return array ( 'type' => 'local-non-image', 'is-local?' => true, ); } } } function o1066($q447b7,$adb88a){ $x1c149=ybcd0($q447b7); if ($x1c149['type']=='remote-image'){ } elseif ($x1c149['type']=='online-video'){ if(is_file($x1c149['local-full-filename'])) { if(__LOG)__log('Already exists: '. $x1c149['local-full-filename']); } elseif(is_file($x1c149['local-full-failname'])) { if(__LOG)__log('Already tried and failed: '. $x1c149['local-full-filename']); } else { if(__LOG)__log($q447b7.' is missing a cover, retrieving'); if ($adb88a==PROVIDE_DATA_SPAWN){ tcc38(r83c8('e2s_retrieve', array ( 'source' => urlencode(base64_encode($q447b7)), ))); } if ($adb88a==PROVIDE_DATA_NOW){ if ($x1c149['video-service']=='youtube') { $t5f89d=array ( 'maxresdefault','hqdefault','mqdefault','sddefault','default' ); foreach ($t5f89d as $hd7d16){ $x572d4='http://img.youtube.com/vi/'. $x1c149['video-id'] .'/'. $hd7d16 .'.jpg'; if(__LOG)__log('Getting '.$x572d4 .' as '. $x1c149['local-full-filename']); $p6c43d=file_get_contents($x572d4); if ($p6c43d!==false) break; } } if ($x1c149['video-service']=='vimeo') { $lc4a72=unserialize( file_get_contents('http://vimeo.com/api/v2/video/'. $x1c149['video-id'] .'.php') ); if (isset ($lc4a72[0]['thumbnail_large'])) { $p6c43d=file_get_contents($lc4a72[0]['thumbnail_large']); } } if ($p6c43d!==false){ k6e52($x1c149['local-full-filename'],$p6c43d); } else { k6e52($x1c149['local-full-failname'],''); } } } if ($adb88a==PROVIDE_DATA_NOW){ if(is_file($x1c149['local-full-filename'])) { p291d($x1c149['local-cover-name']); } } } elseif ($x1c149['type']=='local-image'){ if(__LOG)__log($q447b7.' is a local image'); p291d($q447b7); } elseif ($x1c149['type']=='local-non-image'){ if(__LOG)__log($q447b7.' is a local non-image'); } } function l6be4($h10ae9){ if (!is_array($h10ae9)) return; if(__LOG)__log('Provide data for resources {'); foreach ($h10ae9 as $q447b7){ o1066($q447b7,PROVIDE_DATA_SPAWN); } if(__LOG)__log('}'); } function uf898($a89111,$hdffc4,$ie449c){ $d5128f=wfb75($a89111,$hdffc4); $w55b55=array_merge($d5128f,$ie449c); $w55b55=array_reverse($w55b55); $w55b55=array_unique($w55b55); $w55b55=array_reverse($w55b55); return d2e82($w55b55,RESOURCES_LOCAL); } function qfc4d($cd430b,$s2bfe4){ $a84841=array(); if(is_array($s2bfe4['meta']['resources-detected'])) { $ie449c=$s2bfe4['meta']['resources-detected']; $a84841=wdc5a($ie449c); } $b16137=@unserialize( $cd430b['Uploads'] ) or $b16137=array(); $f08204=array_diff($a84841,$b16137); p4ae9('note',$cd430b['ID'],'add',$f08204); return $f08204; } function wdc5a($id7f81){ $h10ae9=array(); foreach ($id7f81 as $v1993e){ $x1c149=ybcd0($v1993e); if ($x1c149['is-local?'])$h10ae9[] = $v1993e; } return $h10ae9; } function d2e82($w55b55,$q8b7af=RESOURCES_ALL){ global$full_blog_url; $sef067=array(); $v59b51=array(); if (!is_array($w55b55)) return $v59b51; l6be4($w55b55); foreach ($w55b55 as $b96ab4){ $x1c149=ybcd0($b96ab4); if ($q8b7af==RESOURCES_LOCAL and !$x1c149['is-local?']) continue; if ($x1c149['type']=='remote-image'){ } elseif ($x1c149['type']=='online-video'){ if ($d742c4=p291d($x1c149['local-cover-name'])) { $size=t19a4(MEDIA_ROOT_FOLDER.$d742c4); list ($weaae2,$vb435e)=$size; if (!in_array($b96ab4,$sef067)) { $sef067[] = $b96ab4; $v59b51[] = array ( 'original-filename' => $b96ab4, 'href' => $full_blog_url .'/'. $d742c4, 'width' => $weaae2, 'height' => $vb435e, ); } } } elseif ($x1c149['type']=='local-image'){ if ($d742c4=p291d($b96ab4)) { $size=t19a4(MEDIA_ROOT_FOLDER.$d742c4); list ($weaae2,$vb435e)=$size; if (!$weaae2)$weaae2=THUMB_WIDTH/2; if (!$vb435e)$vb435e=THUMB_HEIGHT/2; if (!in_array($b96ab4,$sef067)) { $sef067[] = $b96ab4; $v59b51[] = array ( 'original-filename' => $b96ab4, 'href' => $full_blog_url .'/'. $d742c4, 'width' => $weaae2, 'height' => $vb435e, ); } } } elseif ($x1c149['type']=='local-non-image'){ if(is_file(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$b96ab4)) { if (!in_array($b96ab4,$sef067)) { $sef067[] = $b96ab4; $v59b51[] = array ( 'original-filename' => $b96ab4, 'href' => $full_blog_url .'/'. AUDIO_ICON_IMAGE, 'width' => AUDIO_ICON_WIDTH, 'height' => AUDIO_ICON_HEIGHT, ); } } } } return $v59b51; } function edbcc($a89111,$hdffc4,$w55b55){ global$full_blog_url; $h10ae9=array(); if(is_array($w55b55)) { $h10ae9=e2files__list_og_images_for_resources_($w55b55); } $d5128f=wfb75($a89111,$hdffc4); if(is_array($d5128f)) { foreach ($d5128f as $w8ce4b => $o9e366){ if(is_file(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$o9e366)) { $d5128f[$w8ce4b]=$full_blog_url .'/'. PICTURES_FOLDER.$o9e366; } else { unset ($d5128f[$w8ce4b]); } } $h10ae9=array_merge($d5128f,$h10ae9); } $h10ae9=array_reverse($h10ae9); $h10ae9=array_unique($h10ae9); $h10ae9=array_reverse($h10ae9); return $h10ae9; } function e2files__list_og_images_for_resources_($w55b55){ $v59b51=array(); l6be4($w55b55); foreach ($w55b55 as $b96ab4){ $x1c149=ybcd0($b96ab4); if ($x1c149['type']=='remote-image'){ } elseif ($x1c149['type']=='online-video'){ if(is_file($x1c149['local-full-filename'])) { $v59b51[] = $x1c149['local-cover-href']; } } elseif ($x1c149['type']=='local-image'){ if(is_file($x1c149['local-full-filename'])) { $v59b51[] = $x1c149['local-href']; } } elseif ($x1c149['type']=='local-non-image'){ } } return $v59b51; } function s8611($faf721,$m6efa1,$d93a57,$zcff96,$f6890f){ global$_config; if(__LOG)__log('Scale image: <'. $faf721 .'>'); if ($f6890f){ if(__LOG)__log('Scale image: recreate requested'); } $w7ae08=pathinfo($m6efa1); if(__LOG)__log('Scale image: source_name <'. $faf721 .'>'); if(__LOG)__log('Scale image: dest_name <'. $m6efa1 .'>'); if(is_file($faf721)) { if (nb6c5($faf721)) { if ($d93a57['h'] == -1)$d93a57['h']=999999; if (!is_file($m6efa1) or $f6890f){ if (@iaf42($w7ae08['dirname'])) { v6b7f( $faf721, $d93a57['w'],$d93a57['h'],$d93a57['q'], $m6efa1, $zcff96 ); if(is_file($m6efa1)) { if(__LOG)__log('Scale image: done'); chmod($m6efa1,$_config['uploaded_files_mode']); } else { if(__LOG)__log('Scale image: error'); return false; } } else { if(__LOG)__log('Scale image: couldn’t create directory <'. $w7ae08['dirname'] .'>'); } } else { if(__LOG)__log('Scale image: already exists'); } return $m6efa1; } else { if(__LOG)__log('Scale image: SVG, no need to make thumbnail'); return $faf721; } } return false; } function n9c0a($lb0689,$v12e09){ if(preg_match('//u',$lb0689))$lb0689=fedd9($lb0689,false); if ($v12e09=='image'){ $a85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; } elseif ($v12e09=='audio'){ $a85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } else { return false; } $a96704=''; for ($q865c0=0; $q865c0 < strlen($lb0689); $q865c0++) { if ($lb0689[$q865c0]=='?'){ $a96704.=''; } elseif ($lb0689[$q865c0]==' '){ $a96704.='-'; } elseif(ord($lb0689[$q865c0]) <= 127){ $a96704.=$lb0689[$q865c0]; } } if ($a96704=='')$a96704=$v12e09; if ($a96704[0]=='.')$a96704=$v12e09.$a96704; return $a96704; } function ff0fb($y76ee3){ global$_config; if(__LOG)__log('Count refereces for upload <'. $y76ee3 .'>'); $j7cd94=$rbe270=$o6ae44=array(); if(is_file(USER_FOLDER.'new-uploads.psa')) { $j7cd94=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); if (!is_array($j7cd94))$j7cd94=array(); } $c5a976='%'. str_replace('%','#%',$y76ee3) .'%'; if (j0738( "SELECT `ID`, `Text`, `FormatterID`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `Text` LIKE '". $c5a976 ."' ESCAPE '#' ". "OR `Uploads` LIKE '". $c5a976 ."' ESCAPE '#'" )) { $result=b0d6b(); $rbe270=@unserialize($result[0]['Uploads']); if (!is_array($rbe270)) { foreach($result as $h39a37){ $s2bfe4=p154e( $h39a37['FormatterID'], @$h39a37['Text'],'full-rss' ); $rbe270=qfc4d($h39a37,$s2bfe4); } } } if (j0738( "SELECT `ID`, `Description`, `Uploads` ". "FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Description` LIKE '". $c5a976 ."' ESCAPE '#' ". "WHERE `Uploads` LIKE '". $c5a976 ."' ESCAPE '#'" )) { $result=b0d6b(); $o6ae44=@unserialize($result[0]['Uploads']); if (!is_array($o6ae44)) { foreach($result as $lb19ad){ $s2bfe4=ob7f1( @$lb19ad['Description'],'full-rss' ); $o6ae44=qfc4d($lb19ad,$s2bfe4); } } } $d5128f=array_merge($j7cd94,$rbe270,$o6ae44); if(__LOG)__log('References found in relevant entries: '. var_export($d5128f,true)); if(in_array($y76ee3,$d5128f)) { if(__LOG)__log('Still referenced, do not delete file'); return true; } return false; } function wfb75($mf5e63,$fb80bb){ global$_config; if ($mf5e63=='note' and $fb80bb=='new'){ if(is_file(USER_FOLDER.'new-uploads.psa')) { $d5128f=@unserialize(file_get_contents(USER_FOLDER.'new-uploads.psa')); } } elseif ($mf5e63=='note'){ if (j0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID`=". $fb80bb )) { $result=b0d6b(); $d5128f=@unserialize($result[0]['Uploads']); } } elseif ($mf5e63=='tag'){ if (j0738( "SELECT `Uploads` FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`=". $fb80bb )) { $result=b0d6b(); $d5128f=@unserialize($result[0]['Uploads']); } } if (!is_array($d5128f))$d5128f=array(); return $d5128f; } function fbc90($mf5e63,$fb80bb,$d5128f){ global$_config; if ($mf5e63=='note' and $fb80bb=='new'){ if (!@k6e52(USER_FOLDER.'new-uploads.psa',serialize($d5128f))) { f8a40('ERROR',E2E_PERMISSIONS_ERROR); } } elseif ($mf5e63=='note'){ j0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `Uploads`='". serialize($d5128f) ."' ". "WHERE `ID`=". $fb80bb ); } elseif ($mf5e63=='tag'){ j0738( "UPDATE `". $_config['db_table_prefix']."Keywords` ". "SET `Uploads`='". serialize($d5128f) ."' ". "WHERE `ID`=". $fb80bb ); } else { return false; } if (!is_array($d5128f))$d5128f=array(); return $d5128f; } function p4ae9($mf5e63,$fb80bb,$action,$n4a202){ global$_config; $d5128f=array(); if(__LOG)__log('Register upload: <'. $mf5e63.', '. $fb80bb.', '. $action.', '. $n4a202 .'>'); $d5128f=wfb75($mf5e63,$fb80bb); $d5128f=ce1e7($d5128f,$action,$n4a202); fbc90($mf5e63,$fb80bb,$d5128f); } function n2f83($i4b27b,$kde17f,$ie449c){ $b16137=@unserialize($kde17f['Uploads']) or $b16137=array(); $x28a47=wdc5a($ie449c); $d5128f=ce1e7($b16137,'add',$x28a47); $d5128f=serialize($d5128f); if ($d5128f!=$kde17f['Uploads']) { $kde17f['Uploads']=$d5128f; raa79($i4b27b,$kde17f); } } function e2j_file_upload($parameters=array ()) { global$_config,$full_blog_url; @iaf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER); @chmod(MEDIA_ROOT_FOLDER.PICTURES_FOLDER,$_config['uploaded_files_mode']); @iaf42(MEDIA_ROOT_FOLDER.AUDIO_FOLDER); @chmod(MEDIA_ROOT_FOLDER.AUDIO_FOLDER,$_config['uploaded_files_mode']); $ad1fc8=array(); $ad1fc8['success']=0; if(count($_FILES) > 0){ foreach($_FILES as $k8c7dd){ if (!$k8c7dd['error']) { if(__LOG)__log('Ajax file upload: <'. $k8c7dd['name'].'>'); $ad1fc8['file-kind']='image'; $a85114=MEDIA_ROOT_FOLDER.PICTURES_FOLDER; if(substr($k8c7dd['name'],strrpos($k8c7dd['name'],'.')) == '.mp3'){ $ad1fc8['file-kind']='audio'; $a85114=MEDIA_ROOT_FOLDER.AUDIO_FOLDER; } $l77dce=( array_key_exists('overwrite',$_GET) and is_file($a85114.$k8c7dd['name']) ); $v6f4b5=false; $ad1fc8['overwrite'] = (int)$l77dce; if(__LOG)__log('Ajax file upload: Overwrite is resolved to <'. (int)$l77dce.'>'); $a96704=n9c0a($k8c7dd['name'],$ad1fc8['file-kind']); if(__LOG)__log('Ajax file upload: Safe name is <'. $a96704.'>'); if(is_file($a85114.$a96704)) { if(file_get_contents($a85114.$a96704)==file_get_contents($k8c7dd['tmp_name'])) { if(__LOG)__log('Ajax file upload: Existing file is the same'); $v6f4b5=true; } else { if (!$l77dce){ $r5c917=substr($a96704,0,strrpos($a96704,'.')); $wabf77=substr($a96704,strrpos($a96704,'.')); $q865c0=0; while (is_file($a85114.$r5c917 .'_'. (++$q865c0).$wabf77)); $a96704=$r5c917 .'_'. $q865c0.$wabf77; } } } if (!$v6f4b5){ move_uploaded_file($k8c7dd['tmp_name'],$a85114.$a96704); @chmod($m9f57c,$_config['uploaded_files_mode']); } if(__LOG)__log('Ajax file upload: File kind is <'. $ad1fc8['file-kind'].'>'); if ($ad1fc8['file-kind']=='image'){ if($_config['fit_uploaded_images']) { s8611( MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$a96704, MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$a96704, array ( 'w' => $_config['fit_uploaded_images'], 'h' => $_config['fit_uploaded_images'], 'q' => SCALED_IMAGE_JPG_QUALITY, ), CROP_NONE, true ); } if ($d742c4=p291d($a96704,$l77dce)) { if(__LOG)__log('Ajax file upload: thumbnail, done'); list ($weaae2,$vb435e)=t19a4(MEDIA_ROOT_FOLDER.$d742c4); $ad1fc8['success']=1; $ad1fc8['new-name']=$a96704; $ad1fc8['thumb']=$full_blog_url .'/'. $d742c4; $ad1fc8['width']=$weaae2; $ad1fc8['height']=$vb435e; p4ae9($parameters['entity'],$parameters['entity-id'],'add', array ($a96704)); } else { if(__LOG)__log('Ajax file upload: couldn’t create thumbnail'); @unlink($a85114.$a96704); $ad1fc8['error']='could-not-create-thumbnail'; } } if ($ad1fc8['file-kind']=='audio'){ if(__LOG)__log('Ajax file upload: audio, done'); $ad1fc8['success']=1; $ad1fc8['new-name']=$a96704; $ad1fc8['thumb']=AUDIO_ICON_IMAGE; $ad1fc8['width']=AUDIO_ICON_WIDTH; $ad1fc8['height']=AUDIO_ICON_HEIGHT; } } elseif(4!=$k8c7dd['error']) { if ($k8c7dd['error']==1){ $ad1fc8['error']='too-big'; } elseif ($k8c7dd['error']==2){ $ad1fc8['error']='too-big'; } elseif ($k8c7dd['error']==3){ $ad1fc8['error']='partial'; } else { $ad1fc8['error']=$k8c7dd['error']; } } } } else { if(__LOG)__log('Ajax file upload error: no files'); $ad1fc8['error']='no-files'; } $ad1fc8=json_encode($ad1fc8); die ($ad1fc8); } function e2j_userpic_upload(){ global$_config; if(count($_FILES)==1){ $k8c7dd=array_pop($_FILES); if (!$k8c7dd['error']) { if(__LOG)__log('Ajax userpic upload: <'. $k8c7dd['name'].'>'); $ka93b8=pathinfo($k8c7dd['name']); $wabf77=strtolower($ka93b8['extension']); if ($wabf77!='png')$wabf77='jpg'; $i435ed='userpic.original.'. $wabf77; move_uploaded_file($k8c7dd['tmp_name'],USER_FOLDER.$i435ed); @chmod(USER_FOLDER.$i435ed,$_config['uploaded_files_mode']); $vd1789=array ( 'w' => USERPIC_WIDTH, 'h' => USERPIC_HEIGHT, 'q' => USERPIC_JPG_QUALITY ); @unlink(USER_FOLDER.'userpic@2x.png'); @unlink(USER_FOLDER.'userpic@2x.jpg'); $rf1210=s8611( USER_FOLDER.$i435ed, USER_FOLDER .'userpic@2x.jpg', $vd1789, CROP_SQUARE, true ); @unlink(USER_FOLDER.$i435ed); if ($rf1210){ if(__LOG)__log('Ajax userpic upload: userpic, done'); die ('image|'. $rf1210); } else { die ('image|'.DEFAULT_USERPIC_FILENAME); } } elseif(4!=$k8c7dd['error']) { if ($k8c7dd['error']==1){ die ('error|too-big'); } elseif ($k8c7dd['error']==2){ die ('error|too-big'); } elseif ($k8c7dd['error']==3){ die ('error|partial'); } else { die ('error|'. $k8c7dd['error']); } } } else { if(__LOG)__log('Ajax userpic upload error: no or too many files'); die ('error|no-or-too-many-files'); } die ('error|uncatched-error'); } function e2j_file_remove($parameters){ $k8c7dd=$rf1210=''; if(array_key_exists('file',$_POST))$k8c7dd=$_POST['file']; p4ae9($parameters['entity'],$parameters['entity-id'],'remove',$k8c7dd); if (ff0fb($k8c7dd)) { die ('nothing'); } else { if(substr($k8c7dd,strrpos($k8c7dd,'.')) == '.mp3'){ @unlink(MEDIA_ROOT_FOLDER.AUDIO_FOLDER.$k8c7dd); die ('nothing'); } else { $rf1210=j25cb($k8c7dd,'thumb@2x'); $ld911a=j25cb($k8c7dd,'scaled'); if ($k8c7dd){ $yf6347=@unlink(MEDIA_ROOT_FOLDER.PICTURES_FOLDER.$k8c7dd); $e8f458=@unlink(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER.$rf1210); die ('nothing'); } } } die ('error|no-filename-passed'); } function v6b7f($dfce75,$oc69cd,$ld35fb,$qd6663,$x1c925,$zcff96){ if (!extension_loaded('gd')) { if (!dl('gd.so')) { header('Content-type: image/gif'); return false; } } $t7c355=($dfce75!==$x1c925); $scaf9b=@getimagesize($dfce75); if (!$scaf9b or $scaf9b[2] > 3) return; $m599dc=$scaf9b[2]; $o73beb=null; if ($m599dc==IMAGETYPE_GIF and function_exists('imagecreatefromgif')) { $o73beb=imagecreatefromgif($dfce75); } if ($m599dc==IMAGETYPE_JPEG and function_exists('imagecreatefromjpeg')) { $o73beb=imagecreatefromjpeg($dfce75); } if ($m599dc==IMAGETYPE_PNG and function_exists('imagecreatefrompng')) { $o73beb=imagecreatefrompng($dfce75); } if(function_exists('exif_read_data')) { $a9beff=exif_read_data($dfce75); if ($a9beff['Orientation']==3)$jb1ba8=imagerotate($o73beb,180,0); if ($a9beff['Orientation']==6)$jb1ba8=imagerotate($o73beb,270,0); if ($a9beff['Orientation']==8)$jb1ba8=imagerotate($o73beb,90,0); if ($jb1ba8){ imagedestroy($o73beb); $o73beb=$jb1ba8; $t7c355=true; } } if (!$o73beb){ if(__LOG)__log('Could not create image object'); return false; } $weaae2=imagesx($o73beb); $vb435e=imagesy($o73beb); $u0cb47=min($oc69cd/$weaae2,$ld35fb/$vb435e); if ($u0cb47 < 1){ $oc69cd=round($weaae2*$u0cb47); $ld35fb=round($vb435e*$u0cb47); $t7c355=true; } else { $oc69cd=$weaae2; $ld35fb=$vb435e; } $w08c38=$l480e9=$ub710b=$kee920=0; if ($zcff96==CROP_SQUARE){ if ($oc69cd > $ld35fb){ $ub710b=$weaae2-$vb435e; $w08c38=floor($ub710b/2); $ld35fb=$oc69cd; } else { $kee920=$vb435e-$weaae2; $l480e9=floor($ub710b/2); $oc69cd=$ld35fb; } if(__LOG)__log('Files: '.'$crop_l='. $w08c38 .' '.'$crop_t='. $l480e9 .' '.'$crop_hor='. $ub710b .' '.'$crop_ver='. $kee920 .' '); } if ($w08c38+$l480e9+$ub710b+$kee920 > 0){ $t7c355=true; } $h28e3d=imagecreatetruecolor($oc69cd,$ld35fb); if ($m599dc==IMAGETYPE_PNG){ imagefill($h28e3d,0,0,imagecolorallocate($h28e3d,255,255,255)); imagealphablending($h28e3d,true); } if (empty ($x1c925)) { $c19229=stat($dfce75); $c19229=date('r',$c19229['mtime']); header('Last-Modified: '.$c19229); } imagecopyresampled( $h28e3d, $o73beb, 0,0, 0+$w08c38,0+$l480e9, $oc69cd,$ld35fb, $weaae2-$ub710b,$vb435e-$kee920 ); imageinterlace($h28e3d,1); if ($t7c355){ imagejpeg($h28e3d,$x1c925,$qd6663); } return true; } function kd10e(){ global$_config; if (!$_config['files_total_size_limit']) return false; $t70a36=0; foreach(glob(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'/*') as $k8c7dd){ $v9dd4e=stat($k8c7dd); $t70a36+=$v9dd4e['size']; } foreach(glob(MEDIA_ROOT_FOLDER.AUDIO_FOLDER .'/*') as $k8c7dd){ $v9dd4e=stat($k8c7dd); $t70a36+=$v9dd4e['size']; } $sd515a=$_config['files_total_size_limit']; $g354f0=round($t70a36/$sd515a*100); if ($t70a36 > 0 and $g354f0==0)$g354f0=1; if ($t70a36 < $sd515a and $g354f0==100)$g354f0=99; return array ($t70a36,$sd515a,$g354f0); } function z1363($kc999b){ $f85faf=true; if (list ($t70a36,$sd515a,$g354f0)=$kc999b){ $f85faf=($sd515a-$t70a36) > 0; } return $f85faf; } function kaf64($kc999b,$wf9f90=false){ $kf3ecb=''; if (list ($t70a36,$sd515a,$g354f0)=$kc999b){ $kc999b=array ( 'used' => round($t70a36/1024/1024), 'total' => round($sd515a/1024/1024), 'percent' => $g354f0 ); if ($wf9f90 or ($sd515a-$t70a36) < 1024*1024*10){ if ($t70a36 < $sd515a){ $kf3ecb=e2l_get_string('gs--used',$kc999b); } else { $kf3ecb=e2l_get_string('gs--used-all',$kc999b); } } } return $kf3ecb; } function p74e0(){ global$settings; if (!isset ($settings))$settings=array(); $pfa816=array(); if(is_file(USER_FOLDER.'settings.json')) { $pfa816=json_decode(file_get_contents(USER_FOLDER.'settings.json'),true); $a098f6=13; } elseif(is_file(USER_FOLDER.'settings.psa')) { $pfa816=unserialize(file_get_contents(USER_FOLDER.'settings.psa')); } if (!is_array($pfa816))$pfa816=array(); $settings=array_merge($settings,$pfa816); if ( !is_numeric(@$settings['appearance']['notes_per_page']) or @$settings['appearance']['notes_per_page'] < 1 ){ $settings['appearance']['notes_per_page']=DEFAULT_ITEMS_PER_PAGE; } if ( @$settings['appearance']['notes_per_page'] > MAX_ITEMS_PER_PAGE ){ $settings['appearance']['notes_per_page']=MAX_ITEMS_PER_PAGE; } if ( !array_key_exists('comments',$settings) or !array_key_exists('default_on', @$settings['comments']) ) { $settings['comments']['default_on']=false; } return true; } function e2m_settings(){ global$settings,$_template,$_strings; $xf3e33=array(); $v5e107=@$settings['language']? $settings['language']:DEFAULT_LANGUAGE; foreach(glob(LANGUAGES_FOLDER. '*.php') as $i435ed){ $a5b54c=substr(basename($i435ed),0,2); $l98bf7=file_get_contents($i435ed); if(preg_match( '/^ *\/\/ *display_name *\= *(.*?) *$/ismu',$l98bf7,$v9c28d )) { $fc2657=$v9c28d[1]; } else { $fc2657=$a5b54c; } $xf3e33[$a5b54c] = array ( 'selected?' => (bool) ($v5e107==$a5b54c), 'display-name' => $fc2657, ); } $v2cb9d['title']=$_strings['pt--settings']; $v2cb9d['heading']=$_strings['pt--settings']; $v2cb9d['form']='form-preferences'; $v2cb9d['form-preferences'] = array ( 'blog-title-default' => htmlspecialchars($_strings['e2--default-blog-title'],ENT_COMPAT,HSC_ENC), 'blog-title' => htmlspecialchars(b6f51(),ENT_COMPAT,HSC_ENC), 'blog-description' => htmlspecialchars(@$settings['description'],ENT_COMPAT,HSC_ENC), 'blog-author-default' => htmlspecialchars($_strings['e2--default-blog-author'],ENT_COMPAT,HSC_ENC), 'blog-author' => htmlspecialchars(@$settings['author'],ENT_COMPAT,HSC_ENC), 'languages' => $xf3e33, 'language' => $v5e107, 'form-action' => r83c8('e2s_settings_save'), 'notes-per-page' => $settings['appearance']['notes_per_page'], 'email-notify?' => (bool) @$settings['notifications']['new_comments'], 'email' => htmlspecialchars(@$settings['user']['email'],ENT_NOQUOTES,HSC_ENC), 'comments-default-on?' => (bool) @$settings['comments']['default_on'], 'comments-fresh-only?' => (bool) @$settings['comments']['fresh_only'], 'show-sharing-buttons?' => (bool)$settings['appearance']['show_sharing_buttons'], 'includes-google-analytics?' => false, 'includes-yandex-metrika?' => false, 'template-name' => $_template['name'], 'templates' => j94dd(), 'submit-text' => $_strings['fb--save-changes'], 'space-usage' => kaf64(kd10e(),true), ); return $v2cb9d; } function e2s_settings_save(){ global$settings,$_strings; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(r83c8('e2m_settings')); $w05df2=$g67daf=''; if(array_key_exists('blog-title',$_POST)) { $w05df2=trim($_POST['blog-title']); } if(array_key_exists('blog-description',$_POST)) { $g67daf=trim($_POST['blog-description']); } if(array_key_exists('blog-author',$_POST)) { $z02bd9=trim($_POST['blog-author']); } if(array_key_exists('language',$_POST)) $z8512a=$_POST['language']; if(array_key_exists('email',$_POST)) $l0c83f=trim($_POST['email']); $o0c2bd=(int)$_POST['notes-per-page']; $settings['site_title']=$w05df2; $settings['site_title']=b6f51(); $settings['description']=$g67daf; $settings['author']=$z02bd9; $settings['user']['email']=$l0c83f; $settings['notifications']['new_comments'] = isset ($_POST['email-notify']); if(array_key_exists('template',$_POST)) { $settings['template']=trim($_POST['template']); } $settings['comments']['default_on'] = isset ($_POST['comments-default-on']); if ( $settings['language']!=$z8512a or $settings['appearance']['notes_per_page']!=$o0c2bd or $settings['appearance']['show_sharing_buttons'] != isset ($_POST['show-sharing-buttons']) or $settings['comments']['fresh_only'] != isset ($_POST['comments-fresh-only']) ) { @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); $settings['language']=$z8512a; $settings['appearance']['notes_per_page']=$o0c2bd; $settings['appearance']['show_sharing_buttons'] = isset ($_POST['show-sharing-buttons']); $settings['comments']['fresh_only'] = isset ($_POST['comments-fresh-only']); } if(E2_EDITION){ if(array_key_exists('google-analytics',$_POST)) { $settings['embed']['google-analytics']=trim($_POST['google-analytics']); } if(array_key_exists('yandex-metrika',$_POST)) { $settings['embed']['yandex-metrika']=trim($_POST['yandex-metrika']); } } bc5a6(CACHE_FILENAMES_NOTES_COMMENTS); if (!@k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(r83c8('e2m_settings')); die; } e2_go_to(r83c8('e2m_frontpage', array ('page' => 1))); die; } function e2m_database(){ global$settings,$_strings,$_superconfig; if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $v2cb9d['title']=$_strings['pt--database']; $v2cb9d['heading']=$_strings['pt--database']; $v2cb9d['form']='form-database'; $v2cb9d['form-database'] = array ( 'form-action' => r83c8('e2s_database_save'), 'db-server' => htmlspecialchars(@$settings['db']['server']? $settings['db']['server']:'localhost'), 'db-user' => htmlspecialchars(@$settings['db']['user_name']? $settings['db']['user_name']:'root'), 'db-password' => htmlspecialchars(wee85(@$settings['db']['passw'])), 'db-database' => htmlspecialchars(@$settings['db']['name']), 'submit-text' => $_strings['fb--connect-to-this-db'], ); return $v2cb9d; } function e2s_database_save(){ global$settings,$_db,$_superconfig,$_strings,$_config; if($_SERVER['REQUEST_METHOD']!='POST') return e2_go_to(r83c8('e2m_database')); if (@$_superconfig['disallow_db_config']) { return e2_error404_mode(); } $g0ba44=n55fd(); if ($g0ba44=='bingo-data-exists'){ $settings['db']['server'] = @$_POST['db-server']; $settings['db']['user_name'] = @$_POST['db-user']; $settings['db']['passw']=m1305(@$_POST['db-password']); $settings['db']['name'] = @$_POST['db-database']; if (!@k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(r83c8('e2m_database')); die; } e2_drop_all_kinds_of_cache(); ybb8d(); if (!$_config['retain_search_indexes_on_db_switch']) { $dddece=b476c(); $dddece -> erase(); y198f(); } tcc38(r83c8('e2s_bsi_step')); e2_go_to(r83c8('e2m_settings')); } else { f8a40($_strings['er--double-check-db-params']); e2_go_to(r83c8('e2m_database')); } die; } function pda67(){ return class_exists('ZipArchive'); } function e2m_get_backup(){ if (pda67()) { $lfbade=new ZipArchive(); $t979eb=BACKUP_FOLDER .'backup.zip'; if ($lfbade -> open($t979eb,ZIPARCHIVE::CREATE)) { @ $lfbade -> addFile(USER_FOLDER.'userpic@2x.jpg','userpic@2x.jpg'); @ $lfbade -> addFile(USER_FOLDER.'userpic@2x.png','userpic@2x.png'); foreach(glob(BACKUP_FOLDER .'backup-*.sql') as $k8c7dd); $lfbade -> addFile($k8c7dd,basename($k8c7dd)); $lfbade -> close(); } header('Content-Type: application/zip'); header('Content-Disposition: attachment; filename="backup.zip"'); readfile($t979eb); unlink($t979eb); die; } else { die ('Cannot get backup'); } } p74e0(); function f8a40($g67daf,$m599dc=E2E_STRANGE_ERROR){ global$errors,$settings, $_config, $_strings, $_diagnose; $z1897a=(!ye852()+1 <= (int)$_config['show_call_stack']); if ($g67daf){ if ($g67daf[0]!='<')$g67daf='<p>'.$g67daf .'</p>'; $qcd1dd=array ( 'description' => $g67daf, 'type' => $m599dc, ); if ( $m599dc==E2E_STRANGE_ERROR and $z1897a and function_exists('debug_backtrace') ) { $qcd1dd['backtrace']=debug_backtrace(); } $errors[] = $qcd1dd; } if ($m599dc==E2E_PERMISSIONS_ERROR){ $_diagnose['need?']=true; gc64a('diagnose','1'); } if ($m599dc==E2E_DATABASE_ERROR){ } return true; } function a8739(){ global$errors,$e1c0b7,$_strings,$_diagnose; $y7287a=xea70(); if(count($y7287a)==0){ gc64a('diagnose',''); unset($_COOKIE['diagnose']); $_diagnose['need?']=false; $_diagnose['ok?']=true; return true; } else { $x6e2ba=''; $x6e2ba.='<p>'. $_strings['gs--enable-write-permissions-for-the-following'] .'</p>'; $x6e2ba.='<ul>'; foreach ($y7287a as $g8fa14){ if ($g8fa14=='.')$g8fa14=''; $x6e2ba.='<li><tt>.../'. $g8fa14 .'</tt></li>'; if(__LOG)__log('Diagnostics: cannot write <'. $g8fa14 .'>'); } $x6e2ba.='</ul>'; $qcd1dd=array ( 'title' => $_strings['et--fix-permissions-on-server'], 'description' => $x6e2ba, 'type' => E2E_DIAGNOSTICS_MESSAGE, 'class' => 'serious', ); $errors[] = $qcd1dd; $_diagnose['ok?']=false; return false; } } function oe1c4($uc1336,$g67daf,$w1407f,$oc2d4b,$h4f62c){ global$errors; if(0==error_reporting() or ($uc1336 & 8)) return; $w1407f=str_replace(__DIR__,'',$w1407f); f8a40($w1407f .', line '. $oc2d4b .'<br />Error '. $uc1336 .': '. $g67daf); $errors[count($errors)-1]['phpcode']=$uc1336; } function bec07(){ global$errors,$settings,$_config; @session_start(); if(is_array(@$_SESSION['errors'])) { $je1671=array_merge(@$_SESSION['errors'],$errors); } else { $je1671=$errors; } $z1897a=(!ye852()+1 <= (int)$_config['show_call_stack']); if (@$_config['store_backtrace'] and $z1897a and $je1671!=NULL){ @k6e52('backtrace.psa',serialize($je1671)); } else { @unlink('backtrace.psa'); } if (isset ($_SESSION['errors'])) unset($_SESSION['errors']); $v2cb9d=array(); $cb8735=false; if(count($je1671) > 0){ foreach ($je1671 as $q865c0 => $f08a44){ if ($f08a44['type']==E2E_STRANGE_ERROR){ $f08a44['class']='serious'; $cb8735=true; if ($z1897a){ $f08a44['backtrace']=x2616($f08a44['backtrace']); } } if ($f08a44['type']==E2E_MESSAGE){ $f08a44['class']='info'; } $je1671[$q865c0]=$f08a44; } $v2cb9d['each']=$je1671; if ( $cb8735 and @$_config['store_backtrace'] and $z1897a and is_file('debug.php') ) { $v2cb9d['debug-link']='debug.php'; } } return $v2cb9d; } function c4006(){ $errors=bec07(); foreach($errors['each'] as $tcb5e1){ echo '<p>'. $tcb5e1['description'] .'</p>'; } die; } function x2616($j69206){ global $ya57c1; if (!is_array($j69206)) return 'No backtrace info'; $j69206=array_reverse($j69206); $j69206=array_splice($j69206,0,count($j69206)-1); $je1671='<p style="background: #fea; padding: .25em .5em; line-height: 1em; overflow: hidden">'; foreach ($j69206 as $q865c0 => $ie358e){ $h195df=@$ie358e['args'] or $h195df=array(); $da956a=array(); foreach ($h195df as $k5919c){ $da956a[] = var_export($k5919c,true); } $k8c7dd=@$ie358e['file']; $k8c7dd=str_replace($_SERVER['DOCUMENT_ROOT'],'',$k8c7dd); $g6438c=(@$ie358e['line']? (' #'. $ie358e['line']) : '?'); $je1671.='<div style="margin: .25em 0 .5em '. $q865c0*3 .'em">'; $je1671.='<span style="float: right; color: #666"> '. $k8c7dd.$g6438c .'</span>'; $je1671.='<tt><b>'. @$ie358e['function'] .' (</b>'; if(count($da956a)) { $veb84a=str_replace("array (\n)",'array ()',$da956a); $veb84a=implode(', ',$veb84a); if(0){ $veb84a=highlight_string('<?'. $veb84a .'?'.'>',true); $veb84a=substr($veb84a,77, -28); } $veb84a=str_replace('&nbsp;',' ',$veb84a); $veb84a=nl2br($veb84a); $je1671.='<div style="margin: 0 0 0 1.12em">'. $veb84a .'</div>'; } $je1671.='<b>)</b> &rarr;</tt></div>'; } $je1671.='</p>'; return $je1671; } set_error_handler('oe1c4'); function e2_error404_mode(){ global$_config,$_strings; if($_config['try_redirect_to_all']) { $j4a7dc='all/'. urldecode($_GET['go']); pb7e9($j4a7dc); } header('HTTP/1.1 404 Not found'); $se70c4['heading']=$_strings['pt--page-not-found']; $se70c4['title']=$_strings['pt--page-not-found']; return $se70c4; } include_once 'neasden/neasden.php'; function t6f10($e1cb25){ $Nn=new Neasden; $Nn->profile_name='kavychki'; return$Nn->format($e1cb25); } function zc0c4($if2ffc,$e1cb25,$t5c18e){ if ($e1cb25==='') return array (); if ($if2ffc=='calliope'){ preg_match_all('/\(\(([^ ]*)( |\)\))/',$e1cb25,$v9c28d); return $v9c28d[1]; } elseif ($if2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$t5c18e; $Nn->format($e1cb25); return$Nn->resources_detected; } else { return array (); } } function p154e($if2ffc,$e1cb25,$t5c18e){ if(__LOG)__log('Format: format with formatter "'. $if2ffc .'" in context "'. $t5c18e.'"'); if ($if2ffc=='calliope'){ $e1cb25=fedd9($e1cb25); $e1cb25=o5599($e1cb25,$t5c18e); $meta=array(); $e1cb25=pfd97($e1cb25); $e1cb25='<div class="e2-text-calliope-formatted">'. t6f10($e1cb25) .'</div>'; } elseif ($if2ffc=='neasden'){ $Nn=new Neasden; $Nn->profile_name=$t5c18e; $e1cb25=$Nn->format($e1cb25); $meta=array ( 'links-required' => $Nn->links_required, 'resources-detected' => $Nn->resources_detected ); } return array ( 'text-final' => $e1cb25, 'meta' => $meta, ); } function ob7f1($e1cb25,$t5c18e){ global$_config; return p154e($_config['default_formatter'],$e1cb25,$t5c18e); } function o5599($e1cb25,$t5c18e){ global$_config,$settings,$full_blog_url,$_template; @ (list ($t5c18e,$he8fab)=explode('|',$t5c18e)); require_once 'calliope/WikiFormatter.php'; if ('full'==$t5c18e)$xad910=WF_FULL_MODE; elseif ('full-rss'==$t5c18e)$xad910=WF_FULL_MODE; elseif ('simple'==$t5c18e)$xad910=WF_SIMPLE_MODE; elseif ('simple-rss'==$t5c18e)$xad910=WF_SIMPLE_MODE; else return $e1cb25; $p0a1d3=new WikiFormatter(); $p0a1d3 -> replace=array ( '/' => 'i', '+' => 'small', '-' => 's', '*' => 'b', '^' => 'sup', 'v' => 'sub', '#' => 'tt', '!' => 'blockquote', ); $p0a1d3 -> settings=array ( 'hrefSize' => 100, 'localImgDir' => $full_blog_url .'/'. PICTURES_FOLDER, 'maxImgWidth' => $_template['max_image_width'], 'mode' => $xad910, 'enableShrinkLongHref' => 1, 'enableHr' => 0, 'enableBr' => 1, 'enableHeaders' => 1, 'headersStartWith' => 1, 'enableTables' => 1, 'simpleTableCSSClass' => 'e2-text-table', 'enableAutoAcronymEngine' => 0, 'enableAcronym' => 0, 'acronymBase' => '', 'enableList' => 1, 'mailSafe' => "<a href=\"\" onmouseover=\"this.href='mailto:'+{email}\">{icon}<script language=\"JavaScript\">document.write({name});</script></a>", 'ljUserTag' => '<a href="http://livejournal.com/users/{name}/">{name}</a>', 'fullVersionURL' => $he8fab, 'enableTagIcons' => 0, 'outerUrlInNewWindow' => 0, 'lineBreak' => "\n", 'extLinkHrefPrefix' => '', ); $e1cb25=$p0a1d3 -> Wiki2HTML($e1cb25); return $e1cb25; } function tcc38($x572d4){ if(__LOG)__log('Spawn: Curl '. $x572d4 .'...'); if(function_exists('curl_init')) { $df6e57=curl_init(); $e80e25=!ini_get('open_basedir'); curl_setopt_array($df6e57, array ( CURLOPT_URL => $x572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => pc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $e80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($df6e57); $l70106=curl_errno($df6e57); $h809b1=curl_error($df6e57); $m099fb=curl_getinfo($df6e57); curl_close($df6e57); if(__LOG)__log('Spawn: Curl returns: ['. print_r($m099fb,true) .'] ['. $content .'], (errno='. $l70106 .', errstr='. $h809b1 .')...'); } else { if(__LOG)__log('Spawn: Curl functions are not available'); } } function s5b68($iea59a){ global$_config; if (@$_config['broadcast_url'] and !$iea59a['IsExternal']) { if(__LOG)__log('Broadcast-async note: '. $iea59a['Title']); $x572d4=r83c8('e2m_note_broadcast', array ('*note' => $iea59a)); if(__LOG)__log('Broadcast will spawn url: '. $x572d4); tcc38($x572d4); } } function meb3b($iea59a){ global$_config; $zcffbb=r83c8('e2m_note_json', array ('*note' => $iea59a)); $x572d4=$_config['broadcast_url']; $x572d4.='?src='. urlencode($zcffbb); if(__LOG)__log('Broadcast: Curl '. $x572d4 .'...'); if(function_exists('curl_init')) { $df6e57=curl_init(); $e80e25=!ini_get('open_basedir'); curl_setopt_array($df6e57, array ( CURLOPT_URL => $x572d4, CURLOPT_CONNECTTIMEOUT => 300, CURLOPT_TIMEOUT => 1, CURLOPT_MAXREDIRS => 1, CURLOPT_COOKIE => pc3fb(), CURLOPT_SSL_VERIFYPEER => false, CURLOPT_FOLLOWLOCATION => $e80e25, CURLOPT_RETURNTRANSFER => true, CURLOPT_AUTOREFERER => true, CURLOPT_USERAGENT => E2_UA_STRING, )); $content=curl_exec($df6e57); $l70106=curl_errno($df6e57); $h809b1=curl_error($df6e57); $m099fb=curl_getinfo($df6e57); curl_close($df6e57); if(__LOG)__log('Broadcast: Curl returns: ['. print_r($m099fb,true) .'] ['. $content .'], (errno='. $l70106 .', errstr='. $h809b1 .')...'); } else { if(__LOG)__log('Spawn: Curl functions are not available'); } } function e2m_note_broadcast($parameters=array ()) { global$_config; if (@$_config['broadcast_url']) { meb3b($parameters['*note']); die ('Broadcasted.'); } else { return e2_error404_mode(); } } function e2m_timezone(){ global$_strings,$settings; $qde2fd=array ( 'form-action' => r83c8('e2s_select_timezone'), 'submit-text' => $_strings['fb--select'], 'timezone-selector' => b9fe5($settings['timezone']['offset'],1), 'dst?' => $settings['timezone']['is_dst'], ); return array ( 'title' => $_strings['pt--default-timezone'], 'heading' => $_strings['pt--default-timezone'], 'form' => 'form-timezone', 'form-timezone' => $qde2fd, ); } function e4c37(){ global$_strings; $j5cacd=array ( -720 => '', -660 => '', -600 => '', -540 => '', -480 => $_strings['tt--zone-pt'], -420 => $_strings['tt--zone-mt'], -360 => $_strings['tt--zone-ct'], -300 => $_strings['tt--zone-et'], -240 => '', -210 => '', -180 => '', -120 => '', -60 => '', 0 => $_strings['tt--zone-gmt'], 60 => $_strings['tt--zone-cet'], 120 => $_strings['tt--zone-eet'], 180 => '', 210 => '', 240 => $_strings['tt--zone-msk'], 270 => '', 300 => '', 330 => '', 345 => '', 360 => $_strings['tt--zone-ekt'], 390 => '', 420 => '', 480 => '', 540 => '', 570 => '', 600 => '', 660 => '', 720 => '', 780 => '', 840 => '', ); return $j5cacd; } function t82a3($i7a86c){ $j5cacd=e4c37(); return @$j5cacd[(int)$i7a86c/SECONDS_IN_A_MINUTE]; } function t9515($i7a86c){ $j04b29='+'; if ($i7a86c < 0)$j04b29='&ndash;'; $p73cdd=str_pad((int) (abs($i7a86c)/3600),2,'0',STR_PAD_LEFT); $x640fd=str_pad(abs($i7a86c)/60 % 60,2,'0',STR_PAD_LEFT); return 'GMT'. $j04b29.$p73cdd .':'. $x640fd; } function b9fe5($t0743a,$h5784d=''){ global$_strings; $j5cacd=e4c37(); $v2cb9d=''; if (!$h5784d)$h5784d=count($j5cacd); $v2cb9d.='<select name="offset" size="'. $h5784d .'">'; foreach ($j5cacd as $i7a86c => $f83bce){ $yc03a8=''; if ($i7a86c*SECONDS_IN_A_MINUTE==$t0743a)$yc03a8=' selected="selected"'; $v2cb9d.='<option'. $yc03a8 .' value="'.$i7a86c.'">'; $j04b29=''; if ($i7a86c < 0)$j04b29='−'; if ($i7a86c > 0)$j04b29='+'; $p73cdd=(int) (abs($i7a86c*SECONDS_IN_A_MINUTE)/3600); $x640fd=(int) (abs($i7a86c*SECONDS_IN_A_MINUTE)/60 % 60); if ($p73cdd){ $v2cb9d .= ( $j04b29 .' '. $p73cdd .' '. $_strings['gs--timezone-offset-hours'] .' '. ($x640fd? ($x640fd .' '. $_strings['gs--timezone-offset-minutes']) : '') ); if ($f83bce){ $v2cb9d .= ' ('. $f83bce. ')'; } } else { $v2cb9d .= $f83bce; } $v2cb9d.='</option>'; } $v2cb9d.='</select>'; return $v2cb9d; } function e2s_select_timezone(){ global$settings,$_strings; if (@$_POST['offset'] >= -720 and @$_POST['offset'] <= 780){ $settings['timezone']['offset'] = @$_POST['offset']*SECONDS_IN_A_MINUTE; $settings['timezone']['is_dst'] = isset ($_POST['is_dst']); } if (!@k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); e2_go_to(r83c8('e2m_timezone')); die; } e2_go_to(r83c8('e2m_settings')) and die (); } function j0923($laad65){ return array ( 'offset' => (int)$laad65['Offset'], 'is_dst' => (bool)$laad65['IsDST'], ); } function v3211(){ return array ( 'offset' => 0, 'is_dst' => false, ); } function m5c05(){ global$settings; return$settings['timezone']; } function g7770($ob2c6c,$ldf491){ if (@$ob2c6c['is_dst']) { $c30481=(int)date('I',$ldf491); $p6b7ea=date('Z',$ldf491)-$c30481*SECONDS_IN_AN_HOUR; $f3e61a=$ob2c6c['offset']; $m178ae=$f3e61a-$p6b7ea; $e75b02=date('I',$ldf491+$m178ae); return $e75b02; } else { return 0; } } function tb2bf($ob2c6c,$ldf491){ global$settings; if ($ob2c6c and is_array($ob2c6c)) { return ( $ob2c6c['offset'] + g7770($ob2c6c,$ldf491)*SECONDS_IN_AN_HOUR ); } } function g8afe($ldf491){ return tb2bf(m5c05(),$ldf491); } function f5a2f($i1ddcb,$n4a202,$ob2c6c){ return gmdate($i1ddcb,$n4a202+tb2bf($ob2c6c,$n4a202)); } function ga846($i1ddcb,$n4a202){ return f5a2f($i1ddcb,$n4a202,m5c05()); } function t66cd($i41529,$b6f8f5=false,$b8277e=false){ if(is_numeric($b8277e)) { $cea2b2=gmmktime(0,0,0,$b6f8f5,$b8277e,$i41529); $y7f021=gmmktime(0,0,0,$b6f8f5,$b8277e+1,$i41529)-1; } elseif(is_numeric($b6f8f5)) { $cea2b2=gmmktime(0,0,0,$b6f8f5,1,$i41529); $y7f021=gmmktime(0,0,0,$b6f8f5+1,1,$i41529)-1; } else { $cea2b2=gmmktime(0,0,0,1,1,$i41529); $y7f021=gmmktime(0,0,0,1,1,$i41529+1)-1; } return array ($cea2b2,$y7f021); } function t2143($ob2c6c,$i41529,$b6f8f5=false,$b8277e=false){ list ($cea2b2,$y7f021)=t66cd($i41529,$b6f8f5,$b8277e); $cea2b2 -= tb2bf($ob2c6c,$cea2b2); $y7f021 -= tb2bf($ob2c6c,$y7f021); return array ($cea2b2,$y7f021); } function wac5b($i41529,$b6f8f5=false,$b8277e=false){ return t2143(m5c05(),$i41529,$b6f8f5,$b8277e); } function b5273($i41529,$b6f8f5=false,$b8277e=false){ $s32038=13; $jda4f0=-12; $s32038+=1; $jda4f0 -= 1; list ($cea2b2,$y7f021)=t66cd($i41529,$b6f8f5,$b8277e); $cea2b2 -= $s32038*3600; $y7f021 -= $jda4f0*3600; return array ($cea2b2,$y7f021); } function qd17a($i7a86c){ if ((int) @$i7a86c > 0) return (string)'+'.abs(@$i7a86c); elseif ((int) @$i7a86c < 0) return (string)'-'.abs(@$i7a86c); else return ''; } function qd536($ldf491,$wa0f0b=''){ $o2ab64=g8afe($ldf491); $j04b29=($o2ab64 >= 0)?'+':'-'; $o2ab64=abs($o2ab64); $s03c7c=$o2ab64 % 60; $o2ab64 -= $s03c7c; $b6f8f5=$o2ab64 % 3600/60; $o2ab64 -= $b6f8f5*60; $i2510c=$o2ab64/3600; if ($i2510c < 10)$i2510c='0'.$i2510c; if ($b6f8f5 < 10)$b6f8f5='0'.$b6f8f5; return $j04b29.$i2510c.$wa0f0b.$b6f8f5; } function za618($laa759){ global$settings; if(is_numeric($laa759)) { $result['offset']=SECONDS_IN_A_MINUTE*$laa759; $result['is_dst']=false; $dd8935=SECONDS_IN_A_MINUTE*$laa759-SECONDS_IN_AN_HOUR; $ra6cfc=array ('offset' => $dd8935,'is_dst' => true); $ra6cfc=(int)tb2bf($ra6cfc,time()); if($result['offset']==$ra6cfc){ $result['offset']=$dd8935; $result['is_dst']=true; } } else { if(array_key_exists('timezone',$settings)) { $result=$settings['timezone']; } else { $result['offset']=0; $result['is_dst']=false; } } return$result; } function f692f($h96b8c){ $i2510c=ga846('H',$h96b8c); if ($i2510c <= 4) return 4; elseif ($i2510c <= 10) return 1; elseif ($i2510c <= 16) return 2; elseif ($i2510c <= 22) return 3; else return 4; } function q7a0b($h0e524,$sb65f7=null){ global$_strings; if ($sb65f7===null)$sb65f7=m5c05(); $kdb42a=f5a2f('d.m.Y',$t97bc5,$sb65f7); $x33284=f5a2f('d.m.Y',$h0e524,$sb65f7); $ded79a=SECONDS_IN_A_MINUTE; $k77cbc=SECONDS_IN_AN_HOUR; $t97bc5=time(); $k0b375=f692f($t97bc5); $k3dfda=f692f($h0e524); $c74459=$t97bc5-$h0e524; if ($c74459 < 0) return$_strings['tt--from-the-future']; if ($c74459 >= 0 and $c74459 < 54) return$_strings['tt--just-now']; if ($c74459 >= 54 and $c74459 < 108) return$_strings['tt--one-minute-ago']; $n7eccb=$c74459+12; $d7828e=floor($n7eccb/$ded79a); if ($c74459 >= 108 and $c74459 < 54*$ded79a) return e2l_get_string( 'tt--minutes-ago', array ('minutes' => $d7828e) ); if ($c74459 >= 54*$ded79a and $c74459 < 108*$ded79a) return$_strings['tt--one-hour-ago']; $n7eccb=$c74459+12*$ded79a; $j6b497=floor($n7eccb/$k77cbc); if ($c74459 >= 108*$ded79a and $c74459 < 4*$k77cbc) return e2l_get_string( 'tt--hours-ago', array ('hours' => $j6b497) ); $f07cc6=f5a2f('G:i',$h0e524,$sb65f7); if ($c74459 >= 4*$k77cbc and $k0b375 > $k3dfda and $kdb42a==$x33284){ return$_strings['tt--today']; } if ((($t97bc5-$h0e524) <= YEAR_DISPLAY_THRESH)) { return e2l_get_string( 'tt--date', array ( 'day' => f5a2f('j',$h0e524,$sb65f7), 'month' => f5a2f('m',$h0e524,$sb65f7), ) ); } return f5a2f('Y',$h0e524,$sb65f7); } $_model_contractions=array ( 'key' => "INT UNSIGNED AUTO_INCREMENT PRIMARY KEY", 'pkey' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'int' => "INT DEFAULT '0' NOT NULL", 'uint' => "INT UNSIGNED DEFAULT '0' NOT NULL", 'time' => "INT UNSIGNED DEFAULT '0' NOT NULL", '0' => "TINYINT(1) DEFAULT '0' NOT NULL", '1' => "TINYINT(1) DEFAULT '1' NOT NULL", 'v1' => "VARCHAR(1) DEFAULT '' NOT NULL", 'v8' => "VARCHAR(8) DEFAULT '' NOT NULL", 'v15' => "VARCHAR(15) DEFAULT '' NOT NULL", 'v32' => "VARCHAR(32) DEFAULT '' NOT NULL", 'v64' => "VARCHAR(64) DEFAULT '' NOT NULL", 'fid' => "VARCHAR(32) DEFAULT '". $_config['default_formatter'] ."' NOT NULL", 'v255' => "VARCHAR(255) DEFAULT '' NOT NULL", 'text' => "MEDIUMTEXT", ); $_model=array ( 'Actions' => array ( array ('ID', 'key'), array ('EntityID', 'pkey'), array ('Stamp', 'time'), array ('HitCount', 'int'), ), 'Aliases' => array ( array ('ID', 'key'), array ('EntityType', 'v1'), array ('EntityID', 'pkey'), array ('Alias', 'v64'), array ('Stamp', 'time'), ), 'Comments' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('AuthorName', 'v255'), array ('AuthorEmail', 'v255'), array ('Text', 'text'), array ('Reply', 'text'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('IsReplyVisible', '0'), array ('IsReplyFavourite', '0'), array ('IsAnswerAware', '1'), array ('IsSubscriber', '0'), array ('IsSpamSuspect', '0'), array ('IsNew', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('ReplyStamp', 'time'), array ('ReplyLastModified', 'time'), array ('IP', 'v15'), ), 'Keywords' => array ( array ('ID', 'key'), array ('Keyword', 'v255'), array ('OriginalAlias', 'v64'), array ('Description', 'text'), array ('Uploads', 'text'), array ('IsFavourite', '0'), ), 'Notes' => array ( array ('ID', 'key'), array ('Title', 'v255'), array ('Text', 'text'), array ('FormatterID', 'fid'), array ('OriginalAlias', 'v64'), array ('Uploads', 'text'), array ('IsPublished', '0'), array ('IsCommentable', '0'), array ('IsVisible', '1'), array ('IsFavourite', '0'), array ('Stamp', 'time'), array ('LastModified', 'time'), array ('Offset', 'int'), array ('IsDST', '0'), array ('IsIndexed', '0'), array ('IsExternal', '0'), array ('SourceID', 'pkey'), array ('SourceNoteID', 'pkey'), array ('SourceNoteURL', 'v255'), array ('SourceNoteJSONURL', 'v255'), array ('SourceNoteData', 'text'), ), 'NotesKeywords' => array ( array ('ID', 'key'), array ('NoteID', 'pkey'), array ('KeywordID', 'pkey'), ), 'Sources' => array ( array ('ID', 'key'), array ('TrueID', 'pkey'), array ('Title', 'v255'), array ('AuthorName', 'v255'), array ('URL', 'v255'), array ('PictureURL', 'v255'), array ('IsWhiteListed', '0'), array ('IsTrusted', '0'), ), ); $_model_indexes=array ( 'Actions' => array ( "UNIQUE INDEX (`EntityID`, `Stamp`)", ), 'Aliases' => array ( "INDEX (`Alias`)", "INDEX (`EntityID`)", ), 'Comments' => array ( "INDEX (`NoteID`)", ), 'Keywords' => array (), 'Notes' => array ( "FULLTEXT (`Title`, `Text`)", "INDEX (`Stamp`)", ), 'NotesKeywords' => array ( "INDEX (`NoteID`)", ), ); $_model_minimal_table_list=array ( 'Comments', 'Keywords', 'Notes', 'NotesKeywords', ); function e2_model_data_check($s2a304,$r11e0e){ global$_model,$_model_minimal_table_list,$_config; $f08cfc=false; $j35f9b=array(); $eac5c7='SHOW TABLES FROM `'. mysqli_real_escape_string($s2a304,$r11e0e). '`'; $result=mysqli_query($s2a304,$eac5c7); if($result){ while ($af1965=mysqli_fetch_row($result)) { foreach(array_keys($_model) as $id2ffa){ if(strcasecmp($af1965[0],$_config['db_table_prefix'].$id2ffa)===0){ $f08cfc=true; $j35f9b[] = $id2ffa; } } } } $ed9a22=true; foreach(array_keys($_model) as $id2ffa){ if (!in_array($id2ffa,$j35f9b)) { $ed9a22=false; } } $d7ec6f=true; foreach($_model_minimal_table_list as $id2ffa){ if (!in_array($id2ffa,$j35f9b)) { $d7ec6f=false; } } return array ( 'occupied' => $f08cfc, 'complete' => $ed9a22, 'migrateable' => $d7ec6f, ); } function yb154($xcf1e8,$hee11c,$f5f4dc){ $d32e95=array(); if (($s2a304=mysqli_connect($xcf1e8,$hee11c,$f5f4dc)) !== false){ $result=mysqli_query($s2a304,"SHOW DATABASES"); while ($af1965=mysqli_fetch_row($result)) { if ( mysqli_select_db($s2a304,$af1965[0]) and !in_array($af1965[0], array ('information_schema','mysql')) ) { $d32e95[] = $af1965[0]; } } } return $d32e95; } function n55fd(){ global$_model,$_config; $xcf1e8=$hee11c=$f5f4dc=$r11e0e=''; if(array_key_exists('db-server',$_POST)) $xcf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $hee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$f5f4dc=$_POST['db-password']; if(array_key_exists('db-database',$_POST))$r11e0e=$_POST['db-database']; if (($s2a304=mysqli_connect($xcf1e8,$hee11c,$f5f4dc)) === false){ if(mysqli_connect_errno()==1045){ return 'server-responding'; } else { return 'no-connect'; } } else { if (!$r11e0e){ $d32e95=yb154($xcf1e8,$hee11c,$f5f4dc); $r11e0e=$d32e95[0]; } if(mysqli_select_db($s2a304,$r11e0e)===false){ return 'server-lets-in'; } else { $iaae42=e2_model_data_check($s2a304,$r11e0e); if ($iaae42['occupied'] and $iaae42['migrateable']) { return 'bingo-data-exists'; } elseif ($iaae42['occupied']) { return 'data-incomplete'; } else { return 'bingo'; } } } } function ba0f9($baab9e){ global$_config; $w7694f=( "SHOW TABLES LIKE '". $_config['db_table_prefix'].$baab9e . "'" ); j0738($w7694f); $q9b207=b0d6b(); return count($q9b207) > 0; } function kf1ac($baab9e){ global$_model,$_model_contractions,$_model_indexes,$_config; if (ba0f9($baab9e)) { return true; } $m851f5=$_config['db_table_prefix']; if(array_key_exists($baab9e,$_model)) { $a54ca8=array(); foreach($_model[$baab9e] as $e1afd3){ list ($lb0689,$m599dc)=$e1afd3; $a54ca8[] = "`". $lb0689 ."` ". $_model_contractions[$m599dc]; } $s1b1cc=( "CREATE TABLE `". $m851f5.$baab9e ."` ". "(". implode(" ,",$a54ca8) .") ". "ENGINE=MyISAM DEFAULT CHARSET=utf8" ); $b260ca=j0738($s1b1cc); if(is_array(@$_model_indexes[$baab9e])) { foreach($_model_indexes[$baab9e] as $y6a992){ $s1b1cc=( "ALTER TABLE `". $m851f5.$baab9e ."` ". "ADD ". $y6a992 ); j0738($s1b1cc); } } if ($b260ca) return true; } } function f9943($baab9e,$kde17f,$sb512d='INSERT',$d07ccf=''){ global$_config,$_db; foreach ($kde17f as $w8ce4b => $o9e366){ $o10249=q7928($o9e366); if ($o10249[0]=='`'){ $sbcf11=$o10249; } else { $sbcf11="'". $o10249 ."'"; } $i8688e[$w8ce4b]=$sbcf11; } $ld05b6="`". implode("`, `",array_keys($i8688e)). "`"; $vf09cc=implode(", ",array_values($i8688e)); $s1b1cc=( $sb512d ." INTO `". $_config['db_table_prefix'].$baab9e ."` ". "(".$ld05b6 .") VALUES (". $vf09cc .")". ($d07ccf? (' '. $d07ccf):'') ); if (j0738($s1b1cc)) { $kde17f['ID']=mysqli_insert_id($_db['link']); return $kde17f; } } function raa79($baab9e,$kde17f,$j7692d=false,$n0f543=false){ global$_config; if(__LOG)__log('Model: update record, table <'. $baab9e .'>'); $l6a7f2=array(); foreach(e2model__soft_fields_for_table_($baab9e) as $z06e3d){ if(array_key_exists($z06e3d,$kde17f)) { $o10249=q7928($kde17f[$z06e3d]); if ($o10249[0]=='`'){ $sbcf11=$o10249; } else { $sbcf11="'". $o10249 ."'"; } $l6a7f2[] = '`'. $z06e3d .'`'."=". $sbcf11 .""; } } $pb5b39=array(); if(is_array($j7692d)) { foreach(e2model__soft_fields_for_table_($baab9e) as $z06e3d){ if(array_key_exists($z06e3d,$j7692d)) { $pb5b39[] = '`'. $z06e3d .'`'."='". q7928($j7692d[$z06e3d]) ."'"; } } } if(count($pb5b39)) { $y56790=implode(" AND ",$pb5b39); } else { if (!array_key_exists('ID',$kde17f) or !is_numeric($kde17f['ID'])) { die ('API MISUSE: e2_update_record must be called with an ID field in $record when updating single row'); } $y56790="`ID`=". $kde17f['ID']; } if(count($l6a7f2) > 0){ $s91179=$n0f543? 'LOW_PRIORITY ':''; $s1b1cc=( "UPDATE ". $s91179 ."`". $_config['db_table_prefix'].$baab9e ."` ". "SET ". implode(', ',$l6a7f2) ." WHERE ". $y56790 ); if (j0738($s1b1cc)) return true; } } function e2model__soft_fields_for_table_($baab9e){ global$_model; $v2cb9d=array(); if(array_key_exists($baab9e,$_model)) { foreach($_model[$baab9e] as $z06e3d){ if (!in_array($z06e3d[1], array ('key'))) { $v2cb9d[] = $z06e3d[0]; } } } return $v2cb9d; } function e2m_install(){ global$_strings,$_superconfig,$_files_written,$_folders_written,$_diagnose; $v2cb9d=array(); if(e2_is_installed()) { e2_go_to(''); } else { if($_superconfig['disallow_installer']) { die ('Installer disabled by superconfig'); } if(__LOG)__log('Installer: not installed, present user with form'); $v2cb9d['title']=$_strings['pt--install']; $v2cb9d['heading']=$_strings['pt--install']; $sc50d0=$_strings['fb--begin']; $ed77d5['server'] = @$_COOKIE[l8c3b('install_db_server')]; $ed77d5['user_name'] = @$_COOKIE[l8c3b('install_db_user_name')]; $ed77d5['passw']=wee85(@$_COOKIE[l8c3b('install_db_passw')]); $ed77d5['name'] = @$_COOKIE[l8c3b('install_db_name')]; $v2cb9d['form-install'] = array ( 'form-action' => r83c8('e2s_install'), 'form-check-db-config-action' => r83c8('e2j_check_db_config'), 'form-list-databases-action' => r83c8('e2j_list_databases'), 'submit-text' => $sc50d0, 'retry-text' => $_strings['fb--retry'], 'db-server' => htmlspecialchars(@$ed77d5['server']? $ed77d5['server']:'localhost'), 'db-user' => htmlspecialchars(@$ed77d5['user_name']? $ed77d5['user_name']:'root'), 'db-password' => htmlspecialchars(DB_PASSWORD_RECOVER_AND_SHOW? (@$ed77d5['passw']) : ''), 'db-database' => htmlspecialchars(@$ed77d5['name']), ); $v2cb9d['form-install']['installation-possible?']=true; if(__LOG)__log('Installer: force directories'); foreach($_folders_written as $f45684){ @iaf42($f45684); } if (!@isset ($_diagnose['ok?']))a8739(); if($_diagnose['ok?']) { if(__LOG)__log('Installer: everything is fine'); } else { if(__LOG)__log('Installer: problems, tell user'); $v2cb9d['form-install']['installation-possible?']=false; } } if(__LOG)__log('Installer: return'); return $v2cb9d; } function e2_instantiate($b2af72){ global$_instance; $_instance['version']=$b2af72; if (k6e52(USER_FOLDER. '/instance.psa',serialize($_instance))) { return true; } else { die ('Cannot instantiate v'. $b2af72 .': probably permission denied'); } } function e2s_instantiate($parameters){ global$_strings; if(e2_is_installed()) { die ('Remove the file "'. USER_FOLDER .'instance.psa" first'); } else { if(is_numeric($parameters['version'])) { if(e2_instantiate($parameters['version'])) { f8a40($_strings['gs--instantiated-version'] .' v'. $parameters['version'],E2E_MESSAGE); e2_go_to(r83c8('e2m_frontpage', array ('page' => 1))); die; } } } die ('Could not create instance of engine'); } function e2s_install(){ global$settings,$_strings,$_instance,$_config,$hfd6b1; if(e2_is_installed()) { e2_go_to(r83c8('e2m_install')); die; } else { e2_drop_all_kinds_of_cache(); $ed77d5['server'] = @$_POST['db-server']; $ed77d5['user_name'] = @$_POST['db-user']; $ed77d5['passw'] = m1305(@$_POST['db-password']); $ed77d5['name'] = @$_POST['db-database']; if ( ($s2a304=mysqli_connect( $ed77d5['server'],$ed77d5['user_name'],$_POST['db-password'] )) === false ){ f8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); e2_go_to(r83c8('e2m_install')); die; } $iaae42=e2_model_data_check($s2a304,$ed77d5['name']); $x0e88b=false; if ($iaae42['occupied'] and $iaae42['migrateable']) { if(__LOG)__log('Installer: DB data exists and migrateable'); $x0e88b=true; } elseif ($iaae42['occupied']) { if(__LOG)__log('Installer: DB data exists, but incomplete'); f8a40($_strings['er--db-data-incomplete'],E2E_DATABASE_ERROR); e2_go_to(r83c8('e2m_install')); die; } $ob2c6c=za618(@$_POST['gmt-offset']); foreach ($ed77d5 as $w8ce4b => $o9e366){ gc64a('install_db_' .$w8ce4b,$o9e366); } @session_start(); if (!array_key_exists('password',$_POST) or trim($_POST['password']) == ''){ f8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(r83c8('e2m_install')); die; } $d88162=trim($_POST['password']); $o2d6d8['sessions'] = array (array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => ee8ed(true), 'ua' => $_SERVER['HTTP_USER_AGENT'], )); $m444bc=true; if (!p1d21($o2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); $m444bc=false; } if (!@k6e52(USER_FOLDER.'password-hash.psa',serialize(h4c49($d88162)))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $m444bc=false; } if (!$x0e88b){ $settings=array(); } $settings['db']=$ed77d5; $settings['timezone']=$ob2c6c; $settings['template']=DEFAULT_TEMPLATE; $settings['language']=DEFAULT_LANGUAGE; if (!@k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { f8a40($_strings['er--settings-not-saved'],E2E_PERMISSIONS_ERROR); $m444bc=false; } if ($m444bc){ if ($x0e88b){ if(__LOG)__log('Installer: No need to create DB'); $vba46b=u0f7c(); if ($vba46b){ if(__LOG)__log('Installer: Migrate'); ybb8d(); } else { if(__LOG)__log('Installer: DB not OK'); f8a40($_strings['er--double-check-db-params']); } } else { if(__LOG)__log('Installer: Creating DB...'); $vba46b=( kf1ac('Notes') and kf1ac('Comments') and kf1ac('Keywords') and kf1ac('NotesKeywords') and kf1ac('Aliases') and kf1ac('Actions') and kf1ac('Sources') ); if (!$vba46b){ if(__LOG)__log('Installer: DB not OK'); f8a40($_strings['er--double-check-db-params']); } } if ($vba46b){ if(__LOG)__log('Installer: Search index...'); $dddece=b476c(); $dddece -> erase(); y198f(); if(__LOG)__log('Installer: DB OK, instantiating...'); e2_instantiate(E2_VERSION); if(__LOG)__log('Installer: Done'); if(__LOG)__log('Installer: Complete'); } tcc38(r83c8('e2s_bsi_step', array ())); e2_go_to(); die; } else { e2_go_to(r83c8('e2m_install')); die; } } } function e2_is_installed(){ global$_instance; return (bool)$_instance; } function e2_make_sure_that_installed(){ global $s57de2,$ya57c1,$_instance,$_superconfig; if(e2_is_installed()) { if(E2_VERSION < $_instance ['version']) { if(IGNORE_VERSION_MISMATCH) return; if(__LOG)__log('Installer: cannot downdate'); header('HTTP/1.1 503 Service Unavailable'); die ('E2 does not support automatic downgrade.'); } elseif(E2_VERSION > $_instance ['version']) { if(__LOG)__log('Installer: need to update'); header('Location: http://'. $s57de2.$ya57c1 .'/perform_update/'); header('Location: '. r83c8('e2s_update_perform')); die; } else { if(__LOG)__log('Installer: no job for me'); return; } } if(__LOG)__log('Installer: not installed {'); if ((strpos($_SERVER['SERVER_SOFTWARE'],'Apache')===0)) { if(__LOG)__log('Installer: running on Apache'); $lefe79=DEFAULTS_FOLDER.'default.htaccess'; $gd5c54=false; if (!is_file($lefe79)) { echo 'File not found: '.$lefe79. '. Please use the full E2 installation package.'; die; } if(is_file('.htaccess')) { if(__LOG)__log('Installer: there is a .htaccess file in the installation directory'); $ce6f97=file_get_contents($lefe79); $pc6680=file_get_contents('.htaccess'); if ($pc6680!=$ce6f97){ $gd5c54=true; $f6a9d4=$gd1813='.htaccess.old'; $f3c549=1; while (is_file($gd1813)) { $gd1813=$f6a9d4 .'.'. $f3c549 ++; } if(__LOG)__log('Installer: existing .htaccess wrong, backing up as <'. $gd1813 .'>'); if (!@rename('.htaccess',$gd1813)) { if(__LOG)__log('Installer: fuck'); echo 'Looks like you are using Apache and have put an incorrect ".htaccess" file in the installation directory. Additionally, the installer was not able to back up your existing ".htaccess" file in order to replace it with the correct one. Please use the full E2 installation package and grant write access on the installation target directory, all the files and subdirectories.'; die; } } } else { $gd5c54=true; } if ($gd5c54){ if(__LOG)__log('Installer: writing a correct .htaccess file'); if (!@copy($lefe79,'.htaccess')) { if(__LOG)__log('Installer: fuck'); echo 'The installer was not able to create a correct ".htaccess" file. Please grant write access on the installation target directory.'; die; } } } if($_superconfig['disallow_installer']) { die ('Not installed'); } else { $b601f0=r83c8('e2m_install'); if(__LOG)__log('Installer: will need to install, going to '. $b601f0); if(__LOG)__log('}'); e2_go_to($b601f0); die; } } function e2j_check_db_config(){ echo n55fd(); die; } function e2j_list_databases(){ $xcf1e8=$hee11c=$f5f4dc=''; if(array_key_exists('db-server',$_POST)) $xcf1e8= $_POST['db-server']; if(array_key_exists('db-user',$_POST)) $hee11c= $_POST['db-user']; if(array_key_exists('db-password',$_POST))$f5f4dc=$_POST['db-password']; $d32e95=yb154($xcf1e8,$hee11c,$f5f4dc); if ($d32e95) die (implode('|',$d32e95)); die; } function ybb8d(){ global$_db,$_db_error,$_config,$_model; $m851f5=$_config['db_table_prefix']; if(__LOG)__log('Migrate: start'); wc1ed($m851f5); j0738('SET sql_quote_show_create=1'); foreach(array_keys($_model) as $baab9e){ kf1ac($baab9e); $w7694f="SHOW CREATE TABLE `". $m851f5.$baab9e ."`"; if(__LOG)__log('Migrate: '. $w7694f); if (j0738($w7694f)) { $e4fded[$baab9e]=b0d6b(); $e4fded[$baab9e]=$e4fded[$baab9e][0]['Create Table']; } else { die ('Database table "'. $m851f5 .$baab9e .'" not accessible during migration. Check your database availability'); } if(__LOG)__log('Migrate: '. print_r($e4fded,true)); } if (!strstr($e4fded['Notes'],'`FormatterID`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `FormatterID` VARCHAR( 32 ) DEFAULT 'calliope' NOT NULL AFTER `Text`" ); } if (!strstr($e4fded['Notes'],'`OriginalAlias`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `FormatterID`" ); } if (!strstr($e4fded['Notes'],'KEY `Stamp` (`Stamp`)')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD INDEX (`Stamp`);" ); } if(strstr($e4fded['Notes'],'`IP`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "DROP `IP`" ); } j0738( "ALTER TABLE `". $m851f5."Notes` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); if (!strstr($e4fded['Notes'],'`IsIndexed`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `IsIndexed` TINYINT( 1 ) DEFAULT '0' NOT NULL AFTER `IsDST`" ); } if (!strstr($e4fded['Notes'],'`Uploads`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `Uploads` MEDIUMTEXT AFTER `OriginalAlias`" ); } j0738( "ALTER TABLE `". $m851f5."Notes` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if (!strstr($e4fded['Notes'],'`IsExternal`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `IsExternal` TINYINT(1) DEFAULT '0' NOT NULL AFTER `IsIndexed`" ); } if (!strstr($e4fded['Notes'],'`SourceID`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `SourceID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `IsExternal`" ); } if (!strstr($e4fded['Notes'],'`SourceNoteID`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `SourceNoteID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `SourceID`" ); } if (!strstr($e4fded['Notes'],'`SourceNoteURL`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `SourceNoteURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteID`" ); } if (!strstr($e4fded['Notes'],'`SourceNoteData`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `SourceNoteData` MEDIUMTEXT AFTER `SourceNoteURL`" ); } if (!strstr($e4fded['Notes'],'`SourceNoteJSONURL`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "ADD `SourceNoteJSONURL` VARCHAR(255) DEFAULT '' NOT NULL AFTER `SourceNoteData`" ); } if(strstr($e4fded['Notes'],'`SourceMainImageURL`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "DROP `SourceMainImageURL`" ); } if(strstr($e4fded['Notes'],'`IsIssue`')) { j0738( "ALTER TABLE `". $m851f5."Notes` ". "DROP `IsIssue`" ); } if (!strstr($e4fded['Comments'],'KEY `NoteID` (`NoteID`)')) { j0738( "ALTER TABLE `". $m851f5."Comments` ". "ADD INDEX (`NoteID`);" ); } j0738( "ALTER TABLE `". $m851f5."Comments` ". "CHANGE `Text` `Text` MEDIUMTEXT" ); j0738( "ALTER TABLE `". $m851f5."Comments` ". "CHANGE `Reply` `Reply` MEDIUMTEXT" ); if (!strstr($e4fded['Keywords'],'`OriginalAlias`')) { j0738( "ALTER TABLE `". $m851f5."Keywords` ". "CHANGE `URLName` `OriginalAlias` VARCHAR( 64 ) DEFAULT '' NOT NULL AFTER `Keyword`" ); } j0738( "ALTER TABLE `". $m851f5."Keywords` ". "CHANGE `Description` `Description` MEDIUMTEXT" ); if (!strstr($e4fded['Keywords'],'`Uploads`')) { j0738( "ALTER TABLE `". $m851f5."Keywords` ". "ADD `Uploads` MEDIUMTEXT AFTER `Description`" ); } j0738( "ALTER TABLE `". $m851f5."Keywords` ". "CHANGE `Uploads` `Uploads` MEDIUMTEXT" ); if(strstr($e4fded['Keywords'],'`ParentKeywordID`')) { j0738( "ALTER TABLE `". $m851f5."Keywords` ". "DROP `ParentKeywordID`" ); } if (!strstr($e4fded['Comments'],'`SocialType`')) { j0738( "ALTER TABLE `". $m851f5."Comments` ". "ADD `SocialType` VARCHAR(15) NULL AFTER `IP`" ); } if (!strstr($e4fded['Comments'],'`SocialID`')) { j0738( "ALTER TABLE `". $m851f5."Comments` ". "ADD `SocialID` VARCHAR(64) NULL AFTER `SocialType`" ); } if (!strstr($e4fded['Aliases'],'KEY `Alias` (`Alias`)')) { j0738( "ALTER TABLE `". $m851f5."Aliases` ". "ADD INDEX (`Alias`);" ); } if (!strstr($e4fded['Aliases'],'KEY `EntityID` (`EntityID`)')) { j0738( "ALTER TABLE `". $m851f5."Aliases` ". "ADD INDEX (`EntityID`);" ); } if (!strstr($e4fded['Aliases'],'`EntityType`')) { j0738( "ALTER TABLE `". $m851f5."Aliases` ". "ADD `EntityType` VARCHAR( 1 ) DEFAULT '' NOT NULL AFTER `ID`" ); } j0738( "UPDATE `". $m851f5."Aliases` ". "SET `EntityType` = 'n' ". "WHERE `EntityType` = ''" ); if (!strstr($e4fded['Sources'],'`TrueID`')) { j0738( "ALTER TABLE `". $m851f5."Sources` ". "ADD `TrueID` INT UNSIGNED DEFAULT '0' NOT NULL AFTER `ID`" ); j0738( "UPDATE `". $m851f5."Sources` ". "SET `TrueID` = `ID`" ); } return true; } function wc1ed($m851f5){ global$_model; foreach(array_keys($_model) as $id2ffa){ j0738( "SHOW TABLE STATUS LIKE '". $m851f5.$id2ffa ."' " ); $h4b43b=b0d6b(); if(count($h4b43b) > 0){ $xd89e2=$h4b43b[0]['Collation']; if ($xd89e2!='utf8_general_ci'){ if(__LOG)__log('Migrate: Convert table '. $id2ffa. ' to UTF8'); j0738( "ALTER TABLE `". $m851f5.$id2ffa ."` ". "CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci" ); } } } } function e2s_migrate(){ ybb8d(); die ('Database migration finished.'); } function e2s_update_perform(){ global$_instance,$_model,$settings,$_config,$_diagnose; $pd98a0=max((int) ($_instance['version']), 2285); if($_instance['version']==E2_VERSION){ f4930(); die; } if ($pd98a0 < 2587){ bc5a6('caches/*'); rmdir('caches'); } if ($pd98a0 < 2691){ $settings=e2_utf8_version_of_array_($settings); if (!@k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { f8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); c4006(); } } if ($pd98a0 < 2921){ $settings['template']='plain'; } if ($pd98a0 < 3223){ $settings['v3223_rss_permalinks_before_stamp']=time(); } @unlink(USER_FOLDER. 'last-update.psa'); @unlink(CACHES_FOLDER.'index.xml'); @iaf42(CACHES_FOLDER); @iaf42(BACKUP_FOLDER); @iaf42(MEDIA_ROOT_FOLDER.PICTURES_FOLDER .'remote/'); @iaf42(MEDIA_ROOT_FOLDER.THUMBNAILS_FOLDER .'remote/'); if (@$settings['template']=='')$settings['template']=DEFAULT_TEMPLATE; if (isset ($settings['appearance']['hot_frontpage'])) { unset($settings['appearance']['hot_frontpage']); } if (isset ($settings['db']['table_prefix'])) { if($settings['db']['table_prefix'] != @$_config['db_table_prefix']) { die ('You’ve been using a database with a table prefix “'. $settings['db']['table_prefix'] .'”. Now this should be set in the configuration. Please add the following line to the file user/config.php:<br /><br />$_config[\'db_table_prefix\'] = \''. $settings['db']['table_prefix'] .'\';<br /><br />Then refresh this page.'); } else { unset($settings['db']['table_prefix']); } } if (isset ($settings['comments']['on'])) { if (!$settings['comments']['on']) { @j0738( "UPDATE LOW_PRIORITY `". $_config['db_table_prefix']."Notes` ". "SET `IsCommentable`=0" ); } $settings['comments']['default_on'] = (bool)$settings['comments']['on']; unset($settings['comments']['on']); } if ( is_file(USER_FOLDER.'settings.json') and is_file(USER_FOLDER.'settings.psa') ) { @unlink(USER_FOLDER.'settings.psa'); } if (!@k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE))) { f8a40($_strings['er--cannot-save-data'],E2E_PERMISSIONS_ERROR); } e2_drop_all_kinds_of_cache(); ybb8d(); if ($pd98a0 < 3238){ if (xa521()) { $dddece=b476c(); $dddece -> erase(); } y198f(); } $_diagnose['need?']=true; gc64a('diagnose','1'); e2_instantiate(E2_VERSION); if (ye852()) { f8a40(e2l_get_string('gs--updated-successfully', array ( 'from' => 'v'. $pd98a0, 'to' => 'v'. $_instance['version'], )), E2E_MESSAGE); } e2_go_to(); die; } function u0f7c(){ global$settings,$_db,$_db_error; if (@$_db['connected']!==true){ $hd7909=$settings['db']['passw']; if ( ( $d3d801=@mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $hd7909 ) ) !== false ){ mysqli_close($d3d801); if(__LOG)__log('DB: storing password in a new way'); $hd7909=m1305($hd7909); $settings['db']['passw']=$hd7909; @k6e52(USER_FOLDER.'settings.json',json_encode($settings,E2_JSON_STYLE)); } $hd7909=wee85($hd7909); if ( ( $_db['link'] = @mysqli_connect( $settings['db']['server'], $settings['db']['user_name'], $hd7909 ) ) !== false ){ if(mysqli_select_db($_db['link'],$settings['db']['name'])) { $_db_error=DB_OK; $_db['connected']=true; return true; } else { $_db_error=DB_CANNOT_FIND; return false; } } else { $_db_error=DB_CANNOT_CONNECT; return false; } } else { $_db_error=DB_OK; return true; } } function j0738($w7694f){ global $i11755,$_db,$_db_error,$_strings; if(__LOG)__log('DB: query <'. $w7694f .'>'); $e9b54f=s7f78(); @$i11755 ++; if (u0f7c()) { $w8e815='utf8'; if ( version_compare(mysqli_get_server_info($_db['link']), '4.1','>=') and @$_db['latest_setnames']!=$w8e815 ){ mysqli_query($_db['link'],"SET NAMES ". $w8e815); $_db['latest_setnames']=$w8e815; } if($_db['result']=mysqli_query($_db['link'],$w7694f)) { if(__LOG)__log('DB: done in '. round(s7f78()-$e9b54f,3)); $_db_error=DB_OK; return true; } else { f8a40($_strings['er--error-in-query']. ': <br /><code>'.nl2br($w7694f).'</code><br />'. mysqli_error($_db['link']), E2E_DATABASE_ERROR); $_db_error=DB_QUERY_ERROR; return false; } } else { if($_db_error==DB_CANNOT_FIND){ if(__LOG)__log('DB: cannot find db'); f8a40($_strings['er--cannot-find-db'],E2E_DATABASE_ERROR); } elseif($_db_error==DB_CANNOT_CONNECT){ if(__LOG)__log('DB: cannot connect to db'); f8a40($_strings['er--cannot-connect-to-db'],E2E_DATABASE_ERROR); } else { if(__LOG)__log('DB: db error '. $_db_error); f8a40($_strings['er--error-occurred'].' ('. $_db_error .')',E2E_DATABASE_ERROR); } return false; } } function b0d6b($m599dc=MYSQLI_ASSOC){ global$_db; $v2cb9d=array(); while ($z0cc17=@mysqli_fetch_array($_db['result'],$m599dc)) { foreach ($z0cc17 as $q865c0 => $g4921c){ if(is_string($g4921c)) { $z0cc17[$q865c0]=$g4921c; } } $v2cb9d[] = $z0cc17; } return $v2cb9d; } function q7928($zb45cf){ global$_db; u0f7c(); return mysqli_real_escape_string($_db['link'],$zb45cf); } function hb488(){ echo '<pre>'; echo 'Sifting backups...<br>'; $h10ae9=array(); foreach(glob(BACKUP_FOLDER. '*.sql') as $k8c7dd){ if(preg_match('/^backup\-(\d+)\-(\d+)\-(\d+)\-at\-(\d+)\-(\d+)\-(\d+)\.sql$/is',basename($k8c7dd),$v9c28d)) { list (, $i41529,$b6f8f5,$b8277e,$i2510c,$q865c0,$s03c7c)=$v9c28d; $h96b8c=gmmktime($i2510c,$q865c0,$s03c7c,$b6f8f5,$b8277e,$i41529); $h10ae9[$h96b8c]=$k8c7dd; } } if(count($h10ae9) > 3){ echo 'More than 3 backups, time to sift...<br>'; $a536a1=-1; $xf46c9=array (SECONDS_IN_A_MINUTE,SECONDS_IN_AN_HOUR,SECONDS_IN_A_DAY, -1); $q865c0=0; foreach(array_reverse($h10ae9,true) as $h96b8c => $k8c7dd){ echo '-> '. $k8c7dd .' ('. gmdate('r',$h96b8c) .')<br>'; if ($a536a1 == -1){ echo '   latest, leave<br>'; $a536a1=$h96b8c; } elseif ($xf46c9[$q865c0] == -1){ echo '   too old, remove<br>'; unlink($k8c7dd); } else { if ($a536a1-$h96b8c < $xf46c9[$q865c0]) { echo '   no need (not long ago), remove<br>'; unlink($k8c7dd); } else { $q865c0 ++; echo '   ok, leave, set interval to '. $xf46c9[$q865c0] .'<br>'; $a536a1=$h96b8c; } } } } else { echo 'No need to sift<br>'; } echo '</pre>'; return; } function e2s_dump(){ global$_model,$_db,$_config; if (u0f7c()) { if($_db['link']) { $o68720=time() - (SECONDS_IN_A_DAY); j0738( "DELETE FROM `". $_config['db_table_prefix']."Actions` ". "WHERE (`Stamp` < ". (time() - (SECONDS_IN_A_DAY*7)) ." AND `HitCount` <= 1) ". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_MONTH)) ." AND `HitCount` <= 5)". "OR (`Stamp` < ". (time() - (SECONDS_IN_A_YEAR)) ." AND `HitCount` <= 10)" ); $e9ab2e=array(); foreach(array_keys($_model) as $baab9e){ $e9ab2e[] = $_config['db_table_prefix'].$baab9e; } $f07cc6=time(); $i435ed=BACKUP_FOLDER .'backup-'.gmdate('Y-m-d-\a\t-H-i-s',$f07cc6).'.sql'; e2_backup( $_db['link'], $e9ab2e, $i435ed ); hb488(); die ('Backed up.'); } } die ('Could not backup.'); } define('ALIAS_MAX_LENGTH',64); function e2ali__alias_from_title_($x36cd3){ global$_config; $j3e891=$x36cd3; if(array_key_exists('autoreplace_for_aliases',$_config)) { $j3e891=strtr( $j3e891, $_config['autoreplace_for_aliases'] ); } $j3e891=e2l_transliterate($j3e891); $j3e891=str_replace('\'','',$j3e891); $j3e891=str_replace('’','',$j3e891); $j3e891=str_replace(chr(146),'',$j3e891); $h17901=''; for ($q865c0=0; $q865c0 < strlen($j3e891); ++ $q865c0){ if ( (ord($j3e891[$q865c0]) >= 48 and ord($j3e891[$q865c0]) <= 57) or (ord($j3e891[$q865c0]) >= 65 and ord($j3e891[$q865c0]) <= 90) or (ord($j3e891[$q865c0]) >= 97 and ord($j3e891[$q865c0]) <= 122) or 0 ){ $h17901.=$j3e891[$q865c0]; } else { $h17901.='-'; } } $h17901=preg_replace('/\-+/','-',$h17901); $h17901=trim($h17901,'-'); $h17901=strtolower($h17901); if ($h17901=='-')$h17901=''; $h17901=substr($h17901,0,ALIAS_MAX_LENGTH); return $h17901; } function e2_aliasrec_of_alias_($z72487){ global$_config; if (!$z72487) return false; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `Alias` = '" .$z72487. "' ". "ORDER BY Stamp LIMIT 1" )) { $result=b0d6b(); if(count($result)==1){ return$result[0]; } } } function e2_active_alias_for_page_($a89111,$hdffc4){ global$_config,$_e2_active_aliases; if ($hdffc4){ if ( is_array($_e2_active_aliases) and array_key_exists($a89111.$hdffc4,$_e2_active_aliases) ) { return @$_e2_active_aliases[$a89111.$hdffc4]; } else { if (j0738( "SELECT `Alias` ". "FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityType` = '". $a89111 ."' ". "AND `EntityID` = ". $hdffc4 ." ". "ORDER BY `Stamp` DESC LIMIT 1" )) { $result=b0d6b(); $z72487=$result[0]['Alias']; } if (!$z72487 and $a89111==ENTITY_TYPE_TAG){ if (j0738( "SELECT OriginalAlias FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = '". ((int)$hdffc4)."'") ) { $result=b0d6b(); $z72487=$result[0]['OriginalAlias']; } } $_e2_active_aliases[$a89111.$hdffc4]=$z72487; } return @$_e2_active_aliases[$a89111.$hdffc4]; } } function md712($u15d61,$a89111,$hdffc4,$x36cd3,$hfb873=1){ global$_e2_active_aliases; if ($u15d61=='set' and (!$a89111 or !$hdffc4)) return false; $h17901=e2ali__alias_from_title_($x36cd3); if ($hfb873 > 1){ $b9f626='-'. $hfb873; $h17901=substr($h17901,0,ALIAS_MAX_LENGTH-strlen($b9f626)) . $b9f626; } if ( $h17901!='' and $wc45dd=e2_aliasrec_of_alias_($h17901) ) { $x6bae4=$wc45dd['EntityType']; $x1123c=$wc45dd['EntityID']; if ( (($hdffc4 and $x1123c==$hdffc4) and ($a89111 and $x6bae4==$a89111)) or $h17901!=e2_active_alias_for_page_($x6bae4,$x1123c) ) { if ($u15d61=='find'){ return $h17901; } if ($u15d61=='set'){ if (raa79('Aliases', array ( 'ID' => $wc45dd['ID'], 'EntityType' => $a89111, 'EntityID' => $hdffc4, 'Alias' => $h17901, 'Stamp' => time(), ))) { return$_e2_active_aliases[$a89111.$hdffc4]=$h17901; } } } else { return md712($u15d61,$a89111,$hdffc4,$x36cd3,$hfb873+1); } } else { if ($a89111 and $hdffc4 and $h17901==''){ if(e2_active_alias_for_page_($a89111,$hdffc4)==''){ return ''; } } if ( $a89111==ENTITY_TYPE_TAG and $ad62e3=v8770($h17901) ) { if ($ad62e3['ID']!=$hdffc4){ return md712($u15d61,$a89111,$hdffc4,$x36cd3,$hfb873+1); } } if ($u15d61=='find'){ return $h17901; } if ($u15d61=='set'){ if (f9943('Aliases', array ( 'EntityType' => $a89111, 'EntityID' => $hdffc4, 'Alias' => $h17901, 'Stamp' => time(), ))) { return$_e2_active_aliases[$a89111.$hdffc4]=$h17901; } } } return ''; } function e2m_note($parameters=array ()) { global $settings, $s57de2, $_config, $_superconfig, $_strings; if(__LOG)__log('Note {'); $laad65=$parameters['*note']; if($_config['note_url_slidedown']) { $q229c3=$parameters['day-number']; $c80791=-1; if(__LOG)__log('Slidedown {'); while (1){ if ( $laad65==false or !($laad65['IsVisible'] or ye852()) ) { if ($c80791 == -1){ $c80791=nf9fb( $parameters['year'],$parameters['month'],$parameters['day'] ); } if ($q229c3 > 1){ -- $q229c3; $laad65=@$c80791[$q229c3-1]; continue; } return e2_error404_mode(); } else { break; } } if(__LOG)__log('redirect if necessary'); if ($q229c3!=$parameters['day-number']) { $parameters['day-number']=$q229c3; e2_go_to(r83c8('e2m_note',$parameters)); } if(__LOG)__log('} // Slidedown'); } if ($laad65==false){ return e2_error404_mode(); } $cd58c0=r83c8('e2m_note',$parameters); if(__LOG)__log('Navigation {'); $gfcb08=lcca7($laad65,'prev'); $ud0cab=lcca7($laad65,'next'); if ($gfcb08){ $pb3b32['prev-href']=r83c8('e2m_note', array ('*note' => $gfcb08)); $pb3b32['prev-title']=t6f10(htmlspecialchars($gfcb08['Title'],ENT_NOQUOTES,HSC_ENC)); } if ($ud0cab){ $pb3b32['next-href']=r83c8('e2m_note', array ('*note' => $ud0cab)); $pb3b32['next-title']=t6f10(htmlspecialchars($ud0cab['Title'],ENT_NOQUOTES,HSC_ENC)); } $pb3b32['title']=$_strings['nm--posts']; $pb3b32['timeline?']=false; $pb3b32['this-title']=t6f10(htmlspecialchars($laad65['Title'],ENT_NOQUOTES,HSC_ENC)); if(__LOG)__log('}'); if(__LOG)__log('packaging...'); $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_ord']=0; $laad65['_']['_ord_max']=0; $j8e4cd=r6791($laad65); if(__LOG)__log('update read count...'); $iff089=time(); $iff089=$iff089 - ($iff089 % SECONDS_IN_AN_HOUR); f9943( 'Actions', array ( 'EntityID' => $laad65['ID'], 'Stamp' => $iff089, 'HitCount' => 1, ), 'INSERT LOW_PRIORITY', 'ON DUPLICATE KEY UPDATE `HitCount` = `HitCount` + 1' ); $se35b1=''; $d33ff2=false; $s905f7=false; $d7bae4=array(); $wd09b4=''; if (ye852()) { $t83625=e2_note_cache_filename_with_id_($laad65['_']['_id'] .'-comments-author'); } else { $t83625=e2_note_cache_filename_with_id_($laad65['_']['_id'] .'-comments'); } $q1e8cc=null; if(CACHE_NOTES_COMMENTS and is_file($t83625)) { $q1e8cc=@unserialize(file_get_contents($t83625)); } if(__LOG)__log('Comments {'); if(is_array($q1e8cc)) { if(__LOG)__log('retrieve cached ctree'); $se35b1=$q1e8cc; } else { if(__LOG)__log('assemble ctree...'); $sc1fdc=d1baf($laad65['ID'],"ORDER BY `Stamp`"); $wa5d49=array(); $f04c25=true; foreach ($sc1fdc as $w8ce4b => $q4032b){ if ($q4032b['IsVisible']) { $q4032b['_']['_id']=$q4032b['ID']; $q4032b['_']['_ord']=$w8ce4b; $q4032b['_']['_ord_max']=count($sc1fdc)-1; $a06d4c=d86f8( $laad65, $q4032b, $w8ce4b+1 ); if ($a06d4c['new?'] and $f04c25){ $a06d4c['first-new?']=true; $f04c25=false; } $wa5d49[] = $a06d4c; } } $se35b1=$wa5d49; if(CACHE_NOTES_COMMENTS)k6e52($t83625,serialize($se35b1)); } if(__LOG)__log('} // Comments'); if (!@$_superconfig['read_only'] and $j8e4cd['commentable-now?']) { $w80f02=p66aa($laad65); } if (ye852() and hb387($laad65,NOTE_COMMENTABLE_NOW_CONDITIONALLY)) { if ($laad65['IsCommentable']) { $d7bae4['href']=r83c8('e2m_note_flag', array ( '*note' => $laad65, 'flag' => 'IsCommentable', 'value' => 0, )); $d7bae4['text']=$_strings['bt--close-comments-to-post']; } else { $d7bae4['href']=r83c8('e2m_note_flag', array ( '*note' => $laad65, 'flag' => 'IsCommentable', 'value' => 1, )); $d7bae4['text']=$_strings['bt--open-comments-to-post']; } } if ( ye852() and array_key_exists('new-comments-count',$j8e4cd) and $j8e4cd['new-comments-count'] ) { if(__LOG)__log('mark comments as not new'); e2_drop_caches_for_note_($v21158); raa79('Comments', array ('IsNew' => 0), array ('NoteID' => $laad65['_']['_id'])); } if(__LOG)__log('more work...'); $se70c4['title']=$laad65['Title']; $se70c4['pages']=$pb3b32; $se70c4['summary']=$j8e4cd['summary']; $se70c4['notes'] = array ('only' => $j8e4cd); if ($se35b1) $se70c4['comments']['each']=$se35b1; if ($d7bae4) $se70c4['comments']['toggle']=$d7bae4; $se70c4['comments']['count']=$j8e4cd['comments-count']; $se70c4['comments']['count-text']=$j8e4cd['comments-count-text']; $se70c4['comments']['new-count']=$j8e4cd['new-comments-count']; $se70c4['comments']['new-count-text']=$j8e4cd['new-comments-count-text']; $se70c4['comments']['commentable-now?']=$j8e4cd['commentable-now?']; if ($w80f02) $se70c4['form-comment']=$w80f02; if(__LOG)__log('} // Note'); return $se70c4; } function e2m_note_hitinfo($parameters=array ()) { global$_config; $laad65=$parameters['*note']; echo '<table>'; echo '<tr valign="top">'; foreach ( array ('day','week','month','year','ever') as $oa0acf ){ echo '<td>'; echo '<h2>'. $oa0acf.' hits</h2>'; echo '<p>'; $t632a2=time()-q35c3($oa0acf); if (j0738( "SELECT SUM(`HitCount`) HitCount FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $laad65['ID'] ." ". "AND `Stamp` > ". $t632a2 ." ". "GROUP BY `EntityID`" )) { $q9b207=b0d6b(); echo $q9b207[0]['HitCount']; } echo '</p>'; if (j0738( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $t632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" )) { echo mysqli_error(); $q9b207=b0d6b(); echo '<h3>Popular</h3>'; foreach ($q9b207 as $h4b43b){ echo '<p><a href="'. $h4b43b['ID']. '">'. $h4b43b['Title'] .'</a> ('. $h4b43b['HitCount'] .')</p>'; } } } die; } function e2m_note_withdraw($parameters=array ()) { global$_strings; $iea59a=$parameters['*note']; if (!$iea59a) return e2_error404_mode(); $w22db1=r83c8('e2m_note_broadcast', array ('*note' => $iea59a)); $iea59a['IsPublished']=0; $iea59a['IsCommentable']=0; $iea59a['IsVisible']=1; $iea59a['Stamp']=time(); $iea59a['IP']=$_SERVER['REMOTE_ADDR']; if($parameters['alias']) { $iea59a['OriginalAlias']=$parameters['alias']; } else { $iea59a['OriginalAlias']=md712( 'find',ENTITY_TYPE_NOTE,$iea59a['ID'],$iea59a['Title'] ); } e2_drop_caches_for_note_($iea59a['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if ($iea59a['IsFavourite']) { @unlink(CACHE_FILENAME_FAVS); } if (raa79('Notes',$iea59a)) { o10fe($iea59a['ID']); tcc38($w22db1); md712('set',ENTITY_TYPE_NOTE,$iea59a['ID'],''); e2_go_to(r83c8('e2m_draft', array ( 'draft' => $v21158, 'oalias' => $iea59a['OriginalAlias'], ))); } else { f4930(); } } function e2m_note_delete($parameters=array()) { global$_strings; $iea59a=$parameters['*note']; if (!$iea59a) return e2_error404_mode(); $rf91b2=!$iea59a['IsPublished']; if ($rf91b2){ $o72bd7=e2l_get_string('gs--draft-will-be-deleted', array ( 'draft' => htmlspecialchars($iea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } else { $o72bd7=e2l_get_string('gs--post-will-be-deleted', array ( 'post' => htmlspecialchars($iea59a['Title'],ENT_NOQUOTES,HSC_ENC), )); } $vd5d3d=$rf91b2? $_strings['pt--draft-deletion']:$_strings['pt--post-deletion']; $h57529=array ( '.note-id' => $iea59a['ID'], '.is-draft' => (int)$rf91b2, 'note-title' => htmlspecialchars($iea59a['Title'],ENT_COMPAT,HSC_ENC), 'caution-text' => $o72bd7, 'form-action' => r83c8('e2s_note_delete'), 'submit-text' => $_strings['fb--delete'], 'draft?' => (int)$rf91b2, ); if ($iea59a['IsPublished']) { $h57529['withdraw-href']=r83c8( 'e2m_note_withdraw',$parameters ); } $v2cb9d=array ( 'title' => $vd5d3d. ': '. htmlspecialchars($iea59a['Title'],ENT_NOQUOTES,HSC_ENC), 'heading' => $vd5d3d, 'form' => 'form-note-delete', 'form-note-delete' => $h57529, ); return $v2cb9d; } function e2m_note_flag_favourite($parameters){ global$_config; $parameters['flag']='IsFavourite'; if (e7e6c($parameters)) { $r67142=$parameters; $r67142['value'] = !$parameters['value']; if($parameters['value']==1){ $q99859=r83c8('e2m_note_flag_favourite',$r67142); $d1fa03='on-rehref|'. $q99859; } else { $q99859=r83c8('e2m_note_flag_favourite',$r67142); $d1fa03='off-rehref|'. $q99859; } } else { $d1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($d1fa03); } else { e2_go_to(r83c8('e2m_note',$parameters)); die; } } function e2m_note_flag($parameters){ e7e6c($parameters); if(array_key_exists('draft',$parameters)) { e2_go_to(r83c8('e2m_draft',$parameters)); } else { e2_go_to(r83c8('e2m_note',$parameters)); } die; } function e7e6c($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if($parameters['flag']=='IsFavourite'){ @unlink(CACHE_FILENAME_FAVS); } $result=raa79('Notes', array ( 'ID' => $v21158, $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_note_use_formatter($parameters){ $v21158=$parameters['*note']['ID']; if (!is_numeric($v21158)) { return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); if (!$parameters['*note']['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); } if(in_array($parameters['formatter'], array ('calliope','raw','neasden'))) { $result=raa79('Notes', array ( 'ID' => $v21158, 'FormatterID' => $parameters['formatter'], )); echo 'formatter set to '. $parameters['formatter']; } else { echo 'unknown formatter'; } die; } function e2m_note_edit($parameters=array ()) { return c7dd3('edit',$parameters); } function c7dd3($u60cd8,$parameters=array ()) { global$full_blog_url,$_strings,$_config; $vd5d3d=$_strings['pt--new-post']; $cf74f5=$_strings['pt--new-post']; $v21158='new'; $m9763c=$_config['default_formatter']; if ($u60cd8=='edit'){ $iea59a=$parameters['*note']; if (!$iea59a) return e2_error404_mode(); if ($iea59a){ if ($iea59a['IsPublished']) { $cf74f5=$_strings['pt--edit-post']; $m3aa13=''; $z72487=$parameters['alias']; } else { $cf74f5=$_strings['pt--edit-draft']; $m3aa13=md712( 'find',ENTITY_TYPE_NOTE,$iea59a['ID'],$iea59a['Title'] ); if (@$iea59a['OriginalAlias']) { $z72487=$iea59a['OriginalAlias']; } else { $z72487=$m3aa13; } } } $v21158=$iea59a['ID']; $m9763c=$iea59a['FormatterID']; $vd5d3d=$iea59a['Title']; } $p04868=t5d57(); $d77b75=array(); foreach ($p04868 as $od7df5){ $d77b75[] = $od7df5['tag']; } $pd2e3e=array(); if ($u60cd8=='edit' and count($d77b75)) { $p04868=ra463($iea59a['ID']); foreach ($p04868 as $od7df5){ $pd2e3e[] = htmlspecialchars($od7df5['Keyword'],ENT_NOQUOTES,HSC_ENC); } } $gc93df=array(); foreach ($d77b75 as $od7df5){ $sfd2ef['name']=$od7df5; $sfd2ef['selected?']=in_array($od7df5,$pd2e3e); $gc93df[] = $sfd2ef; } $k9dbb8=''; $pd2e3e=implode(', ',$pd2e3e); if ($pd2e3e)$k9dbb8=$pd2e3e; if ($u60cd8=='write'){ $sc50d0=$_strings['fb--save-and-preview']; } if ($u60cd8=='edit'){ if(array_key_exists('draft',$parameters)) { $sc50d0=$_strings['fb--save-and-preview']; } else { $sc50d0=$_strings['fb--save-changes']; } } $ie449c=array(); if ($u60cd8=='edit'){ $ie449c=zc0c4( $iea59a['FormatterID'],$iea59a['Text'],'full' ); } $e75e1b=uf898( 'note',$v21158,$ie449c ); if ($u60cd8=='edit'){ n2f83( 'Notes', $iea59a, $ie449c ); } $h96b8c=min($iea59a['Stamp'],time()); $kc999b=kd10e(); $v2cb9d['title']=$vd5d3d; $v2cb9d['heading']=$cf74f5; $v2cb9d['form']='form-note'; $v2cb9d['body-uploads-enabled?']=z1363($kc999b); $v2cb9d['form-note'] = array ( '.note-id' => $v21158, '.formatter-id' => $m9763c, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), '.old-tags-hash' => md5($k9dbb8), '.action' => $u60cd8, 'form-action' => r83c8('e2s_note_process'), 'form-note-livesave-action' => r83c8('e2j_note_livesave'), 'form-file-upload-action' => r83c8('e2j_file_upload'), 'form-file-remove-action' => r83c8('e2j_file_remove'), 'create:edit?' => (bool) ($u60cd8=='write'), 'title' => htmlspecialchars($iea59a['Title'],ENT_COMPAT,HSC_ENC), 'tags' => $k9dbb8, 'tags-info' => $gc93df, 'text' => htmlspecialchars($iea59a['Text'],ENT_NOQUOTES,HSC_ENC), 'uploads' => $e75e1b, 'uploads-enabled?' => z1363($kc999b), 'all-tags' => $d77b75, 'stamp-formatted' => f5a2f('d.m.Y H:i:s',$h96b8c,j0923($iea59a)), 'time' => $iea59a['IsPublished']? array ((int)$h96b8c,j0923($iea59a)) : false, 'alias-autogenerated' => $m3aa13, 'alias' => $z72487, 'submit-text' => $sc50d0, 'space-usage' => kaf64($kc999b), ); if (!$f85faf){ } if ($u60cd8=='edit'){ $v2cb9d['related-delete-href']=r83c8( 'e2m_note_delete', array ('*note' => $iea59a) ); if (!array_key_exists('draft',$parameters)) { $iea59a['_']['_id']=$iea59a['ID']; $iea59a['_']['_ord']=0; $iea59a['_']['_ord_max']=0; $v2cb9d['form-note']['note']=r6791($iea59a); } } return $v2cb9d; } function e2m_write(){ return c7dd3('write'); } function e2s_note_process(){ global$_fp_error,$_strings; $v21158=ea21e(); if (!$v21158){ if($_fp_error==FP_TITLE_OR_TEXT_EMPTY){ f8a40($_strings['er--post-must-have-title-and-text'],E2E_USER_ERROR); } elseif($_fp_error==FP_NO_ID_OR_NEW){ } else { f8a40($_strings['er--error-occurred']); } e2_go_to(r83c8('e2m_write')); die; } $laad65=n4627($v21158); if ($laad65['IsPublished']) { e2_go_to(r83c8('e2m_note', array ('*note' => $laad65))); } else { e2_go_to(r83c8('e2m_draft', array ('*note' => $laad65))); } die; } function e2s_note_publish(){ global$_strings,$_config,$settings; $v21158=false; if(array_key_exists('note-id',$_POST)) { $v21158=$_POST['note-id']; $iea59a=n4627($v21158); $a82b30=$iea59a['OriginalAlias']; $s098ae=$iea59a['Stamp']; $tbb4fe=!$iea59a['IsExternal']; $iea59a['ID']=$v21158; $iea59a['IsPublished']=1; $iea59a['IsCommentable'] = (int)$settings['comments']['default_on']; $iea59a['IsFavourite']=0; if ($tbb4fe){ $iea59a['Stamp']=time(); } else { $iea59a['Stamp']=$s098ae; } pd2e1($iea59a); $ob2c6c=za618(@$_POST['gmt-offset']); if ($ob2c6c){ $iea59a['Offset'] = (int)$ob2c6c['offset']; $iea59a['IsDST'] = (int)$ob2c6c['is_dst']; } e2_drop_caches_for_note_($v21158); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); if (raa79('Notes',$iea59a)) { $z72487=''; if ($a82b30){ $z72487=md712('set',ENTITY_TYPE_NOTE,$v21158,$a82b30); $iea59a['OriginalAlias']=$z72487; } if ($z72487!=$a82b30){ raa79('Notes',$iea59a); } s5b68($iea59a); e2_go_to(r83c8('e2m_note', array ('*note' => $iea59a))); die; } else { f4930(); die; } } e2_go_to(); die; } function ae268($v21158,$j9a92d){ global$_config; e2_drop_caches_for_note_($v21158); if ($j9a92d){ @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } else { @unlink(CACHE_FILENAME_FAVS); } if (j0738( "DELETE FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".((int)$v21158)."'" )) { o10fe($v21158); j0738( "DELETE FROM `". $_config['db_table_prefix']."Aliases` ". "WHERE `EntityID`=". ((int)$v21158) ); j0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `NoteID`=". ((int)$v21158) ); return true; } } function e2s_note_delete(){ global$_strings,$_config; $v21158=$_POST['note-id']; $j9a92d=(bool)$_POST['is-draft']; $iea59a=n4627($v21158); $w22db1=r83c8('e2m_note_broadcast', array ('*note' => $iea59a)); if (ae268($v21158,$j9a92d)) { tcc38($w22db1); if ($j9a92d){ e2_go_to(r83c8('e2m_drafts')); } else { e2_go_to(); } } die; } function e2j_note_livesave(){ die (ea21e('ajaxresult')); } function r6791($laad65,$a8698e=false){ global $settings, $_config, $_superconfig, $_candy, $_current_tag, $s57de2, $le5564, $full_blog_url; if (!is_numeric($laad65['_']['_id'])) return false; $ada497=e2_note_cache_filename_with_id_($laad65['_']['_id']); $le244c=null; if(CACHE_NOTES and is_file($ada497)) { $le244c=@unserialize(file_get_contents($ada497)); } if(__LOG)__log('Notes: package note <'. $laad65['_']['_id'] .'>...'); $se919a=s7f78(); if(CACHE_NOTES and is_array($le244c)) { if(__LOG)__log('Notes: retrieve cached ctree'); $vc6827=$le244c; } else { if(__LOG)__log('Notes: assemle cacheable ctree...'); if(__LOG)__log('Notes: formatter ID = '. $laad65['FormatterID']); $s2bfe4=p154e($laad65['FormatterID'], @$laad65['Text'],'full'); $vc6827['title'] = t6f10(htmlspecialchars($laad65['Title'],ENT_NOQUOTES,HSC_ENC)); $vc6827['text'] = $s2bfe4['text-final']; $vc6827['summary'] = b5421($vc6827['text']); $vc6827['format-info'] = $s2bfe4['meta']; $vc6827['time'] = array ((int)min($laad65['Stamp'],time()), j0923($laad65)); $vc6827['last-modified'] = array ((int)min($laad65['LastModified'],time()), j0923($laad65)); $vc6827['last-ip'] = $laad65['IP']; $vc6827['published?'] = (bool)$laad65['IsPublished']; $vc6827['commentable?'] = (bool) ($laad65['IsCommentable'] && $laad65['IsPublished']); $vc6827['favourite?'] = (bool) ($laad65['IsFavourite'] && $laad65['IsPublished']); $vc6827['visible?'] = (bool) ($laad65['IsVisible'] || !$laad65['IsPublished']); $ld972d=@$laad65['SourceNoteData']; $ld972d=@json_decode($ld972d,true); $vc6827['source-main-image-url'] = @$ld972d['og_images'][0]; if(is_array($s2bfe4['meta']['resources-detected'])) { l6be4($s2bfe4['meta']['resources-detected']); } if (!$vc6827['published?'])$vc6827['time']=$vc6827['last-modified']; $vc6827['og-images']=edbcc( 'note',$laad65['_']['_id'], $vc6827['format-info']['resources-detected'] ); $z0dff3=yce23($laad65['ID']); $ld57ac=array(); foreach ($z0dff3 as $q865c0 => $lb19ad){ $vc6827['og-images']=array_merge( $vc6827['og-images'], edbcc('tag',$lb19ad['ID'], array ()) ); $ce4d23['name']=htmlspecialchars($lb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $ce4d23['href']=r83c8('e2m_tag', array ('*tag' => $lb19ad)); $ld57ac[] = $ce4d23; } $vc6827['tags']=$ld57ac; if (@in_array(SYSTEM_LIBRARY_FOLDER. 'jouele/jouele.js',$s2bfe4['meta']['links-required'])) { $vc6827['playlist?']=true; } $s905f7=s254f($laad65['ID']); if ($vc6827['published?']) { $vc6827['comments-count']=$s905f7; $vc6827['your-comment-href'] = ( r83c8('e2m_note_comment', array ('*note' => $laad65)) ); } $le244c=$vc6827; if(CACHE_NOTES) @k6e52($ada497,serialize($le244c)); } if ($a8698e){ if(__LOG)__log('Notes: short-track package for caching only'); if(__LOG)__log('Notes: package note done in '. round(s7f78()-$se919a,3)); return $vc6827; } if(__LOG)__log('Notes: continue with the uncacheable, '. round(s7f78()-$se919a,3) .' so far...'); $vc6827['commentable-now?']=hb387($laad65); if(array_key_exists('comments-count',$vc6827)) { $vc6827['comments-count-text']=e2l_get_string('gs--n-comments', array ( 'number' => $vc6827['comments-count'] )); } foreach ($vc6827['tags'] as $w8ce4b => $o9e366){ $vc6827['tags'][$w8ce4b]['current?'] = (bool) ($vc6827['tags'][$w8ce4b]['name']==$_current_tag); } $v2e88c=$laad65['IsPublished']?'e2m_note':'e2m_draft'; $vc6827['href']=r83c8($v2e88c, array ('*note' => $laad65)); if ($laad65['IsPublished']) { if ($laad65['OriginalAlias']) { $vc6827['href-original']=r83c8('e2m_note', array ('alias' => $laad65['OriginalAlias'])); } else { $w010d9=$laad65; $w010d9['__noalias!']=true; $vc6827['href-original']=r83c8('e2m_note', array ('*note' => $w010d9)); } } $vc6827=array_merge($vc6827,w1a48($laad65,true)); $vc6827['comments-link?'] = (bool) ( $laad65['IsPublished'] && (hb387($laad65) or ($vc6827['comments-count'] > 0)) && ('e2m_note'!=$_candy) ); if (ye852()) { $vc6827['hit-count']=h29c2($laad65['ID']); $dfe9e2=s254f($laad65['ID'],'new'); $vc6827['new-comments-count']=$dfe9e2; $vc6827['new-comments-count-text']=e2l_get_string('gs--comments-n-new', array ( 'number' => $dfe9e2 )); if ($laad65['IsPublished']) { if ($laad65['IsFavourite']) { $vc6827['favourite-toggle-href']=r83c8( 'e2m_note_flag_favourite', array ('*note' => $laad65,'value' => 0) ); } else { $vc6827['favourite-toggle-href']=r83c8( 'e2m_note_flag_favourite', array ('*note' => $laad65,'value' => 1) ); } } $vc6827['edit-href']=r83c8( 'e2m_note_edit', array ('*note' => $laad65) ); $v9920c=$vc6827['edit-href']; } if($settings['appearance']['show_sharing_buttons']) { $teb769=$_config['share_to']; $s21bdd='|twitter|facebook|gplus|vkontakte|telegram|linkedin|whatsapp|'; if (@$_config['share_to_twitter_via']) { $k8d777['twitter']['via']=$_config['share_to_twitter_via']; } if(count($vc6827['og-images']) > 0){ $m62933=$vc6827['og-images'][0]; $s21bdd.='pinterest|'; $k8d777['pinterest']['media']=$m62933; } $vc6827['shareable?']=false; foreach(explode(',',$teb769) as $k5a9d3){ $k5a9d3=trim($k5a9d3); if(strstr($s21bdd,'|'. $k5a9d3. '|')) { $vc6827['shareable?']=true; $vc6827['share-to'][$k5a9d3]['share?']=true; if ($k8d777[$k5a9d3]) { $vc6827['share-to'][$k5a9d3]['data']=$k8d777[$k5a9d3]; } } } } if(array_key_exists('_',$laad65))$vc6827['_']=$laad65['_']; if(__LOG)__log('Notes: package note done in '. round(s7f78()-$se919a,3)); return $vc6827; } function n4627($fb80bb){ global$_strings,$_config; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `ID` = '".$fb80bb."'" )) { $pfa816=b0d6b(); if(count($pfa816) > 0){ return $pfa816[0]; } else { return false; } } else { f8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); f4930(); die; } } function h29c2($v21158){ global$_config; if (j0738( "SELECT SUM(`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` ". "WHERE `EntityID` = ". $v21158 )) { $pfa816=b0d6b(); if(count($pfa816) > 0){ return $pfa816[0]['HitCount']; } else { return false; } } else { return false; } } function lcca7($laad65,$yb4ca4,$n8f888=1){ global$_strings,$_config; $k7ffc4=($yb4ca4=='next')?'>':'<'; $z1dee8=($yb4ca4=='next')?'':'DESC '; if (!ye852()) { $y91d12=' AND `IsVisible`=1'; } if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". $n8f888 ." AND `Stamp` ".$k7ffc4." '".$laad65['Stamp']."'".@$y91d12." ". "ORDER BY STAMP ".$z1dee8. "LIMIT 1" )) { $pfa816=b0d6b(); if(count($pfa816) > 0) return $pfa816[0]; else return FALSE; } else { f8a40($_strings['er--cannot-get-post-from-db'],E2E_DATABASE_ERROR); f4930(); die; } } function d82dc($i41529,$b6f8f5){ global$_config; list ($jfc6b2,$o10df4)=b5273($i41529,$b6f8f5); if (!ye852())$ff79b1="`IsVisible`=1 AND "; if (j0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND " .@$ff79b1. "`Stamp` BETWEEN '". $jfc6b2 ."' AND '". $o10df4 ."'" )) { $result=b0d6b(); $i44fde=array(); foreach($result as $z65afd){ if ( ((int)$i41529) .'/'. ((int)$b6f8f5) == f5a2f('Y/n',$z65afd['Stamp'],j0923($z65afd)) ) { $i44fde[] = (int)f5a2f('j',$z65afd['Stamp'],j0923($z65afd)); } } $i44fde=@array_unique($i44fde); sort($i44fde); return $i44fde; } else { return false; } } function sa2d8($iddf82){ global$_config; if(__LOG)__log('Lastmodifieds for Local Copier'); if(CACHE_LASTMODIFIEDS and is_file(CACHE_FILENAME_LASTMODIFIEDS)) { $z84636=@unserialize(file_get_contents(CACHE_FILENAME_LASTMODIFIEDS)); if ($z84636['ids_csv']==$iddf82){ if(__LOG)__log('Returned from cache'); return $z84636['lastmodifieds_json']; } } $y56790='WHERE `ID`='. str_replace(',',' OR `ID`=',$iddf82); $db7d96=array(); if (j0738( "SELECT `ID`, `LastModified` ". "FROM `". $_config['db_table_prefix']."Notes` ". $y56790 )) { if(__LOG)__log('Requested from DB'); $result=b0d6b(); foreach($result as $w8ce4b => $o9e366){ $db7d96[(int)$o9e366['ID']] = (int)$o9e366['LastModified']; } } $e08bb9=json_encode($db7d96); if ($e08bb9=='[]')$e08bb9='{}'; $z84636=array ( 'ids_csv' => $iddf82, 'lastmodifieds_json' => $e08bb9, ); if(CACHE_LASTMODIFIEDS){ k6e52(CACHE_FILENAME_LASTMODIFIEDS,serialize($z84636)); } return $e08bb9; } function wb92c($i41529){ global$_config; list ($l5a603,$tc2b31)=b5273($i41529); if (!ye852())$ff79b1="`IsVisible`=1 AND "; if (j0738( "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND ". @$ff79b1. "`Stamp` BETWEEN '". $l5a603. "' AND '". $tc2b31 ."'" )) { $result=b0d6b(); $kda36c=array(); foreach($result as $z65afd){ if ( ((int)$i41529) == f5a2f('Y',$z65afd['Stamp'],j0923($z65afd)) ) { $kda36c[] = (int)f5a2f('n',$z65afd['Stamp'],j0923($z65afd)); } } $kda36c=@array_unique($kda36c); sort($kda36c); return $kda36c; } else { return false; } } function od864($k8d777){ global$settings,$w71860,$_strings; $w7694f=$k8d777['query']; if (isset ($k8d777['page']) and $k8d777['page'] < 1) return e2_error404_mode(); $sd7e5d=$settings['appearance']['notes_per_page']; $pb3b32=array(); $yfbb44=false; if (isset ($k8d777['page'])) { $w71860=$k8d777['page']; $w7694f.=' LIMIT '.($k8d777['page']-1)*$sd7e5d.', '.$sd7e5d; $m61e23=str_replace('SELECT *','SELECT count(*)',$k8d777['query']); if (j0738($m61e23)) { $result=b0d6b(); $yfbb44=$result[0]['count(*)']; $vae0fe=ceil($yfbb44/$sd7e5d); if ($w71860 > $vae0fe and $w71860!=1){ return e2_error404_mode(); } $pb3b32['count']=$vae0fe; $pb3b32['this']=$w71860; $pb3b32['timeline?']=true; $pb3b32['earlier-title']=$_strings['gs--earlier']; $pb3b32['later-title']=$_strings['gs--later']; $o920fa=$k8d777['parameters']; if ($w71860 < $vae0fe){ $o920fa['page']=$w71860+1; $pb3b32['earlier-href']=r83c8($k8d777['candy'],$o920fa); } if ($w71860 > 1){ $o920fa['page']=$w71860-1; $pb3b32['later-href']=r83c8($k8d777['candy'],$o920fa); } } else { return array (); } } $q4358b=array(); if (j0738($w7694f)) { $result=$ze5b87=b0d6b(); if (@$k8d777['query-returns-only-ids']) { $result=array(); foreach ($ze5b87 as $laad65){ $laad65=n4627($laad65['ID']); if ($laad65['IsPublished'] and ($laad65['IsVisible'] or ye852())) { $result[] = $laad65; } } } foreach($result as $w8ce4b => $laad65){ $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_ord']=$w8ce4b; $laad65['_']['_ord_max']=count($result)-1; $q4358b[] = r6791($laad65); } } else { return array (); } $n05a16=$q4358b; if (!isset ($k8d777['show-all-notes']) or @$k8d777['show-all-notes']!=true){ $n05a16=array_slice($q4358b,0,$sd7e5d); } if ($yfbb44===false)$yfbb44=count($n05a16); if (!count($q4358b) and array_key_exists('nothing',$k8d777)) { $v2cb9d['nothing']=$k8d777['nothing']; } $tcd0fd=array ( 'class', 'superheading', 'heading', 'title', 'search-related-tag', ); foreach ($tcd0fd as $pf97bf){ if(array_key_exists($pf97bf,$k8d777)) { $v2cb9d[$pf97bf]=$k8d777[$pf97bf]; } } if ($yfbb44){ $x5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $yfbb44) ); } else { $x5cde2=$_strings['pt--no-posts']; } if(array_key_exists('maximum-notes',$k8d777) and $yfbb44 >= $k8d777['maximum-notes']) { $x5cde2=$_strings['gs--many-posts']; } foreach (array ('title','heading','superheading') as $r4b24c){ if(strstr($k8d777[$r4b24c],'%total%')) { $v2cb9d[$r4b24c]=str_replace('%total%', $x5cde2,$k8d777[$r4b24c]); } } $v2cb9d['notes']=$n05a16; $v2cb9d['pages']=$pb3b32; return $v2cb9d; } function nf9fb($i41529,$b6f8f5,$b8277e=false){ global$_config; list ($x7b314,$ka1f20)=b5273($i41529,$b6f8f5,$b8277e); if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` AND (`Stamp` BETWEEN " .$x7b314. " AND " .$ka1f20. ")". "ORDER BY Stamp" )) { $result=b0d6b(); $cb1bc2=1; $v2cb9d=array(); foreach($result as $z65afd){ if(is_numeric($b8277e)) { $a3f917=((int)$i41529) .'/'. ((int)$b6f8f5) .'/'. ((int)$b8277e) == f5a2f('Y/n/j',$z65afd['Stamp'],j0923($z65afd)); } elseif(is_numeric($b6f8f5)) { $a3f917=((int)$i41529) .'/'. ((int)$b6f8f5) == f5a2f('Y/n',$z65afd['Stamp'],j0923($z65afd)); } else { $a3f917=((int)$i41529) == f5a2f('Y',$z65afd['Stamp'],j0923($z65afd)); } if ($a3f917){ if(is_numeric($b8277e)) { $z65afd['day_number']=$cb1bc2; } $v2cb9d[] = $z65afd; $cb1bc2 ++; } } return $v2cb9d; } else { return false; } } function e2_published_noterec_with_alias_($z72487){ if ($wc45dd=e2_aliasrec_of_alias_($z72487)) { $laad65=n4627($wc45dd['EntityID']); if ($laad65['IsPublished']) return $laad65; } } function e2_published_noterec_with_parameters_($parameters=array ()) { $h39a37=e2_noterec_with_parameters_($parameters); if ($h39a37['IsPublished']) return $h39a37; } function e2_noterec_with_parameters_($parameters=array ()) { global$_config; $laad65=false; $jb5445=false; if (@$parameters['oalias']) $jb5445=$parameters['oalias']; if ($jb5445){ if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `OriginalAlias` = '". $jb5445 ."' ". "AND `IsPublished` = 0" )) { $laad65=b0d6b(); if(count($laad65)==1) { $laad65=@$laad65[0]; if ($laad65) return $laad65; } } } $t67e85=false; if (@$parameters['draft']) $t67e85=$parameters['draft']; if (@$parameters['draft2'])$t67e85=$parameters['draft2']; if ($t67e85){ $laad65=n4627($t67e85); return $laad65; } if (@$parameters['alias']) { if ($wc45dd=e2_aliasrec_of_alias_(@$parameters['alias'])) { if ($wc45dd['EntityType']==ENTITY_TYPE_NOTE){ $laad65=n4627($wc45dd['EntityID']); if ($laad65['IsPublished']) return $laad65; } } } $bc2d18=nf9fb($parameters['year'],$parameters['month'],$parameters['day']); if (@$bc2d18[$parameters['day-number']-1]) { return $bc2d18[$parameters['day-number']-1]; } } function me56b($vd5d3d,$e1cb25,$ob2c6c,$vd19c2){ global$_config; ze2f1(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); $h39a37=array ( 'Title' => $vd5d3d, 'Text' => $e1cb25, 'FormatterID' => $_config['default_formatter'], 'OriginalAlias' => md712('find',ENTITY_TYPE_UNSPECIFIED,'',$vd5d3d), 'Uploads' => $vd19c2, 'Stamp' => (int)time(), 'LastModified' => (int)time(), ); if ($ob2c6c and is_array($ob2c6c)) { $h39a37['Offset'] = (int)$ob2c6c['offset']; $h39a37['IsDST'] = (int)$ob2c6c['is_dst']; } if (($h39a37=f9943('Notes',$h39a37)) !== false){ return $h39a37['ID']; } } function ea21e($i98ea6=''){ global$_fp_error,$_config,$_e2utf8__unformat_htmlentity_neasden; $_fp_error=false; $v21158=$vd5d3d=$ld57ac=$e1cb25=$jb4960=''; if(array_key_exists('note-id',$_POST)) $v21158=$_POST['note-id']; if(array_key_exists('title',$_POST)) $vd5d3d=trim($_POST['title']); if(array_key_exists('tags',$_POST)) $ld57ac=$_POST['tags']; if(array_key_exists('text',$_POST)) $e1cb25=trim($_POST['text'],"\r\n"); if(array_key_exists('old-tags-hash',$_POST)) $jb4960=$_POST['old-tags-hash']; if(is_array($ld57ac))$ld57ac=implode(', ',$ld57ac); $ld57ac=trim($ld57ac); if ($v21158=='new'){ $_e2utf8__unformat_htmlentity_neasden=($_config['default_formatter']=='neasden'); } else { $_e2utf8__unformat_htmlentity_neasden=($_POST['formatter-id']=='neasden'); } $vd5d3d=rff7c($vd5d3d); $ld57ac=rff7c($ld57ac); $e1cb25=rff7c($e1cb25); $sffa71=$e1cb25; $sffa71=str_replace("\n",'\n'."\n",$sffa71); $sffa71=str_replace("\r",'\r'."\r",$sffa71); $sa6168=i163d(',',$ld57ac,'sort'); $ld57ac=implode(', ',$sa6168); $a65f31=md5($ld57ac); if(array_key_exists('browser-offset',$_POST)) { $ob2c6c=za618(@$_POST['browser-offset']); } else { $ob2c6c=false; } $yd17d3='/^ *(\d{1,2})\.(\d{1,2})\.(\d{2}|\d{4}) +(\d{1,2})\:(\d{1,2})\:(\d{1,2}) *$/'; $v02b37=@$_POST['old-stamp']; $caddfe=@$_POST['stamp']; $z72487=@$_POST['alias']; if ($v21158!='new'){ $q383b7=n4627($v21158); } else { $q383b7=array(); } if ($v21158){ if ($vd5d3d!='' and $e1cb25!=''){ if ($v21158=='new'){ $vd19c2=''; if(is_file(USER_FOLDER.'new-uploads.psa')) { $vd19c2=@file_get_contents(USER_FOLDER.'new-uploads.psa'); } if ($v21158=me56b($vd5d3d,$e1cb25,$ob2c6c,$vd19c2)) { @unlink(USER_FOLDER.'new-uploads.psa'); $b33dd5='e2m_draft'; $i5ce5d=array ( '*note' => n4627($v21158), ); $d1fa03='{'. '"status": "created", '. '"id": "'. $v21158 .'", '. '"note-url": "'. r83c8($b33dd5,$i5ce5d) .'", '. '"note-edit-url": "'. r83c8('e2m_note_edit',$i5ce5d) .'"'. '}'; $result=(int)$v21158; } else { $d1fa03='{"status": "error", "message": "Cannot create record"}'; $result=false; } } else { e2_drop_caches_for_note_($v21158); if (!$q383b7['IsPublished']) { @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); } $c71671=$q383b7; $c71671['ID']=$v21158; $c71671['Title']=$vd5d3d; $c71671['Text']=$e1cb25; $c71671['FormatterID']=$q383b7['FormatterID']; $c71671['LastModified']=time(); $c71671['IsIndexed']='1'; if ($v02b37!=$caddfe){ if(preg_match($yd17d3,$caddfe,$b6f8f5)) { $h96b8c=gmmktime($b6f8f5[4],$b6f8f5[5],$b6f8f5[6],$b6f8f5[2],$b6f8f5[1],$b6f8f5[3]); $h96b8c -= tb2bf($ob2c6c,$h96b8c); $h96b8c=min($h96b8c,time()); $c71671['Stamp']=$h96b8c; } else { unset ($h96b8c); } } $h17901=$z72487; if ($z72487){ $qa7ff0=$z72487; } elseif (!$q383b7['IsPublished']) { $qa7ff0=$vd5d3d; } else { $qa7ff0=''; } if ($q383b7['IsPublished']) { $h17901=md712( 'set',ENTITY_TYPE_NOTE,$v21158,$qa7ff0 ); $b33dd5='e2m_note'; $i5ce5d=array ( '*note' => $c71671, 'alias' => $h17901, ); } else { $s926c6=true; $h17901=md712('find',ENTITY_TYPE_NOTE,$v21158,$qa7ff0); $c71671['OriginalAlias']=$h17901; $b33dd5='e2m_draft'; $i5ce5d=array ( '*note' => $c71671, 'alias' => $h17901, ); } $ie449c=zc0c4( $c71671['FormatterID'],$c71671['Text'],'full' ); if(count($ie449c) > 0){ l6be4($ie449c); } if (raa79('Notes',$c71671)) { if ($c71671['IsPublished']) { pd2e1($c71671); s5b68($c71671); } $d1fa03='{'. '"status": "saved", '. '"new-alias": "'. $h17901 .'", '. '"note-url": "'. r83c8($b33dd5,$i5ce5d) .'", '. '"note-edit-url": "'. r83c8('e2m_note_edit',$i5ce5d) .'"'. '}'; $result=(int)$v21158; } else { $d1fa03='{"status": "error", "message": "Cannot update record ('. mysqli_error(). ')"}'; $result=false; } } if ($a65f31!=$jb4960){ f53f1(array ('NoteID' => $v21158)); foreach ($sa6168 as $ce4d23){ $o70b77=y0188($ce4d23); if (!$o70b77){ $o70b77['ID']=n03de($ce4d23); } j0738( "INSERT INTO `". $_config['db_table_prefix']."NotesKeywords` ". "(`NoteID`, `KeywordID`) ". "VALUES (". ((int)$v21158) .", ". ((int)$o70b77['ID']). ")" ); } } if ( $i98ea6!='ajaxresult' and $result and $_POST['instant-publish']=='yes' ){ $_POST['note-id']=$v21158; e2s_note_publish(); } } else { $d1fa03='{"status":"error", "message": "Title or text is empty"}'; $_fp_error=FP_TITLE_OR_TEXT_EMPTY; $result=false; } } else { $d1fa03='{"status":"error", "message": "No note id/new specified"}'; $_fp_error=FP_NO_ID_OR_NEW; $result=false; } tcc38(r83c8('e2s_dump', array ())); if ($i98ea6=='ajaxresult') return $d1fa03; else return$result; } function acc02($g92c58){ global$_config; $q8b7af='p1'; if (!ye852()) { $q8b7af='p1v1'; $ff79b1="AND `IsVisible`=1"; } $bd29bb=CACHES_FOLDER.$g92c58 .'-stamp-'. $q8b7af .'.e2time.psa'; if(CACHE_EDGE_TIMEINFO and is_file($bd29bb)) { $result=@unserialize(file_get_contents($bd29bb)); } if(is_array($result)) { return$result; } else { if ($g92c58=='start'){ j0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $ff79b1 ." ORDER BY Stamp LIMIT 1" ); } elseif ($g92c58=='end'){ j0738( "SELECT Stamp, Offset, IsDST FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 ". $ff79b1 ." ORDER BY Stamp DESC LIMIT 1" ); } $result=b0d6b(); if(count($result)) { $result=array ( 'stamp' => $result[0]['Stamp'], 'timezone' => j0923($result[0]), ); if(CACHE_EDGE_TIMEINFO)k6e52($bd29bb,serialize($result)); return$result; } else { return array (); } } } function o8ca0($c1653c,$c0604c){ global$_config; if (!($c1653c and $c0604c) and !ye852()) { die ('API MISUSE: e2_notes_count_general cannot be called for invisible notes or drafts unsecurely :-('); } if (!is_bool($c1653c) or !is_bool($c0604c)) { die ('API MISUSE: e2_notes_count_general must be called with bool params :-('); } if (!$c1653c and !$c0604c){ die ('API MISUSE: e2_notes_count_general called with nonsensical parameters'); } $bd29bb=CACHES_FOLDER . 'notes-count-p'. (int)$c1653c . ($c1653c ? ('v'. (int)$c0604c):'') . '.txt'; $result=false; if(CACHE_NOTES_COUNTS and is_file($bd29bb)) { $result=@file_get_contents($bd29bb); } if(is_numeric($result) and $result > 0){ return$result; } else { j0738( "SELECT COUNT(*) As NotesCount FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=". (int)$c1653c. " ". ($c1653c ? ( "AND `IsVisible`=". (int)$c0604c ):"") ); $result=b0d6b(); $result=$result[0]['NotesCount']; if($result){ if(CACHE_NOTES_COUNTS)k6e52($bd29bb,$result); return$result; } else { return null; } } } function b5421($e1cb25){ $aa80da=$e1cb25; $aa80da=preg_match( '/^(\<\/div\>)?\<p( class\=\"lead\")?\>(.*)\<\/p\>$/m', $aa80da, $v9c28d ); $aa80da=$v9c28d[3]; if (!$aa80da)$aa80da=$e1cb25; $aa80da=str_replace(array ( '<p>','<blockquote>','<ul>','<ol>','<br />', ), "\n",$aa80da); $aa80da=trim(strip_tags($aa80da)); if(strpos($aa80da,"\n")!==false){ $aa80da=substr($aa80da,0,strpos($aa80da,"\n")); $aa80da=trim($aa80da,' :.()'."\n"); } if(preg_match('/^(.{100,}?)[:.!?()]|'."\n".'/s',$aa80da,$v9c28d)) { $aa80da=trim($v9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{150,}?)[:.!?(),]/s',$aa80da,$v9c28d)) { $aa80da=trim($v9c28d[0],' :.()'."\n"); } if(preg_match('/^(.{200,}?)[:.!?(), ]/s',$aa80da,$v9c28d)) { $aa80da=trim($v9c28d[0],' :.()'."\n"); } if(in_array($aa80da[strlen($aa80da)-1], array (',',' '))) { $aa80da=trim($aa80da,', '). '...'; } if(mb_strlen($aa80da) > 250){ $aa80da=mb_substr($aa80da,0,250). '...'; } if ($aa80da[-1]==':')$aa80da=mb_substr($aa80da,0, -1); return $aa80da; } define('DRAFT_PREVIEW_LENGTH',100); function e2m_drafts(){ global$_strings,$_config; if(__LOG)__log('Drafts list: working...'); $hda3ad='LastModified'; $eda48a=null; if(CACHE_DRAFTS and is_file(CACHE_FILENAME_DRAFTS)) { $eda48a=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS)); } if(CACHE_DRAFTS and is_array($eda48a)) { if(__LOG)__log('Drafts list: retrieve cached ctree'); } else { if(__LOG)__log('Drafts list: assemle cacheable ctree...'); $eda48a=array(); if(__LOG)__log('Drafts list: select by '. $hda3ad .'...'); if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `". $hda3ad ."` DESC" )) { $result=b0d6b(); $q4358b=array(); foreach($result as $w8ce4b => $h39a37){ $laad65=array(); $laad65['_']['_id']=$h39a37['ID']; $laad65['_']['_ord']=k; $laad65['_']['_ord_max']=count($result)-1; $laad65['href']=r83c8('e2m_draft', array ('*note' => $h39a37)); $laad65['title']=t6f10(htmlspecialchars($h39a37['Title'],ENT_NOQUOTES,HSC_ENC)); if (isset ($laad65['image-href'])) unset ($laad65['image-href']); $h39a37['_']['_id']=$h39a37['ID']; $h39a37['_']['_ord']=0; $h39a37['_']['_ord_max']=0; $j8e4cd=r6791($h39a37,true); $laad65['_']['_resources']=null; if ($h39a37['FormatterID']=='neasden'){ $laad65['_']['_resources']=$j8e4cd['format-info']['resources-detected']; } elseif ($h39a37['FormatterID']=='calliope'){ $laad65['_']['_resources']=zc0c4( $h39a37['FormatterID'],$h39a37['Text'],'full' ); } $laad65=array_merge($laad65,w1a48($h39a37,false)); $laad65['text-fragment']=strip_tags($j8e4cd['text']); $q2ab2d=false; if(mb_strlen($laad65['text-fragment']) > DRAFT_PREVIEW_LENGTH) { $q2ab2d=mb_strpos($laad65['text-fragment'],'.',DRAFT_PREVIEW_LENGTH); } if ($q2ab2d!==false){ $laad65['text-fragment']=mb_substr($laad65['text-fragment'],0,$q2ab2d+1); } $eda48a[] = $laad65; } if(CACHE_DRAFTS)k6e52(CACHE_FILENAME_DRAFTS,serialize($eda48a)); } } if(__LOG)__log('Drafts list: put thumbnail without cache'); if ($eda48a){ foreach ($eda48a as $w8ce4b => $o9e366){ $eda48a[$w8ce4b]['thumbs']=d2e82(@$o9e366['_']['_resources']); } } if(__LOG)__log('Drafts list: done'); $v2cb9d=array ( 'title' => $_strings['pt--drafts'], 'heading' => $_strings['pt--drafts'], ); if(count($eda48a)) { $v2cb9d['drafts']=$eda48a; } else { $v2cb9d['nothing']=$_strings['gs--no-drafts']; } return $v2cb9d; } function e2m_draft($parameters=array ()) { global$_strings,$s57de2; $laad65=e2_noterec_with_parameters_($parameters); if (!$laad65){ $parameters['alias']=$parameters['oalias']; unset($parameters['oalias']); $laad65=e2_noterec_with_parameters_($parameters); if ($laad65){ $cd58c0=r83c8('e2m_note', array ('*note' => $laad65)); return e2_go_to($cd58c0); } } if (!$laad65) return e2_error404_mode(); $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_ord']=0; $laad65['_']['_ord_max']=0; $j8e4cd=r6791($laad65); $r45513=array ( '.note-id' => $laad65['ID'], 'form-action' => r83c8('e2s_note_publish'), 'submit-text' => $_strings['fb--publish-draft'], ); return array ( 'title' => $laad65['Title'].' ('. $_strings['wd--draft'] .')', 'notes' => array ('only' => $j8e4cd), 'form' => 'form-note-publish', 'form-note-publish' => $r45513, ); } function e2m_draft_preview($parameters=array ()) { $laad65=e2_noterec_with_parameters_($parameters); $ra2d26=e2drafts__preview_key($laad65); if(E2_EDITION and $parameters['preview-key']==$ra2d26){ $result=e2m_draft($parameters); unset($result ['notes']['only']['href']); unset($result ['form']); unset($result ['form-note-publish']); return$result; } else { return e2_error404_mode(); } } function e2_draft_alias_use_count($x176fe=''){ global$_config; if(__LOG)__log('Drafts: find duplicate OriginalAliases...'); if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_file(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)) { $ida552=@unserialize(file_get_contents(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS)); } if(CACHE_DRAFTS_ALIAS_USE_COUNTS and is_array($ida552)) { if(__LOG)__log('Drafts: retrieve cached'); } else { if(__LOG)__log('Drafts: assemle cacheable...'); $ida552=array(); if (j0738( "SELECT `OriginalAlias` FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=0 ". "ORDER BY `ID`" )) { $result=b0d6b(); $q4358b=array(); foreach($result as $w8ce4b => $h39a37){ @$ida552[$h39a37['OriginalAlias']] ++; } } if(CACHE_DRAFTS_ALIAS_USE_COUNTS){ k6e52(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS,serialize($ida552)); } } if ($x176fe){ return $ida552[$x176fe]; } else { return $ida552; } } function e2drafts__preview_key($laad65){ return md5($laad65['Text'].$laad65['LastModified']); } $_url_map=array ( '@build' => 'e2://e2s_build', '@sync' => 'e2://e2s_sync', '@dump' => 'e2://e2s_dump', '@bsi' => 'e2://e2s_bsi_status', '@bsi/drop' => 'e2://e2s_bsi_drop', '@bsi/step' => 'e2://e2s_bsi_step', '@migrate' => 'e2://e2s_migrate', '@retrieve:source' => 'e2://e2s_retrieve', '@instantiate:version' => 'e2://e2s_instantiate', 'notify' => 'e2://e2s_notify', '@notify' => 'e2://e2s_notify', '@info' => 'e2://e2m_info', '@ajax/::' => 'e2://e2j_::', '@actions/::' => 'e2://e2s_::', '' => 'e2://e2m_frontpage?page=1', ':page' => 'e2://e2m_frontpage', 'rss' => 'e2://e2m_rss', 'json' => 'e2://e2m_json', ':year' => 'e2://e2m_year', ':year/:month' => 'e2://e2m_month', ':year/:month/:day' => 'e2://e2m_day', 'all' => 'e2://e2m_everything', ':note' => 'e2://e2m_note', ':note/comment' => 'e2://e2m_note_comment', ':note/edit' => 'e2://e2m_note_edit?is_published=1', ':note/favourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=1', ':note/unfavourite' => 'e2://e2m_note_flag_favourite?is_published=1&value=0', ':note/show' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=1', ':note/hide' => 'e2://e2m_note_flag?is_published=1&flag=IsVisible&value=0', ':note/discuss' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=1', ':note/quiet' => 'e2://e2m_note_flag?is_published=1&flag=IsCommentable&value=0', ':note/withdraw' => 'e2://e2m_note_withdraw?is_published=1', ':note/json' => 'e2://e2m_note_json', ':note/broadcast' => 'e2://e2m_note_broadcast', ':note/delete' => 'e2://e2m_note_delete?is_published=1', ':note/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=1', ':note/:unsubscr' => 'e2://e2m_unsubscribe?is_published=1', ':note/hitinfo' => 'e2://e2m_note_hitinfo?is_published=1', ':note/:comnum' => 'e2://e2m_comment', ':note/:comnum/edit' => 'e2://e2m_comment_edit', ':note/:comnum/important' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=1', ':note/:comnum/usual' => 'e2://e2m_comment_flag_ajax?flag=IsFavourite&value=0', ':note/:comnum/replace' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=1', ':note/:comnum/remove' => 'e2://e2m_comment_flag_ajax?flag=IsVisible&value=0', ':note/:comnum/spam' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=1', ':note/:comnum/good' => 'e2://e2m_comment_flag?flag=IsSpamSuspect&value=0', ':note/:comnum/wipe' => 'e2://e2m_comment_delete', ':note/:comnum/reply/edit' => 'e2://e2m_comment_reply', ':note/:comnum/reply/important' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=1', ':note/:comnum/reply/usual' => 'e2://e2m_comment_flag_ajax?flag=IsReplyFavourite&value=0', ':note/:comnum/reply/replace' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=1', ':note/:comnum/reply/remove' => 'e2://e2m_comment_flag_ajax?flag=IsReplyVisible&value=0', ':note/:comnum/reply/delete' => 'e2://e2m_comment_reply_delete', 'drafts' => 'e2://e2m_drafts', 'drafts/:draft' => 'e2://e2m_draft', 'drafts/:draft/edit' => 'e2://e2m_note_edit?is_published=0', 'drafts/:draft/show' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=1', 'drafts/:draft/hide' => 'e2://e2m_note_flag?is_published=0&flag=IsVisible&value=0', 'drafts/:draft/delete' => 'e2://e2m_note_delete?is_published=0', 'drafts/:draft/format/:formatter' => 'e2://e2m_note_use_formatter?is_published=0', 'drafts/:draft/:preview' => 'e2://e2m_draft_preview', 'sources/:source/trust' => 'e2://e2m_source_trust', 'sources/:source/premoderate' => 'e2://e2m_source_premoderate', 'sources/:source/ban' => 'e2://e2m_source_ban', 'sources/:source/forget' => 'e2://e2m_source_forget', 'tags' => 'e2://e2m_tags', 'tags/:tag' => 'e2://e2m_tag?page=1', 'tags/:tag/:page' => 'e2://e2m_tag', 'tags/:tag/rss' => 'e2://e2m_tag_rss', 'tags/:tag/json' => 'e2://e2m_tag_json', 'tags/:tag/edit' => 'e2://e2m_tag_edit', 'tags/:tag/delete' => 'e2://e2m_tag_delete', 'tags/:tag/pin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=1', 'tags/:tag/unpin' => 'e2://e2m_tag_flag_ajax?flag=IsFavourite&value=0', 'untagged' => 'e2://e2m_untagged', 'hot' => 'e2://e2m_most_commented', 'selected' => 'e2://e2m_favourites?page=1', 'selected/:page' => 'e2://e2m_favourites', 'found' => 'e2://e2m_found&query=', 'found/:query' => 'e2://e2m_found', 'new' => 'e2://e2m_write', 'install' => 'e2://e2m_install', 'settings' => 'e2://e2m_settings', 'settings/name' => 'e2://e2m_name_and_author', 'settings/database' => 'e2://e2m_database', 'settings/password' => 'e2://e2m_password', 'settings/timezone' => 'e2://e2m_timezone', 'settings/sessions' => 'e2://e2m_sessions', 'settings/theme-preview' => 'e2://e2m_theme_preview?theme=', 'settings/theme-preview/:theme' => 'e2://e2m_theme_preview', 'settings/get-backup' => 'e2://e2m_get_backup', 'sign-in' => 'e2://e2m_sign_in', 'sign-out' => 'e2://e2m_sign_out', ); $_url_chunks=array ( '\:page' => 'page\-(?P<page>\d+)', '\:year' => '(?P<year>\d{4})', '\:month' => '(?P<month>\d{1,2})', '\:day' => '(?P<day>\d{1,2})', '\:note' => array ( 'all\/(?P<alias>[-a-zA-Z0-9]+)', '(?P<year>\d{4})\/(?P<month>\d{1,2})\/(?P<day>\d{1,2})\/(?P<day_number>\d+)', ), '\:draft' => array ( '(?P<oalias2>[-a-zA-Z0-9]+)\/(?P<draft2>\d+)', '(?P<oalias>[-a-zA-Z0-9]+)', '-\/(?P<draft>\d+)', ), '\:comnum' => 'comment\-(?P<comment_number>[0-9]+)', '\:file' => '(?P<file>.*?)', '\:tag' => '(?P<tag_alias>[-a-zA-Z0-9]+)', '\:query' => '(?P<query>.*?)', '\:version' => '\:(?P<version>\d+)', '\:source' => '\:(?P<source>.*?)', '\:picture' => '\:(?P<picture>.*?)', '\:unsubscr' => 'unsubscribe\:(?P<unsubscribe_email>.+?)\:(?P<unsubscribe_key>[0-9a-f]{32})', '\:formatter' => '(?P<formatter>.*?)', '\:alias' => '(?P<newalias>[-a-zA-Z0-9]+)', '\:preview' => 'preview\:(?P<preview_key>[0-9a-f]{32})', '\:theme' => '(?P<theme>[-a-zA-Z0-9]+)', '\:source' => '\:(?P<source>[a-zA-Z0-9]+\=)', ); $_url_autoredirects=array ( '/^favo(?:u?)rites(\~.+)?$/i' => 'selected\\1', '/^favo(?:u?)rites\/(.+)/i' => 'selected/\\1', '/^keywords$/i' => 'tags', '/^keywords\/(.*)/i' => 'tags/\\1', '/^everything$/i' => 'all', '/^search\/(.+)/i' => 'found/\\1', '/^(\d{4}\/\d{1,2}\/\d{1,2}\/\d+)\/comments(\/?)$/i' => '\\1', '/^\~(\d+)/i' => 'page-\\1', '/\/?\~(\d+)/i' => '/page-\\1', ); function mb6b0($x572d4){ global$_url_autoredirects,$ya57c1; $x572d4=preg_replace(array_keys($_url_autoredirects),array_values($_url_autoredirects),$x572d4); if(preg_match('/^([0-9]+)[.-]([0-9]+)[.-]([0-9]+)(.*)/',$x572d4,$v9c28d)) { if(2==strlen($v9c28d[3]))$v9c28d[3]='20'.$v9c28d[3]; return ($v9c28d[3].'/'.$v9c28d[2].'/'.$v9c28d[1].$v9c28d[4]); } if(preg_match('/^tags\-rss\/(.*?)\/?$/',$x572d4,$v9c28d)) { $ce4d23=substr($v9c28d[1],strrpos($v9c28d[1],'/')+1); return ('tags/'. $ce4d23.'/rss/'); } return $x572d4; } function r7059(){ global$__synthetic_urls,$_config,$_superconfig; $__synthetic_urls=false; if($_config['url_composition']=='auto'){ if(function_exists('apache_get_modules')) { if(in_array('mod_rewrite',apache_get_modules())) { $__synthetic_urls=true; } } } if($_config['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='synthetic'){ $__synthetic_urls=true; } if (@$_superconfig['url_composition']=='real'){ $__synthetic_urls=false; } } function r83c8($cc48ba,$parameters=array ()) { global$_url_map,$_url_chunks,$_config,$__synthetic_urls,$_protocol,$s57de2,$ya57c1; $bc2bd7=array_flip($_url_map); if ( @$_config['preferred_domain_name'] and $_SERVER['HTTP_HOST']!=$_config['preferred_domain_name'] ) { $s57de2=$_config['preferred_domain_name']; } $x572d4=$_protocol .'://'. $s57de2.$ya57c1 .'/'; $v9c464='e2://'. $cc48ba; if(array_key_exists('page',$parameters)) { $w71860=$parameters['page']; } else { $w71860=1; } if($parameters){ $v9c464.='?'; $q1c61f=array(); $t21711=array(); foreach($parameters as $n3c6e0 => $b2063c){ if ($n3c6e0=='*note'){ $t21711[] = $n3c6e0; $q1c61f[] = e2urls__expand_tricky_parameters_for_note_($b2063c); } if ($n3c6e0=='*tags'){ $t21711[] = $n3c6e0; $q1c61f[] = e2urls__expand_tricky_parameters_for_tags_($b2063c); } if ($n3c6e0=='*tag'){ $t21711[] = $n3c6e0; $q1c61f[] = e2urls__expand_tricky_parameters_for_tags_(array ($b2063c)); } } foreach ($t21711 as $n3c6e0) unset($parameters[$n3c6e0]); foreach ($q1c61f as $z58e2a){ $parameters=array_merge($parameters,$z58e2a); } foreach($parameters as $n3c6e0 => $b2063c){ if (@$n3c6e0[0]!='_'){ $v9c464.=$n3c6e0 .'='. urlencode($b2063c) .'&'; } } $v9c464=substr($v9c464,0, -1); } if(array_key_exists($v9c464,$bc2bd7)) { if ($bc2bd7[$v9c464]!='')$x572d4.=$bc2bd7[$v9c464] .'/'; return $x572d4; } else { $o44907=false; foreach ($bc2bd7 as $s45ea8 => $g9ea44){ $wb7365=$s45ea8; $wb7365=preg_quote($wb7365,'/'); $ped015=parse_url($s45ea8); $j2f532=$ped015['host']; $xebe09=parse_url($v9c464); if(strstr($s45ea8,'::')) { $hffd6b=$xebe09['scheme'] .'://'. $xebe09['host']; $wb7365=str_replace('\:\:','(.*)',$wb7365); $wb7365='/^'. $wb7365 .'$/s'; if(preg_match($wb7365,$hffd6b,$v9c28d)) { $id6fe1=str_replace('::',$v9c28d[1],$g9ea44); $id6fe1=str_replace('_','-',$id6fe1); $s1b1cc=$xebe09['query']; if($__synthetic_urls and $s1b1cc){ $x572d4.=$id6fe1 .'/?'. $s1b1cc; } elseif($__synthetic_urls){ $x572d4.=$id6fe1 .'/'; } elseif ($s1b1cc){ $x572d4.='?go='. $id6fe1 .'/&'. $s1b1cc; } else { $x572d4.='?go='. $id6fe1 .'/'; } return $x572d4; } } $u54435=false; if ($cc48ba==$j2f532){ $o44907=true; if ($ped015['query']) { $y22c38=explode('&',$ped015['query']); foreach ($y22c38 as $r8822b){ list ($n3c6e0,$b2063c)=explode('=',$r8822b); $b2063c=urldecode($b2063c); $n3c6e0=str_replace('_','-',$n3c6e0); if ( array_key_exists($n3c6e0,$parameters) and $parameters[$n3c6e0]!=$b2063c ){ $u54435=true; break; } } } if (!$u54435){ if(preg_match_all('/\:[\-a-z]+/i',$g9ea44,$v9c28d)) { foreach ($v9c28d[0] as $ifc413){ $vb0f75=$_url_chunks['\\'. $ifc413]; if (!is_array($vb0f75)) { $vb0f75=array ($vb0f75); } $c05f62=$vb0f75[0]; foreach ($vb0f75 as $c05f62){ $weab03='/\(\?P\<(.*?)\>.*?\)/'; $a4274e=true; if (@preg_match($weab03,$c05f62,$v9c28d)) { $a4274e=true; for ($q865c0=1; $q865c0 < count($v9c28d); ++ $q865c0){ if (!$parameters[str_replace("_","-",$v9c28d[$q865c0])]) { $a4274e=false; break; } } } if (!$a4274e) continue; $af9e1e=@preg_replace_callback( $weab03, function ($v9c28d) use ($parameters){ return$parameters[str_replace("_","-",$v9c28d[1])]; }, $c05f62 ); $af9e1e=stripslashes($af9e1e); $fc5d91=str_replace($ifc413,$af9e1e,$g9ea44); break; } $g9ea44=$fc5d91; } } $a15214=array(); if ($g9ea44){ if($__synthetic_urls){ $x572d4.=$g9ea44 .'/'; } else { $a15214[] = 'go='. $g9ea44 .'/'; } } foreach($_GET as $w8ce4b => $o9e366) if(in_array($w8ce4b, array ('result','themeless'))) { $a15214[] = $w8ce4b . ($o9e366? ('='. urlencode($o9e366)) : ''); } if(count($a15214)) { $x572d4.='?'. implode('&',$a15214); } return $x572d4; } } } if ($o44907){ return $x572d4; } else { die ('Cannot compose url for candy '. $cc48ba); } } } function pb7e9($x572d4){ global$_url_map,$_url_chunks,$_config,$_current_url,$__synthetic_urls,$_protocol,$s57de2,$ya57c1; $x196c2=$x572d4; $x572d4=trim($x572d4,'/'); $x572d4=mb6b0($x572d4); if(__LOG)__log($x572d4); $parameters=array(); foreach($_url_map as $m12a24 => $s45ea8){ $yd532d=$m12a24; $yd532d=preg_quote($yd532d,'/'); if(strstr($m12a24,'::')) { $yd532d=str_replace('\:\:','(.*)',$yd532d); $yd532d='/^'. $yd532d .'$/s'; if(preg_match($yd532d,$x572d4,$v9c28d)) { $h53b9e=str_replace('-','_',$v9c28d[1]); $v9c464=str_replace('::',$h53b9e,$s45ea8); } } elseif(strstr($m12a24,':')) { $z1e380=array(); foreach($_url_chunks as $w8ce4b => $o9e366){ if(is_array($o9e366)) { $z1e380[$w8ce4b]='(?:(?:'. implode(')|(?:',$o9e366) .'))'; } else { $z1e380[$w8ce4b]=$o9e366; } } $yd532d=str_replace( array_keys($z1e380), array_values($z1e380), $yd532d ); $yd532d='/^'. $yd532d .'$/s'; if(preg_match($yd532d,$x572d4,$v9c28d)) { $v9c464=$s45ea8; foreach ($v9c28d as $n3c6e0 => $b2063c) if (!is_numeric($n3c6e0)) { $n3c6e0=str_replace('_','-',$n3c6e0); $parameters[$n3c6e0]=$b2063c; } } } else { if ($m12a24==$x572d4){ $v9c464=$s45ea8; break; } } } $cfafdd=(bool)$v9c464; if (!$v9c464)$v9c464='e2://e2m_404'; $xebe09=parse_url($v9c464); $cc48ba=$xebe09['host']; if ($xebe09['query']) { $y22c38=explode('&',$xebe09['query']); foreach ($y22c38 as $r8822b){ list ($n3c6e0,$b2063c)=explode('=',$r8822b); $b2063c=urldecode($b2063c); $n3c6e0=str_replace('_','-',$n3c6e0); $parameters[$n3c6e0]=$b2063c; } } $v2cb9d=false; $parameters=e2urls__consolidate_tricky_parameters_($parameters); if ($cfafdd){ if($_config['force_canonical_urls']) { $h95d32=r83c8($cc48ba,$parameters); list ($xa4c3a,$mab96c)=explode('?',$_SERVER['REQUEST_URI'],2); $xa37bf=$_protocol .'://'.$_SERVER['HTTP_HOST'].$xa4c3a; $a5d6ba=$_protocol .'://'.$_SERVER['HTTP_HOST'].urldecode($xa4c3a); $mab96c=explode('&',$mab96c); foreach ($mab96c as $i6c0d0){ list ($n5c5e7, ) = explode('=',$i6c0d0); if ($n5c5e7=='go'){ $xa37bf.='?'. $i6c0d0; $a5d6ba.='?'. urldecode($i6c0d0); } } $_current_url=$xa37bf; if ($xa37bf!=$h95d32 and $a5d6ba!=$h95d32){ e2_go_to($h95d32); } } if(is_callable($cc48ba)) { $v2cb9d=array ($cc48ba,$parameters); } else { $v2cb9d=array (null, array ()); } } else { $v2cb9d=array (null, array ()); } return $v2cb9d; } function e2urls__expand_tricky_parameters_for_note_($h39a37){ global $ya57c1,$_config; if (!isset ($h39a37['IsPublished'])) { return array (); } if (!$h39a37['IsPublished']) { if ($h39a37['OriginalAlias']==''){ $parameters['draft']=$h39a37['ID']; } elseif(e2_draft_alias_use_count($h39a37['OriginalAlias']) == 1){ $parameters['oalias']=$h39a37['OriginalAlias']; } else { $parameters['draft2']=$h39a37['ID']; $parameters['oalias2']=$h39a37['OriginalAlias']; } $parameters['is-published']=0; return$parameters; } $parameters['is-published']=1; $fb80bb=$h39a37['ID']; $h96b8c=$h39a37['Stamp']; $ob2c6c=j0923($h39a37); if (!isset ($h39a37['__noalias!'])) { if (isset ($h39a37['alias'])) { $parameters['alias']=$h39a37['alias']; } else { $parameters['alias']=e2_active_alias_for_page_(ENTITY_TYPE_NOTE,$h39a37['ID']); } } if($parameters['alias']) return$parameters; list ($i41529,$b6f8f5,$b8277e)=explode('/', f5a2f('Y/m/d',$h96b8c,$ob2c6c) ); $parameters['year']=$i41529; $parameters['month']=$b6f8f5; $parameters['day']=$b8277e; if (isset ($h39a37['day_number'])) { $parameters['day-number']=$h39a37['day_number']; } else { list ($gd9d0f, ) = b5273($i41529,$b6f8f5,$b8277e); if (j0738( "SELECT `ID`, `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND (`Stamp` BETWEEN " .$gd9d0f. " AND " .$h96b8c. ") ". "ORDER BY `Stamp`" )) { $result=b0d6b(); $cb1bc2=1; foreach($result as $z65afd){ if ( $i41529.'/'.$b6f8f5.'/'.$b8277e == f5a2f('Y/m/d',$z65afd['Stamp'],j0923($z65afd)) ) { if ($z65afd['ID']==$fb80bb){ $m444bc=1; break; } $cb1bc2 ++; } } if (@$m444bc!=1){ header('HTTP/1.1 503 Service Unavailable'); die ('Candidates enumeration failed.'); } } $parameters['day-number']=$cb1bc2; } return$parameters; } function e2urls__expand_tricky_parameters_for_tags_($z0dff3){ $o9299d=array(); $parameters=array(); foreach ($z0dff3 as $lb19ad){ $z72487=''; if (!isset ($lb19ad['__noalias!'])) { if (isset ($lb19ad['tag-alias'])) { $z72487=$lb19ad['tag-alias']; } else { $z72487=e2_active_alias_for_page_(ENTITY_TYPE_TAG,$lb19ad['ID']); } } $o9299d[] = $z72487? $z72487:$lb19ad['OriginalAlias']; } if(count($z0dff3)) { $parameters['tag-alias']=implode(',',$o9299d); } return$parameters; } function e2urls__consolidate_tricky_parameters_($parameters){ if ( @$parameters['alias'] or ( @$parameters['year'] and @$parameters['month'] and @$parameters['day'] and @$parameters['day-number'] ) ) { if ($laad65=e2_published_noterec_with_parameters_($parameters)) { $parameters['*note']=$laad65; } } if ( @$parameters['oalias'] or @$parameters['draft'] or @$parameters['oalias2'] or @$parameters['draft2'] ) { if ($laad65=e2_noterec_with_parameters_($parameters)) { $parameters['*note']=$laad65; } } if ( @$parameters['tag-alias'] ) { $parameters['*tags']=e2_tagrecs_with_parameters_($parameters); if(count($parameters['*tags']) == 1){ $parameters['*tag']=$parameters['*tags'][0]; } } return$parameters; } function e2m_tags(){ global$_strings; $v2cb9d['title']=$_strings['pt--tags']; $v2cb9d['heading']=$_strings['pt--tags']; $ld57ac=t5d57(); if(count($ld57ac)==0){ $v2cb9d['nothing']=$_strings['gs--no-tags']; } return $v2cb9d; } function e2m_tag($parameters=array ()) { global $settings, $_config, $_current_tag, $_strings, $w71860, $full_blog_url; if(__LOG)__log('Tag {'); if(array_key_exists('*tags',$parameters)) { $z59aeb=$parameters['*tags']; } if (!$z59aeb[0]) return e2_error404_mode(); $od7df5=$z59aeb[0]; $y7186e=$parameters['tag-alias']; if(count($z59aeb)==1){ $_current_tag=$od7df5['Keyword']; } $w71860=$parameters['page']; $lc2b7b=$_config['db_table_prefix']; $sd7e5d=$settings['appearance']['notes_per_page']; foreach ($z59aeb as $o9e366) if ($o9e366){ $y56790[] = "`". $lc2b7b."NotesKeywords`.KeywordID=". $o9e366['ID']; } $y56790=implode(' OR ',$y56790); $ff79b1='AND `IsVisible`=1'; if (ye852())$ff79b1=''; $q76595=( "COUNT(*) as KeywordsCount ". "FROM `". $lc2b7b."Notes` ". "INNER JOIN `". $lc2b7b."NotesKeywords` ". "ON `". $lc2b7b."NotesKeywords`.NoteID=`". $lc2b7b."Notes`.ID ". "WHERE `IsPublished`=1 AND (". $y56790 .") ". $ff79b1 ." ". "GROUP BY `". $lc2b7b."Notes`.`ID` ". "HAVING KeywordsCount=". count($z59aeb) ); $gd3890=( "SELECT DISTINCT `". $lc2b7b."Notes`.*, ". $q76595 ." ". "ORDER BY `". $lc2b7b."Notes`.`Stamp` DESC ". "LIMIT ". ($w71860-1)*$sd7e5d .", ". $sd7e5d ); $q1b037=( "SELECT DISTINCT `". $lc2b7b."Notes`.ID, ". $q76595 ); $pb3b32=array(); if (j0738($q1b037)) { $result=b0d6b(); $yfbb44=count($result); $vae0fe=ceil($yfbb44/$sd7e5d); $pb3b32['timeline?']=true; $pb3b32['count']=$vae0fe; $pb3b32['this']=$w71860; $pb3b32['earlier-title']=$_strings['gs--earlier']; $pb3b32['later-title']=$_strings['gs--later']; $o920fa=$parameters; if ($w71860 < $vae0fe){ $o920fa['page']=$w71860+1; $pb3b32['earlier-href']=r83c8('e2m_tag',$o920fa); } if ($w71860 > 1){ $o920fa['page']=$w71860-1; $pb3b32['later-href']=r83c8('e2m_tag',$o920fa); } } if ($yfbb44==0 and !ye852()) { return e2_error404_mode(); } if (j0738($gd3890)) { $result=b0d6b(); foreach($result as $w8ce4b => $laad65){ $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_ord']=k; $laad65['_']['_ord_max']=count($result)-1; $q4358b[] = r6791($laad65); } if(count($result)==0){ if ($w71860!=1) return e2_error404_mode(); } } if(count($z59aeb)==1){ if (ye852()) { $j97a59['edit-href']=r83c8( 'e2m_tag_edit', array ('tag-alias' => $y7186e) ); } if (''!=$od7df5['Description']) { $s2bfe4=ob7f1($od7df5['Description'],'full'); $g67daf=$s2bfe4['text-final']; $j97a59['description']=$g67daf; $j97a59['description-format-info']=$s2bfe4['meta']; } $w3ad42=r83c8('e2m_tag_rss', array ('tag-alias' => $y7186e)); $e9d19f=r83c8('e2m_tag_json', array ('tag-alias' => $y7186e)); x3010( 'rss', b6f51() .': '. $od7df5['Keyword'], $w3ad42 ); x3010( 'json', b6f51() .': '. $od7df5['Keyword'], $e9d19f ); $j97a59['og-images']=edbcc( 'tag',$od7df5['ID'], $j97a59['description-format-info']['resources-detected'] ); } $y96963=( e2l_get_string('pt--n-posts', array ('number' => $yfbb44)). ' '. $_strings['gs--tagged'] ); $cf74f5=array(); foreach ($z59aeb as $o9e366){ $cf74f5[] = $o9e366['Keyword']; } $cf74f5=implode(', ',$cf74f5); $v2cb9d=array ( 'title' => b6f51() .': '. $cf74f5, 'superheading' => $y96963, 'heading' => $cf74f5, 'pages' => $pb3b32, 'notes' => $q4358b, ); if ($g67daf){ $v2cb9d['summary']=b5421($g67daf); } if(count($z59aeb)==1){ $v2cb9d['tag']=$j97a59; if (ye852()) { $v2cb9d['related-edit-href']=$j97a59['edit-href']; $v2cb9d['related-edit-title']=$_strings['tt--edit-tag']; } } if(__LOG)__log('} // Tag'); return $v2cb9d; } function e2m_tag_edit($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $od7df5=$parameters['*tag']; } if (!$od7df5) return e2_error404_mode(); $ie449c=zc0c4( 'neasden',$od7df5['Description'],'full' ); $e75e1b=uf898( 'tag',$od7df5['ID'],$ie449c ); n2f83( 'Keywords', $od7df5, $ie449c ); $kc999b=kd10e(); $dcd831=array ( '.tag-id' => $od7df5['ID'], '.formatter-id' => 'neasden', 'form-action' => r83c8('e2s_tag_edit'), 'form-file-upload-action' => r83c8('e2j_file_upload'), 'form-file-remove-action' => r83c8('e2j_file_remove'), 'submit-text' => $_strings['fb--save-changes'], 'tag' => htmlspecialchars($od7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'urlname' => htmlspecialchars($parameters['tag-alias'],ENT_COMPAT,HSC_ENC), 'description' => htmlspecialchars($od7df5['Description'],ENT_COMPAT,HSC_ENC), 'uploads' => $e75e1b, 'uploads-enabled?' => z1363($kc999b), 'favourite?' => (bool)$od7df5['IsFavourite'], 'space-usage' => kaf64($kc999b), ); $dcd831['.cache-sensitive-hash']=md5( $dcd831['tag'] . $dcd831['urlname'] ); $v2cb9d=array ( 'title' => $_strings['pt--tag-edit'] .': '. $od7df5['Keyword'], 'heading' => $_strings['pt--tag-edit'], 'form' => 'form-tag', 'form-tag' => $dcd831, 'related-delete-href' => r83c8('e2m_tag_delete', array ('*tag' => $od7df5)), ); return $v2cb9d; } function e2m_tag_flag_ajax($parameters){ if (g2e88($parameters)) { $r67142=$parameters; $r67142['value'] = !$parameters['value']; if($parameters['value']==1){ $q99859=r83c8('e2m_tag_flag_ajax',$r67142); $d1fa03='on-rehref|'. $q99859; } else { $q99859=r83c8('e2m_tag_flag_ajax',$r67142); $d1fa03='off-rehref|'. $q99859; } } else { $d1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($d1fa03); } else { e2_go_to(r83c8('e2m_tag',$parameters)); die; } } function g2e88($parameters){ if(array_key_exists('*tag',$parameters)) { $od7df5=$parameters['*tag']; } if (!$od7df5) return e2_error404_mode(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $result=raa79('Keywords', array ( 'ID' => $od7df5['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); return$result; } function e2m_tag_delete($parameters=array()) { global$_strings; if(array_key_exists('*tag',$parameters)) { $od7df5=$parameters['*tag']; } if (!$od7df5) return e2_error404_mode(); $decc14=array ( '.tag-id' => $od7df5['ID'], 'caution-text' => e2l_get_string('gs--tag-will-be-deleted-notes-remain', array ( 'tag' => htmlspecialchars($od7df5['Keyword'],ENT_COMPAT,HSC_ENC) )), 'tag' => htmlspecialchars($od7df5['Keyword'],ENT_COMPAT,HSC_ENC), 'form-action' => r83c8('e2s_tag_delete'), 'submit-text' => $_strings['fb--delete'], ); $v2cb9d=array ( 'title' => $_strings['pt--tag-delete'] .': '. $od7df5['Keyword'], 'heading' => $_strings['pt--tag-delete'], 'form' => 'form-tag-delete', 'form-tag-delete' => $decc14, ); return $v2cb9d; } function e2m_untagged(){ global$_strings,$_config; $ff79b1='AND `IsVisible`=1'; if (ye852())$ff79b1=''; return od864(array ( 'query' => "SELECT n.* FROM `". $_config['db_table_prefix']."Notes` n ". "LEFT OUTER JOIN `". $_config['db_table_prefix']."NotesKeywords` nk ". "ON nk.NoteID = n.ID ". "WHERE `IsPublished`=1 AND nk.KeywordID IS NULL ".$ff79b1." ". "ORDER BY n.Stamp DESC", 'title' => $_strings['pt--posts-without-tags'], 'heading' => $_strings['pt--posts-without-tags'], 'nothing' => $_strings['gs--no-posts-without-tags'], 'show-all-notes' => true, )); } function e2s_tag_edit(){ global$_strings,$_config; $a76f09=$ce4d23=$g67daf=$qa7ff0=''; if(array_key_exists('tag-id',$_POST)) $a76f09=$_POST['tag-id']; if(array_key_exists('tag',$_POST)) $ce4d23=$_POST['tag']; if(array_key_exists('description',$_POST)) $g67daf=trim($_POST['description'],"\r\n"); if(array_key_exists('urlname',$_POST)) $qa7ff0=trim($_POST['urlname'],"\r\n"); if(array_key_exists('cache-sensitive-hash',$_POST)) { $v3c58b=$_POST['cache-sensitive-hash']; $lbb9a8=md5($ce4d23.$qa7ff0); } $ce4d23=rff7c($ce4d23); $g67daf=rff7c($g67daf); if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE ID = ".((int)$a76f09)."" )) { $e53e61=b0d6b(); if(count($e53e61)!=1) die; $lb19ad=$e53e61[0]; } if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE Keyword = '". q7928($ce4d23) ."' ". "AND (ID != ".((int)$a76f09).")" )) { $e53e61=b0d6b(); if(count($e53e61)==0){ if ($lbb9a8!=$v3c58b){ r7996(); } @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $lb19ad['ID'] = ((int)$a76f09); $lb19ad['Keyword']=$ce4d23; $lb19ad['Description']=$g67daf; if (raa79('Keywords',$lb19ad)) { $h17901=md712( 'set',ENTITY_TYPE_TAG,$lb19ad['ID'],$qa7ff0 ); e2_go_to(r83c8('e2m_tag', array ('tag-alias' => $h17901))); } else { f4930(); } } else { f8a40($_strings['er--cannot-rename-tag'],E2E_USER_ERROR); f4930(); } } else { f4930(); } die; } function e2s_tag_delete(){ global$_strings,$_config; $fb80bb=((int)$_POST['tag-id']); r7996(); @unlink(CACHE_FILENAME_FAVTAGS); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $m444bc=( j0738( "DELETE FROM `". $_config['db_table_prefix']."Keywords` WHERE `ID`=". $fb80bb ) and j0738( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` WHERE `KeywordID`=". $fb80bb ) ); if ($m444bc){ e2_go_to(r83c8('e2m_tags')); die; } else { f4930(); die; } } function raf16($f07f25){ global$_current_tag,$_config; $b9df9d=null; if(CACHE_FAVTAGS and is_file(CACHE_FILENAME_FAVTAGS)) { $b9df9d=@unserialize(file_get_contents(CACHE_FILENAME_FAVTAGS)); } if (!is_array($b9df9d)) { j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE IsFavourite = 1 ORDER BY `Keyword`" ); $h9cdff=b0d6b(); $b9df9d=array(); foreach ($h9cdff as $y04ff0){ $vc6827['tag']=htmlspecialchars($y04ff0['Keyword'],ENT_NOQUOTES,HSC_ENC); $vc6827['href']=r83c8( 'e2m_tag', array ('*tag' => $y04ff0) ); $b9df9d[] = $vc6827; } if(CACHE_FAVTAGS)k6e52(CACHE_FILENAME_FAVTAGS,serialize($b9df9d)); } $d8a4f1=false; foreach ($b9df9d as $w8ce4b => $o9e366){ $b9df9d[$w8ce4b]['current?'] = ( $b9df9d[$w8ce4b]['tag']==$_current_tag ); if ($b9df9d[$w8ce4b]['current?']) { $d8a4f1=true; $n08187=$f07f25; $n08187['flag']='IsFavourite'; $n08187['value']=0; if (ye852()) { $b9df9d[$w8ce4b]['pinnable?']=true; $b9df9d[$w8ce4b]['pinned?']=true; $b9df9d[$w8ce4b]['pinned-toggle-href'] = ( r83c8('e2m_tag_flag_ajax',$n08187) ); } } } if (ye852()) { if (!$d8a4f1 and array_key_exists('*tag',$f07f25)) { $ba55a9=$f07f25; $ba55a9['flag']='IsFavourite'; $ba55a9['value']=1; $md5a7a=array ( 'tag' => htmlspecialchars($f07f25['*tag']['Keyword'],ENT_NOQUOTES,HSC_ENC), 'href' => r83c8('e2m_tag',$f07f25), 'current?' => true, 'pinnable?' => true, 'pinned?' => false, 'pinned-toggle-href' => r83c8('e2m_tag_flag_ajax',$ba55a9), ); $b9df9d[] = $md5a7a; } } return $b9df9d; } function yce23($v21158,$parameters=''){ global$_config; $z0dff3=array(); if (j0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=". ((int)$v21158) ." ". "AND `". $_config['db_table_prefix']."Keywords`.ID=`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `Keyword`" )) { $z0dff3=b0d6b(); } return $z0dff3; } function f53f1($neaa60){ global$_config; $l316e8=array(); foreach (array ( 'ID', 'NoteID', 'KeywordID', ) as $z06e3d) if(array_key_exists($z06e3d,$neaa60)) { $l6a7f2[] = '`'. $z06e3d .'`'."='". q7928($neaa60[$z06e3d]) ."'"; if ($z06e3d=='ID')$l729d6='tagbinging-id'; if ($z06e3d=='NoteID')$l729d6='tagbinging-note-id'; if ($z06e3d=='KeywordID')$l729d6='tagbinging-tag-id'; $l316e8[$l729d6]=$neaa60[$z06e3d]; } $s1b1cc=( "DELETE FROM `". $_config['db_table_prefix']."NotesKeywords` ". "WHERE ". implode(' AND ',$l6a7f2) ); if (j0738($s1b1cc)) { return true; } } function bcbd4($neaa60){ global$_config; if (!array_key_exists('ID',$neaa60) or !is_numeric($neaa60['ID'])) { die ('API MISUSE: e2q_update_tagbinding must be called with an ID field in $tagbinding_record'); } $l6a7f2=array(); foreach (array ( 'NoteID', 'KeywordID', ) as $z06e3d) if(array_key_exists($z06e3d,$neaa60)) { $l6a7f2[] = '`'. $z06e3d .'`'."='". q7928($neaa60[$z06e3d]) ."'"; } if(count($l6a7f2) > 0){ $s1b1cc = "UPDATE `". $_config['db_table_prefix']."NotesKeywords` ". "SET ". implode(', ',$l6a7f2) ." ". "WHERE `ID`=". $neaa60['ID']; if (j0738($s1b1cc)) { return true; } } } function n03de($ce4d23){ @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); $lb19ad=array ( 'Keyword' => $ce4d23, 'OriginalAlias' => md712('find',ENTITY_TYPE_UNSPECIFIED,'',$ce4d23), 'Description' => '', ); if (($lb19ad=f9943('Keywords',$lb19ad)) !== false){ $e419a1=md712( 'set',ENTITY_TYPE_TAG,$lb19ad['ID'],$ce4d23 ); if ($e419a1!=$lb19ad['OriginalAlias']) { $lb19ad['OriginalAlias']=$e419a1; raa79('Keywords',$lb19ad); } return $lb19ad['ID']; } } function t5d57(){ global$_config; $e1c0b7=ye852(); $bd29bb=CACHE_FILENAME_TAGS; if ($e1c0b7)$bd29bb=CACHE_FILENAME_TAGS_AUTHOR; $w8da94=null; if(CACHE_TAGS and is_file($bd29bb)) { $w8da94=@unserialize(file_get_contents($bd29bb)); } if (!is_array($w8da94)) { j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "ORDER BY `Keyword`" ); $k35016=array(); foreach (b0d6b() as $lb19ad){ $ce4d23['tag']=htmlspecialchars($lb19ad['Keyword'],ENT_NOQUOTES,HSC_ENC); $ce4d23['href']=r83c8('e2m_tag', array ('*tag' => $lb19ad)); $ce4d23['favourite?'] = (bool)$lb19ad['IsFavourite']; $ce4d23['notes-count']=0; $ce4d23['last-used']=0; $ce4d23['freshness']=0; $ce4d23['weight']=0; $k35016[$lb19ad['ID']] = $ce4d23; } j0738( "SELECT nk.KeywordID, COUNT(DISTINCT n.ID) as Count, max(n.Stamp) as LastUsed ". "FROM `". $_config['db_table_prefix']."NotesKeywords` nk, ". "`". $_config['db_table_prefix']."Notes` n ". "WHERE nk.NoteID = n.ID AND n.IsPublished ". ($e1c0b7? "":"AND n.IsVisible=1 "). "GROUP BY nk.KeywordID" ); $s9fdd5=0; $n8f57c=0; $g06894=0; foreach (b0d6b() as $o28a42){ $vc6827 =& $k35016[$o28a42['KeywordID']]; $vc6827['notes-count']=$o28a42['Count']; if (@$vc6827['last-used'] < $o28a42['LastUsed']) { $vc6827['last-used']=$o28a42['LastUsed']; $f452b4=(time()-$vc6827['last-used']) / SECONDS_IN_A_YEAR; $vc6827['freshness']=pow(1/2,$f452b4); } $s9fdd5=max($s9fdd5,$vc6827['notes-count']); $n8f57c=max($n8f57c,$vc6827['freshness']); $g06894=max($g06894,$vc6827['notes-count']*$vc6827['freshness']); } $w8da94=array(); foreach ($k35016 as $q865c0 => $o9e366){ if (!$e1c0b7 and $o9e366['notes-count']==0) continue; $a95e80=mb_strtolower($o9e366['tag']); $w8da94[$a95e80]=$o9e366; if ($n8f57c!=0){ $w8da94[$a95e80]['freshness']=$o9e366['freshness']/$n8f57c; } else { $w8da94[$a95e80]['freshness']=0; } if ($g06894!=0){ $w8da94[$a95e80]['weight'] = ( $o9e366['freshness']*$o9e366['notes-count']/$g06894 ); } else { $w8da94[$a95e80]['weight']=0; } if ($w8da94[$a95e80]['favourite?'])$w8da94[$a95e80]['weight']=1; } if(CACHE_TAGS)k6e52($bd29bb,serialize($w8da94)); } return $w8da94; } function ra463($v21158,$hda3ad='Keyword'){ global$_config; if (j0738( "SELECT `". $_config['db_table_prefix']."Keywords`.* ". "FROM `". $_config['db_table_prefix']."Keywords`, ". "`". $_config['db_table_prefix']."NotesKeywords` ". "WHERE `". $_config['db_table_prefix']."NotesKeywords`.NoteID=".((int)$v21158)." AND ". "`". $_config['db_table_prefix']."Keywords`.ID=". "`". $_config['db_table_prefix']."NotesKeywords`.KeywordID ". "ORDER BY `".$hda3ad."`" ))$pfa816=b0d6b(); else $pfa816=array(); $z59aeb=array(); foreach ($pfa816 as $ie358e)$z59aeb[] = $ie358e; return $z59aeb; } function y0188($od7df5){ global$_config; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='".q7928($od7df5)."'" )) { $w8ce4b=b0d6b(); if (isset ($w8ce4b[0])) return $w8ce4b[0]; } return null; } function v8770($ed7ca3){ global$_config; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `OriginalAlias`='".q7928($ed7ca3)."'" )) $pfa816=b0d6b(); else $pfa816=array(); if (isset ($pfa816[0])) return $pfa816[0]; else return FALSE; } function o4e28($fb80bb){ global$_config; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `ID`='".((int)$fb80bb)."'" )) { $w8ce4b=b0d6b(); if (isset ($w8ce4b[0])) { $w8ce4b=$w8ce4b[0]; return $w8ce4b; } else { return NULL; } } return NULL; } function e2_tagrecs_with_parameters_($parameters){ $dbdcf3=array(); if (@$parameters['tag-alias']) { $dbdcf3=explode(',',$parameters['tag-alias']); } $z0dff3=array(); foreach ($dbdcf3 as $ed7ca3) if ($ed7ca3){ if ( $wc45dd=e2_aliasrec_of_alias_(@$ed7ca3) and ($wc45dd['EntityType']==ENTITY_TYPE_TAG) ) { $z0dff3[] = o4e28($wc45dd['EntityID']); } else { if ($p3ee3f=v8770($ed7ca3)) { $z0dff3[] = $p3ee3f; } } } return $z0dff3; } function e2m_comment($parameters=array ()) { e2_go_to(r83c8('e2m_note',$parameters)); die; } function e2m_comment_edit($parameters=array ()) { return i4fb7('edit',$parameters); } function e2m_note_comment($parameters=array ()) { return i4fb7('write',$parameters); } function i4fb7($u60cd8,$parameters=array ()) { global$_config,$_strings,$full_blog_url; $vd5d3d=$cf74f5=$_strings['pt--new-comment']; $o69b97='new'; if ($u60cd8=='edit'){ $q4032b=e2_commentrec_with_parameters_($parameters); $sc50d0=$_strings['fb--save-changes']; $h39a37=$q4032b['noterec']; $vd5d3d=$cf74f5=$_strings['pt--edit-comment']; $o69b97=$qaca8d['ID']; if (!$q4032b){ return e2_error404_mode(); } $w80f02=array ( '.note-id' => $q4032b['NoteID'], '.comment-id' => $q4032b['ID'], '.already-subscribed?' => false, '.from' => substr($_SERVER['HTTP_REFERER'],strlen($full_blog_url)+1), 'create:edit?' => false, 'form-action' => r83c8('e2s_comment_process'), 'submit-text' => $sc50d0, 'show-subscribe?' => true, 'subscribe?' => (bool)$q4032b['IsSubscriber'], 'name' => htmlspecialchars($q4032b['AuthorName'],ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($q4032b['AuthorEmail'],ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($q4032b['Text'],ENT_COMPAT,HSC_ENC), 'email-field-name' => 'elton-john', ); if (''!=trim($q4032b['IP'])) { $w80f02['ip']=$q4032b['IP']; $w80f02['ip-href']=$_config['whois_service'].$w80f02['ip']; } } else { $h39a37=$parameters['*note']; $w80f02=p66aa($h39a37); } return array ( 'title' => $vd5d3d, 'heading' => $cf74f5, 'form' => 'form-comment', 'form-comment' => $w80f02, ); } function e2m_comment_reply($parameters=array ()) { global$_strings; $q4032b=e2_commentrec_with_parameters_($parameters); if (!$q4032b){ return e2_error404_mode(); } $h39a37=$q4032b['noterec']; $s1aec6=d86f8($h39a37,$q4032b,$parameters['comment-number']); $s1aec6['_']['_id']=$q4032b['ID']; $s1aec6['_']['_ord']=0; $s1aec6['_']['_ord_max']=0; $s1aec6['replying?'] = (bool)true; $u817c7=($q4032b['Reply']=='' or !$q4032b['IsReplyVisible']); $vd5d3d=$u817c7? $_strings['pt--reply-to-comment']:$_strings['pt--edit-reply-to-comment']; $j4dc70=array ( '.note-id' => $h39a37['ID'], '.comment-id' => $q4032b['ID'], '.reply-action' => $u817c7? 'new':'edit', 'form-action' => r83c8('e2s_comment_edit_reply'), 'submit-text' => $u817c7? $_strings['fb--publish']:$_strings['fb--save-changes'], 'create:edit?' => (bool) ($u817c7), 'reply-text' => htmlspecialchars($q4032b['Reply'],ENT_COMPAT,HSC_ENC), 'mail-back?' => (bool) ($u817c7), ); return array ( 'title' => $vd5d3d, 'heading' => $vd5d3d, 'comments' => array ('only' => $s1aec6), 'form' => 'form-comment-reply', 'form-comment-reply' => $j4dc70, ); } function e2m_comment_delete($parameters=array ()) { global$_strings,$settings,$fcbcce,$_config; $q4032b=e2_commentrec_with_parameters_($parameters); $v21158=$q4032b['NoteID']; if (!$q4032b){ return e2_error404_mode(); } e2_drop_caches_for_note_($v21158); @unlink(USER_FOLDER. '/last-comment.psa'); j0738( "DELETE FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".((int)$q4032b['ID'])."'" ); f4930(); die; } function e2m_comment_reply_delete($parameters=array ()) { global$_strings,$settings,$_config; $q4032b=e2_commentrec_with_parameters_($parameters); if (!$q4032b){ return e2_error404_mode(); } j0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='', ". "`IsReplyFavourite`='0' ". "WHERE `ID`=".((int)$q4032b['ID']) ); f4930(); die; } function e2m_unsubscribe($parameters){ global$_strings,$_config; $c70a17="ORDER BY `ID` DESC"; $h39a37=$parameters['*note']; $v21158=$h39a37['ID']; $l0c83f=$parameters['unsubscribe-email']; $b1bc29=$parameters['unsubscribe-key']; $l0c83f=str_replace(' ','+',$l0c83f); if ($v21158){ if (j0738( "SELECT `ID`, `Stamp` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". $v21158 ." AND `IsSubscriber`=1 AND `AuthorEmail`='". $l0c83f ."' ". $c70a17 )) { $result=b0d6b(); if(count($result) < 1) { $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--you-are-not-subscribed']; } else { $a06d4c=@$result[0]; $s97f69=md5($a06d4c['ID'].$a06d4c['Stamp'] .'x'); $b260ca=false; if ($b1bc29==$s97f69){ if (j0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET `IsSubscriber`=0 ". "WHERE `NoteID`=". $v21158 ." AND `AuthorEmail` = '".q7928($l0c83f)."'" )) { $b260ca=true; $v2cb9d['unsubscribe']['success?']=true; $v2cb9d['unsubscribe']['note-title']=t6f10( htmlspecialchars($h39a37['Title'],ENT_COMPAT,HSC_ENC) ); $v2cb9d['unsubscribe']['note-href']=r83c8( 'e2m_note', array ('*note' => $h39a37) ); } } if (!$b260ca){ $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--unsubscription-didnt-work']; } } } else { $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--comment-not-found']; } } else { $v2cb9d['unsubscribe']['success?']=false; $v2cb9d['unsubscribe']['error-message']=$_strings['gs--post-not-found']; } return $v2cb9d; } function e2m_comment_flag($parameters){ a6e30($parameters); e2_go_to(r83c8('e2m_note',$parameters)); die; } function e2m_comment_flag_ajax($parameters){ if (a6e30($parameters)) { $r67142=$parameters; $r67142['value'] = !$parameters['value']; if($parameters['value']==1){ $q99859=r83c8('e2m_comment_flag_ajax',$r67142); $d1fa03='on-rehref|'. $q99859; } else { $q99859=r83c8('e2m_comment_flag_ajax',$r67142); $d1fa03='off-rehref|'. $q99859; } } else { $d1fa03='error'; } if(array_key_exists('result',$_POST) and ($_POST['result']=='ajaxresult')) { die ($d1fa03); } else { e2_go_to(r83c8('e2m_note',$parameters)); die; } } function a6e30($parameters){ $q4032b=e2_commentrec_with_parameters_($parameters); $v21158=$q4032b['NoteID']; $result=false; if ($q4032b){ $result=raa79('Comments', array ( 'ID' => $q4032b['ID'], $parameters['flag'] => (int) ($parameters['value']==1), )); e2_drop_caches_for_note_($v21158); } return$result; } function e2s_comment_process(){ global$_strings,$_fp_error; list ($v21158,$o69b97,$x9d090)=z1a90(); if(__LOG)__log('Comments: processed, noteid <'. $v21158 .'>, commentid <'. $o69b97 .'>'); if (!$o69b97){ $d05c36=''; if($_fp_error==FP_NOT_COMMENTABLE){ f8a40($_strings['er--post-not-commentable'],E2E_USER_ERROR); } elseif($_fp_error==FP_EMPTY_FIELD){ f8a40($_strings['er--name-email-text-required'],E2E_USER_ERROR); } elseif($_fp_error==FP_COMMENT_TOO_LONG){ $oaa731=$_strings['gs--comment-too-long']; $d05c36=$_strings['gs--comment-too-long-description']; } elseif($_fp_error==FP_COMMENT_DOUBLE_POST){ $oaa731=$_strings['gs--comment-double-post']; $d05c36=$_strings['gs--comment-double-post-description']; } elseif($_fp_error==FP_COMMENT_SPAM_SUSPECT){ $oaa731=$_strings['gs--comment-spam-suspect']; $d05c36=$_strings['gs--comment-spam-suspect-description']; } else { f8a40($_strings['er--error-occurred'].' ('. $_fp_error .')'); } if ($d05c36){ $v2cb9d['title']=$oaa731; $v2cb9d['heading']=$oaa731; $v2cb9d['form']='form-unaccepted-comment'; $v2cb9d['form-unaccepted-comment'] = array ( 'reason' => $d05c36, 'text' => @htmlspecialchars($x9d090['text'],ENT_COMPAT,HSC_ENC), ); return $v2cb9d; } } if ($v21158){ e2_go_to(r83c8('e2m_note', array ('*note' => n4627($v21158)))); } else { e2_go_to(); } die; } function e2s_comment_edit_reply(){ global$_strings,$s57de2,$_config; $ne84af=@$_POST['text']; if(trim($ne84af)=='')$ne84af=''; $v21158=@$_POST['note-id']; $laad65=n4627($v21158); $o69b97=@$_POST['comment-id']; $a06d4c=fb559($o69b97); $e54eb6=isset ($_POST['mail-back']); $o54fa9=time(); if (@$_POST['reply-action']=='new'){ $me0e30=time(); } @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments-author')); if ($a06d4c and j0738( "UPDATE `". $_config['db_table_prefix']."Comments` SET ". "`Reply`='". q7928($ne84af) ."', ". ( isset ($me0e30)? ( "`ReplyStamp`='". $me0e30 ."', " ) : ( "" ) ). "`ReplyLastModified`='". $o54fa9 ."', ". "`IsReplyVisible`='1' ". "WHERE `ID`=".((int)$o69b97) )) { $cd58c0=r83c8('e2m_note', array ('*note' => $laad65)); if ($e54eb6 and $ne84af!=''){ $vc6827['comment-time'] = array ($a06d4c['Stamp'],m5c05()); $vc6827['commenter']=$a06d4c['AuthorName']; $vc6827['commenter-email']=$a06d4c['AuthorEmail']; $vc6827['comment-text']=$a06d4c['Text']; $vc6827['note-title']=t6f10($laad65['Title']); $vc6827['reply-time'] = array (time(),m5c05()); $vc6827['blog-author']=v2640(); $vc6827['note-href']=$cd58c0; $vc6827['comment-href']=$cd58c0; $vc6827['reply-text']=$ne84af; if(1){ $tde7a3=w3e5c( 'comment-reply',$vc6827 ); $ib904c=e2l_get_string( 'em--comment-reply', $vc6827 ); $b77613=$a06d4c['AuthorEmail']; $p1a49b='From: '. jaed2(); xa41b($b77613,$ib904c,$tde7a3,$p1a49b); } if(1){ unset ($vc6827['commenter-email']); $p1a49b='From: '. jaed2(); foreach (w4975($laad65,$a06d4c['AuthorEmail']) as $m39c63){ $iba570=$m39c63['AuthorEmail']; $a6fd85=md5($m39c63['ID'].$m39c63['Stamp'].'x'); $vc6827['unsubscribe-href']=r83c8('e2m_unsubscribe', array ( '*note' => $laad65, 'unsubscribe-email' => $iba570, 'unsubscribe-key' => $a6fd85, ) ); $b77613=$iba570; $tde7a3=w3e5c('comment-reply-to-public',$vc6827); $ib904c=e2l_get_string( 'em--comment-reply-to-public-subject', $vc6827 ); xa41b($b77613,$ib904c,$tde7a3,$p1a49b); } } } e2_go_to($cd58c0); } else { f4930(); } die; } function d86f8($laad65,$a06d4c,$cb1bc2=false){ global$_config; if(__LOG)__log('Comments: package comment <'. $a06d4c['ID'] .'>...'); if ($laad65===null){ $laad65=n4627($a06d4c['NoteID']); } if ($cb1bc2!==false)$vc6827['number']=$cb1bc2; $vc6827['name']=htmlspecialchars($a06d4c['AuthorName'],ENT_NOQUOTES,HSC_ENC); if (ye852()) { $vc6827['email']=htmlspecialchars($a06d4c['AuthorEmail'],ENT_NOQUOTES,HSC_ENC); if (''!=trim($a06d4c['IP'])) { $vc6827['ip']=$a06d4c['IP']; $vc6827['ip-href']=$_config['whois_service'].$vc6827['ip']; } } $vc6827['author-name']=v2640(); $vc6827['visible?'] = (bool)$a06d4c['IsVisible']; $vc6827['important?'] = (bool)$a06d4c['IsFavourite']; $vc6827['reply-visible?'] = (bool) ($a06d4c['IsVisible'] && $a06d4c['IsReplyVisible']); $vc6827['reply-important?'] = (bool)$a06d4c['IsReplyFavourite']; $vc6827['spam-suspect?'] = (bool)$a06d4c['IsSpamSuspect']; $z10a7e=array ((int)$a06d4c['Stamp'],j0923($laad65)); $vc6827['time']=$z10a7e; $vc6827['last-modified']=$z10a7e; if ($a06d4c['LastModified']) $vc6827['last-modified'] = array ((int)$a06d4c['LastModified'],j0923($laad65)); if ($a06d4c['ReplyStamp']) $vc6827['reply-time'] = array ((int)$a06d4c['ReplyStamp'],j0923($laad65)); if ($a06d4c['ReplyLastModified']) $vc6827['reply-last-modified'] = array ((int)$a06d4c['ReplyLastModified'],j0923($laad65)); if (ye852()) { $vc6827['subscriber?'] = (bool)$a06d4c['IsSubscriber']; $vc6827['new?'] = (bool)$a06d4c['IsNew']; $vc6827['first-new?']=false; if ($a06d4c['IsFavourite']) { $vc6827['important-toggle-href']=r83c8( 'e2m_comment_flag_ajax', array ('*note' => $laad65,'comment-number' => $cb1bc2,'flag' => 'IsFavourite','value' => 0) ); } else { $vc6827['important-toggle-href']=r83c8( 'e2m_comment_flag_ajax', array ('*note' => $laad65,'comment-number' => $cb1bc2,'flag' => 'IsFavourite','value' => 1) ); } if ($a06d4c['IsReplyFavourite']) { $vc6827['reply-important-toggle-href']=r83c8( 'e2m_comment_flag_ajax', array ( '*note' => $laad65,'comment-number' => $cb1bc2,'flag' => 'IsReplyFavourite','value' => 0 ) ); } else { $vc6827['reply-important-toggle-href']=r83c8( 'e2m_comment_flag_ajax', array ( '*note' => $laad65,'comment-number' => $cb1bc2,'flag' => 'IsReplyFavourite','value' => 1 ) ); } $vc6827['edit-href']=r83c8( 'e2m_comment_edit', array ('*note' => $laad65,'comment-number' => $cb1bc2) ); $vc6827['removed-toggle-href']=r83c8( 'e2m_comment_flag_ajax', array ( '*note' => $laad65,'comment-number' => $cb1bc2, 'flag' => 'IsVisible','value' => !$a06d4c['IsVisible'] ) ); $vc6827['removed-reply-toggle-href']=r83c8( 'e2m_comment_flag_ajax', array ( '*note' => $laad65,'comment-number' => $cb1bc2, 'flag' => 'IsReplyVisible','value' => !$a06d4c['IsReplyVisible'] ) ); $be36ef=r83c8( 'e2m_comment_reply', array ('*note' => $laad65,'comment-number' => $cb1bc2) ); if ($a06d4c['Reply']=='' or !$a06d4c['IsReplyVisible']) { $vc6827['reply-href']=$be36ef; } else { $vc6827['edit-reply-href']=$be36ef; } } if(mb_strlen($a06d4c['Text']) > $_config['max_comment_length']) { $a06d4c['Text']=mb_substr($a06d4c['Text'],0,$_config['max_comment_length']); } $s2bfe4=p154e($laad65['FormatterID'],$a06d4c['Text'],'simple'); $vc6827['text']=$s2bfe4['text-final']; $vc6827['replying?'] = (bool)false; $vc6827['replied?'] = (bool) ( (trim($a06d4c['Reply']) != '') && ($a06d4c['IsReplyVisible']) ); $s2bfe4=p154e($laad65['FormatterID'],$a06d4c['Reply'],'full'); $vc6827['reply']=$s2bfe4['text-final']; if(array_key_exists('_',$a06d4c))$vc6827['_']=$a06d4c['_']; if(__LOG)__log('Comments: done'); return $vc6827; } function fb559($fb80bb){ global$_config; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `ID` = '".$fb80bb."'" )) { $pfa816=b0d6b(); if(count($pfa816) > 0) return $pfa816[0]; } return false; } function se5b6($c0604c){ e2_comment_set_flag('IsVisible',$c0604c); } function m3183($p0dd2c){ e2_comment_set_flag('IsReplyVisible',$p0dd2c); } function p66aa($iea59a){ global$_strings; $he3cb9=@$_COOKIE[l8c3b('commenter_name')]; $gf92ee=@$_COOKIE[l8c3b('commenter_email')]; $h3d682=@$_COOKIE[l8c3b('commenter_ph')]; $d92399=false; if ($gf92ee and cookie_unsubscribe_key){ foreach (w4975($iea59a) as $m39c63){ $s97f69=md5($m39c63['ID'].$m39c63['Stamp'] .'x'); if ( $m39c63['AuthorEmail']==$gf92ee and $h3d682==$s97f69 ){ $d92399=true; break; } } } $sc50d0=$_strings['fb--submit']; $w80f02=array ( '.note-id' => $iea59a['ID'], '.comment-id' => 'new', '.already-subscribed?' => (bool)$d92399, 'create:edit?' => true, 'form-action' => r83c8('e2s_comment_process'), 'submit-text' => $sc50d0, 'show-subscribe?' => (bool) !$d92399, 'subscribe?' => (bool)$d92399, 'subscription-status' => $d92399? $_strings['gs--you-are-already-subscribed']:'', 'visible?' => true, 'email-field-name' => 'elton-john', 'nospam-field-name' => 'first-name', 'name' => htmlspecialchars($he3cb9,ENT_COMPAT,HSC_ENC), 'email' => htmlspecialchars($gf92ee,ENT_COMPAT,HSC_ENC), 'text' => htmlspecialchars($a06d4c['Text'],ENT_COMPAT,HSC_ENC), ); return $w80f02; } function s254f($v21158,$odaf19=0){ global$_config; if (!$odaf19)$ff79b1=' AND `IsVisible`=1'; if ('all'===$odaf19){ $ff79b1=''; } if ('new'===$odaf19){ $ff79b1=' AND `IsNew`=1'; } $nbc751=0; if (j0738( "SELECT count(*) FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$v21158 . @$ff79b1 )) { $result=b0d6b(); $result=(int)$result[0]['count(*)']; $nbc751=$result; } return (int)$nbc751; } function n2a6b(){ global$_config; $ye2942=0; $x7ec7e=''; $he8fab=''; if (j0738( "SELECT `NoteID`, `Text` FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `IsNew`=1 ORDER BY `Stamp`" )) { $result=b0d6b(); $ye2942=count($result); if ($ye2942){ $v21158=$result[0]['NoteID']; $he8fab=r83c8( 'e2m_note', array ('*note' => n4627($v21158)) ); } else { $he8fab=''; } } return array ((int)$ye2942,$x7ec7e,$he8fab); } function d1baf($v21158,$l641f6){ global$_config; if(__LOG)__log('Comments: getting comments for note '. $v21158); if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$v21158." ". @$ff79b1 ." ". $l641f6 )) { $result=b0d6b(); return$result; } return array (); } function w4975($laad65,$fd1cc6=''){ global$_config; $c70a17="ORDER BY `ID` DESC"; $v2cb9d=$haf67c=array(); if (j0738( "SELECT DISTINCT `ID`, `Text`, `IsSubscriber`, `AuthorName`, `AuthorEmail`, `Stamp` ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `NoteID`=". @$laad65['ID'] ." ". "AND `IsSubscriber`=1 ". "AND `AuthorEmail`!='". q7928($fd1cc6) ."' ". $c70a17 )) { $result=b0d6b(); foreach($result as $m39c63){ if (!in_array($m39c63['AuthorEmail'],$haf67c)) { $v2cb9d[] = $m39c63; } $haf67c[] = $m39c63['AuthorEmail']; } } return $v2cb9d; } function hb387($laad65,$a3f917=NOTE_COMMENTABLE_NOW){ global$settings,$_config; $cbdb20=true; if (@$settings['comments']['fresh_only']) if (isset ($_config['comment_freshness_days'])) if ($laad65['Stamp'] < time()-$_config['comment_freshness_days']*SECONDS_IN_A_DAY) $cbdb20=false; $xc770a=$laad65['IsCommentable']; if ($a3f917==NOTE_COMMENTABLE_NOW_CONDITIONALLY){ $xc770a=true; } return ( $laad65['IsPublished'] and $laad65['IsVisible'] and $cbdb20 and $xc770a ); } function e2_commentrec_with_parameters_($parameters=array ()) { $h39a37=$parameters['*note']; $wa5d49=d1baf($h39a37['ID'],"ORDER BY `Stamp`"); $q4032b=@$wa5d49[$parameters['comment-number']-1]; if ($q4032b){ $q4032b['noterec']=$h39a37; return $q4032b; } } function z1a90($i98ea6=''){ global$settings,$fcbcce,$_config,$_fp_error; $_fp_error=false; $ube16c='elton-john'; $v21158=$o69b97=$lb0689=$l0c83f=$e1cb25=''; if(array_key_exists('note-id',$_POST)) $v21158=trim(@$_POST['note-id']); if(array_key_exists('comment-id',$_POST)) $o69b97=trim(@$_POST['comment-id']); if(array_key_exists('name',$_POST)) $lb0689=trim(@$_POST['name']); if(array_key_exists($ube16c,$_POST)) $l0c83f=trim(@$_POST[$ube16c]); if(array_key_exists('text',$_POST)) $e1cb25=trim(@$_POST['text']); $lb0689=rff7c($lb0689); $e1cb25=rff7c($e1cb25); $z07d3d=( (array_key_exists('already-subscribed',$_POST) and $_POST['already-subscribed']) or (array_key_exists('subscribe',$_POST) and $_POST['subscribe']) ); $d20612=time(); $x9d090['text']=$e1cb25; if ($o69b97=='new'){ gc64a('commenter_name',$lb0689); gc64a('commenter_email',$l0c83f); } $y848b5=($o69b97=='new' and ( (array_key_exists('email',$_POST) and $_POST['email']!=='')) or (!array_key_exists('first-name',$_POST) or ($_POST['first-name']!=='') )); $zc2b1a=1; $result=false; if (!is_numeric($v21158)) { $_fp_error=FP_NO_ID_OR_NEW; } elseif (!is_numeric($o69b97) and !($o69b97=='new')) { $_fp_error=FP_NO_ID_OR_NEW; } else { if ($o69b97 and $lb0689=='' or $l0c83f=='' or $e1cb25==''){ $_fp_error=FP_EMPTY_FIELD; } if ($o69b97=='new'){ $a795f1=@unserialize(file_get_contents(USER_FOLDER. '/last-comment.psa')); if(md5($lb0689.$l0c83f.$e1cb25)==$a795f1['md5']) { $_fp_error=FP_COMMENT_DOUBLE_POST; } if ( isset ($_config['max_comment_length']) and strlen(@$_POST['text']) > ($_config['max_comment_length']) ){ $_fp_error=FP_COMMENT_TOO_LONG; } $h39a37=n4627($v21158); if ($o69b97=='new' and !hb387($h39a37)) { $_fp_error=FP_NOT_COMMENTABLE; } if ($y848b5){ $_fp_error=FP_COMMENT_SPAM_SUSPECT; } } } if (!$_fp_error){ e2_drop_caches_for_note_($v21158); if ($o69b97=='new'){ $q4032b=array ( 'NoteID' => (int)$v21158, 'AuthorName' => $lb0689, 'AuthorEmail' => $l0c83f, 'Text' => $e1cb25, 'Reply' => '', 'IsVisible' => 1, 'IsAnswerAware' => 1, 'IsSubscriber' => (int)$z07d3d, 'IsSpamSuspect' => (int)$y848b5, 'IsNew' => (int)$zc2b1a, 'Stamp' => (int)time(), 'LastModified' => (int)time(), 'IP' => q7928($_SERVER['REMOTE_ADDR']), ); if (($q4032b=f9943('Comments',$q4032b)) !== false){ $o69b97=$q4032b['ID']; $a795f1=array ( 'id' => $o69b97, 'md5' => md5($lb0689.$l0c83f.$e1cb25), ); @k6e52(USER_FOLDER. 'last-comment.psa',serialize($a795f1)); $result=(int)$o69b97; $q303ee=md5($q4032b['ID'].$q4032b['Stamp'].'x'); gc64a('commenter_ph',$q303ee); $b60422=s254f($v21158,'all')-1+1; $laad65=n4627($v21158); $cd58c0=r83c8('e2m_note', array ('*note' => $laad65)); $vc6827['comment-time'] = array ($d20612,m5c05()); $vc6827['commenter']=$lb0689; $vc6827['commenter-email']=$l0c83f; $vc6827['comment-text']=$e1cb25; $vc6827['note-title']=$laad65['Title']; $vc6827['note-href']=$cd58c0; $vc6827['comment-href']=$cd58c0; $vc6827['comments-disable-href']=r83c8('e2m_note_flag', array ( '*note' => $laad65, 'flag' => 'IsCommentable', 'value' => 0 )); $vc6827['reply-href']=r83c8( 'e2m_comment_reply', array ('*note' => $laad65,'comment-number' => $b60422) ); if (isset ($settings['user']['email']) and @$settings['notifications']['new_comments']) { $tde7a3=w3e5c( 'comment-new-to-author',$vc6827 ); $ib904c=e2l_get_string( 'em--comment-new-to-author-subject', $vc6827 ); $b77613=$settings['user']['email']; $p1a49b = 'From: '. jaed2() ."\r\n". 'Reply-to: '. $lb0689 .' <'. $l0c83f .">"; xa41b($b77613,$ib904c,$tde7a3,$p1a49b); } if (!$y848b5){ unset ($vc6827['commenter-email']); $p1a49b='From: '. jaed2(); foreach (w4975($laad65,$l0c83f) as $m39c63){ $iba570=$m39c63['AuthorEmail']; $a6fd85=md5($m39c63['ID'].$m39c63['Stamp'].'x'); $vc6827['unsubscribe-href']=r83c8('e2m_unsubscribe', array ( '*note' => $laad65, 'unsubscribe-email' => $iba570, 'unsubscribe-key' => $a6fd85 ) ); $b77613=$iba570; $tde7a3=w3e5c('comment-new-to-public',$vc6827); $ib904c=e2l_get_string( 'em--comment-new-to-public-subject', $vc6827 ); xa41b($b77613,$ib904c,$tde7a3,$p1a49b); } } } else { $_fp_error=FP_INSERT_ERROR; } } else { $mfd6f3=array ( 'ID' => $o69b97, 'AuthorName' => $lb0689, 'AuthorEmail' => $l0c83f, 'Text' => $e1cb25, 'IsSubscriber' => ((int)$z07d3d), 'LastModified' => time(), ); if (raa79('Comments',$mfd6f3)) { $result=(int)$o69b97; } else { $_fp_error=FP_UPDATE_ERROR; }; } } if ($i98ea6=='ajaxresult') return $d1fa03; else return array ((int)$v21158,$result,$x9d090); } function e2m_most_commented(){ global$settings,$_strings,$_config; $oa0acf=@$_GET['period']; if ($oa0acf=='')$oa0acf=$_config['hot_period']; $t632a2=time()-q35c3($oa0acf); $ff79b1="AND `IsVisible`=1 "; if (ye852())$ff79b1=''; return od864(array ( 'query' => "SELECT `IsVisible`, `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE (`Stamp` > ". $t632a2.") ". $ff79b1. "GROUP BY `NoteID` ". "ORDER BY c ". "DESC ". "LIMIT ".$settings['appearance']['notes_per_page'], 'query-returns-only-ids' => 1, 'limit' => $settings['appearance']['notes_per_page'], 'title' => e2l_get_string('pt--most-commented', array ('period' => $oa0acf)), 'heading' => e2l_get_string('pt--most-commented', array ('period' => $oa0acf)), 'nothing' => $_strings['gs--no-such-notes'], )); } function e2m_favourites($parameters=array ()) { global$_config,$_strings; $ff79b1="AND `IsVisible`=1 "; if (ye852())$ff79b1=''; return od864(array ( 'query' => "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsFavourite`=1 ". $ff79b1 . "ORDER BY `Stamp` DESC", 'page' => $parameters['page'], 'candy' => 'e2m_favourites', 'parameters' => $parameters, 'title' => $_strings['pt--favourites'], 'heading' => $_strings['pt--favourites'], 'nothing' => $_strings['gs--no-favourites'], )); } function q35c3($oa0acf){ if ('year'==$oa0acf) return SECONDS_IN_A_YEAR; elseif ('month'==$oa0acf) return SECONDS_IN_A_MONTH; elseif ('week'==$oa0acf) return SECONDS_IN_A_DAY*7; elseif ('day'==$oa0acf) return SECONDS_IN_A_DAY; else return PHP_INT_MAX; } function o8696($k8d777){ global$_current_url; if(__LOG)__log('Arbitrary list ('. $k8d777['_log'] .') {'); $se919a=s7f78(); $if4ac8=null; if ($k8d777['cache'] and is_file($k8d777['cache-filename'])) { $if4ac8=@unserialize(file_get_contents($k8d777['cache-filename'])); } $hf957e=true; if ($k8d777['cache-filename-expires']) { if ($k8d777['cache'] and is_file($k8d777['cache-filename-expires'])) { $f07cc6=time(); $w09bcb=(int) @file_get_contents($k8d777['cache-filename-expires']); if(__LOG)__log('List expires '. date('r',$w09bcb) .', now '. date('r',$f07cc6)); $hf957e=($f07cc6 < $w09bcb); } } $tdbb0c=array(); if ($k8d777['cache'] and is_array($if4ac8) and $hf957e){ if(__LOG)__log('Retrieve cached ctree'); $tdbb0c=$if4ac8; } else { if(__LOG)__log('Assemle cacheable ctree...'); $q4358b=array(); if (j0738($k8d777['query'])) { $result=b0d6b(); foreach($result as $w8ce4b => $h39a37){ $h39a37=n4627($h39a37['ID']); if ($h39a37['IsVisible'] and $h39a37['IsPublished']) { $laad65['_']['_id']=$h39a37['ID']; $laad65['_']['_ord']=$w8ce4b; $laad65['_']['_ord_max']=count($result)-1; $laad65['href']=r83c8('e2m_note', array ('*note' => $h39a37)); $laad65['time'] = array ($h39a37['Stamp'],j0923($h39a37)); $laad65['title']=t6f10(htmlspecialchars($h39a37['Title'],ENT_NOQUOTES,HSC_ENC)); $tdbb0c[] = $laad65; } } $if4ac8=$tdbb0c; if ($k8d777['cache']) { @k6e52($k8d777['cache-filename'],serialize($if4ac8)); if ($k8d777['cache-filename-expires']) { @k6e52($k8d777['cache-filename-expires'],time()+$k8d777['expires-after']); } } } } foreach ($tdbb0c as $w8ce4b => $o9e366){ $tdbb0c[$w8ce4b]['current?'] = ($tdbb0c[$w8ce4b]['href']==$_current_url); } if(__LOG)__log('} // Arbitrary list @ '. round(s7f78()-$se919a,3)); return $tdbb0c; } function z09d1(){ global$_config; $t632a2=time()-q35c3($_config['hot_period']); return o8696(array ( '_log' => 'most_commented', 'cache' => CACHE_HOT, 'cache-filename' => CACHE_FILENAME_HOT, 'cache-filename-expires' => CACHE_FILENAME_HOT_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT `Stamp`, `NoteID` ID, count(*) c ". "FROM `". $_config['db_table_prefix']."Comments` ". "WHERE `Stamp` > ". $t632a2 ." AND IsVisible='1'". "GROUP BY `NoteID` ". "ORDER BY c DESC LIMIT 10" ), )); } function x0256(){ global$_config; $t632a2=time()-q35c3($_config['popular_period']); return o8696(array ( '_log' => 'most_read', 'cache' => CACHE_POPULAR, 'cache-filename' => CACHE_FILENAME_POPULAR, 'cache-filename-expires' => CACHE_FILENAME_POPULAR_EXPIRES, 'expires-after' => SECONDS_IN_A_DAY, 'query' => ( "SELECT n.`ID`, n.`Title`, n.`IsFavourite`, a.`EntityID`, SUM(a.`HitCount`) HitCount ". "FROM `". $_config['db_table_prefix']."Actions` a, ". "`". $_config['db_table_prefix']."Notes` n  ". "WHERE a.`Stamp` > ". $t632a2 ." ". "AND a.`EntityID` = n.`ID` ". "GROUP BY a.`EntityID` ". "ORDER BY `IsFavourite` DESC, HitCount DESC ". "LIMIT 10" ), )); } function e2m_password(){ global$settings,$_strings; $v2cb9d['title']=$_strings['pt--password']; $v2cb9d['heading']=$_strings['pt--password-for-blog']; $v2cb9d['form']='form-password'; $v2cb9d['form-password'] = array ( 'form-action' => r83c8('e2s_password_save'), 'submit-text' => $_strings['fb--change'], ); return $v2cb9d; } function e2m_sessions(){ global$settings,$_strings; $o2d6d8=x7785(); $v2cb9d['title']=$_strings['pt--sessions']; $v2cb9d['heading']=$_strings['pt--sessions']; $u161bc=array(); $n3c6e0=$_COOKIE[l8c3b('key')]; foreach ($o2d6d8['sessions'] as $w8ce4b => $o9e366){ $u161bc[] = array ( 'current?' => h4c49($n3c6e0)===$o9e366['key_hash'], 'opened' => array ((int)$o9e366['stamp'],v3211()), 'ip-address' => $o9e366['remote_ip'], 'source' => ($o9e366['remote_ip']=='127.0.0.1')? $_strings['gs--locally']:$o9e366['remote_ip'], 'title' => vcc31($o9e366['ua']), 'user-agent' => $o9e366['ua']? $o9e366['ua']:$_strings['gs--unknown'], ); } $u161bc=array_reverse($u161bc); $v2cb9d['sessions']['each']=$u161bc; if(count($u161bc) > 1){ $v2cb9d['form']='form-sessions'; $v2cb9d['form-sessions'] = array ( 'form-action' => r83c8('e2s_drop_other_sessions'), 'submit-text' => $_strings['fb--end-all-sessions-but-this'], ); } return $v2cb9d; } function e2m_sign_in(){ if (ye852()) { e2_go_to(r83c8('e2m_frontpage', array ('page' => 1))); } else { return array (); } } function e2m_sign_out(){ global$_strings; $o2d6d8=x7785(); $r48bb9=-1; if(array_key_exists('sessions',$o2d6d8) and is_array($o2d6d8['sessions'])) { foreach ($o2d6d8['sessions'] as $w8ce4b => $o9e366){ $n3c6e0=$_COOKIE[l8c3b('key')]; if (h4c49($n3c6e0)===$o9e366['key_hash']) { $r48bb9=$w8ce4b; break; } } } if ($r48bb9 > -1) unset ($o2d6d8['sessions'][$r48bb9]); if (!p1d21($o2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } gc64a('key',''); e2_go_to(); die; } function e2s_password_save(){ global$settings,$_strings; $s0512f=trim($_POST['old-password']); if (sa8cf($s0512f)) { $d88162=trim($_POST['new-password']); if ($d88162!=''){ if (@k6e52(USER_FOLDER. '/password-hash.psa',serialize(h4c49($d88162)))) { f8a40($_strings['gs--password-changed'],E2E_MESSAGE); e2_go_to(); } else { f8a40($_strings['er--could-not-change-password'],E2E_PERMISSIONS_ERROR); e2_go_to(r83c8('e2m_password')); } } else { f8a40($_strings['er--no-password-entered'],E2E_USER_ERROR); e2_go_to(r83c8('e2m_password')); } } else { f8a40($_strings['er--wrong-password'],E2E_USER_ERROR); e2_go_to(r83c8('e2m_password')); } die; } function e2s_sign_in_necessary(){ e2_go_to(r83c8('e2m_sign_in')); die; } function e2s_sign_in(){ global$_strings; $o2d6d8=x7785(); if($_SERVER['REQUEST_METHOD']=='POST'){ $f5f4dc=@$_POST['password']; $c6bc8e=@$_POST['is_public_pc']; } else { $f5f4dc=@$_GET['password']; $c6bc8e=false; } if (sa8cf($f5f4dc)) { $y21d6f=array ( 'stamp' => time(), 'remote_ip' => $_SERVER['REMOTE_ADDR'], 'key_hash' => ee8ed($c6bc8e), 'ua' => $_SERVER['HTTP_USER_AGENT'], ); $o2d6d8['sessions'][] = $y21d6f; } elseif(strlen(trim($f5f4dc)) > 0){ ra711(); f8a40($_strings['er--wrong-password'],E2E_USER_ERROR); } if (!p1d21($o2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); e2_go_to(); die; } f4930(); die; } function e2s_drop_other_sessions(){ global$_strings; $o2d6d8=x7785(); foreach ($o2d6d8['sessions'] as $w8ce4b => $o9e366){ $n3c6e0=$_COOKIE[l8c3b('key')]; if (h4c49($n3c6e0)===$o9e366['key_hash']) { $y21d6f=$o9e366; break; } } $o2d6d8['sessions'] = array ($y21d6f); if (!p1d21($o2d6d8)) { f8a40($_strings['er--cannot-write-auth-data'],E2E_PERMISSIONS_ERROR); } f4930(); die; } function sa8cf($f5f4dc){ $j8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); return (h4c49($f5f4dc)===$j8e9a8 and trim($f5f4dc)!=''); } function ee8ed($z2a2a4=false){ global$settings; $n3c6e0=n2a24(); $r3f363=h4c49($n3c6e0); gc64a('key',$n3c6e0, !$z2a2a4); return $r3f363; } function ye852(){ global $e1c0b7,$settings,$_auth_sessions; if (isset ($e1c0b7)) return $e1c0b7; $e1c0b7=false; if (isset ($_COOKIE[l8c3b('key')])) { $n3c6e0=$_COOKIE[l8c3b('key')]; $o2d6d8=x7785(); $v0f83b=array(); if(array_key_exists('sessions',$o2d6d8) and is_array($o2d6d8['sessions'])) { foreach ($o2d6d8['sessions'] as $y21d6f){ $v0f83b[] = $y21d6f['key_hash']; } $_auth_sessions['count']=count($o2d6d8['sessions']); } if(1){ $e1c0b7=(bool)in_array(h4c49($n3c6e0),$v0f83b,true); } if (!$e1c0b7){ gc64a('key',''); } } return $e1c0b7; } function h4c49($j25d90){ if(function_exists('sha1')) { return sha1($j25d90); } else { return substr(md5($j25d90).md5(' '.$j25d90),0,40); } } function x7785(){ if(is_file(USER_FOLDER.'auth.psa')) { $o2d6d8=unserialize(@file_get_contents(USER_FOLDER.'auth.psa')); if ($o2d6d8) return $o2d6d8; } return array (); } function p1d21($o2d6d8){ return k6e52(USER_FOLDER.'auth.psa',serialize($o2d6d8)); } function pc3fb(){ if ($n3c6e0=$_COOKIE[l8c3b('key')]) { return l8c3b('key') .'='. $n3c6e0 .""; } } function cff2e(){ if ($n3c6e0=$_COOKIE[l8c3b('key')]) { return 'Cookie: '. l8c3b('key') .'='. $n3c6e0 ."\r\n"; } return "\r\n"; } function vcc31($b5269f){ global$_strings; if(strstr($b5269f,'iPhone')) return$_strings['gs--ua-iphone']; if(strstr($b5269f,'iPad')) return$_strings['gs--ua-ipad']; if(strstr($b5269f,'Opera'))$v2cb9d=$_strings['gs--ua-opera']; if(strstr($b5269f,'Firefox'))$v2cb9d=$_strings['gs--ua-firefox']; if(strstr($b5269f,'Chrome'))$v2cb9d=$_strings['gs--ua-chrome']; if(strstr($b5269f,'Safari') and !strstr($b5269f,'Chrome'))$v2cb9d=$_strings['gs--ua-safari']; if (!$v2cb9d)$v2cb9d=$_strings['gs--ua-unknown']; if(strstr($b5269f,'Macintosh')) { if ($v2cb9d)$v2cb9d.=' '. $_strings['gs--ua-for-mac']; } return $v2cb9d; } function e2j_check_password(){ $j8e9a8=@unserialize(file_get_contents(USER_FOLDER. '/password-hash.psa')); $f5f4dc=''; if(array_key_exists('password',$_POST))$f5f4dc=$_POST['password']; ra711(); if (h4c49($f5f4dc)===$j8e9a8 and trim($f5f4dc)!=''){ die ('password-correct'); } die ('password-wrong'); } function n2a24(){ $pb04ec=''; $ab8d1b='0123456789abcdef'; for ($q865c0=0; $q865c0 < 40; $q865c0++)$pb04ec.=$ab8d1b[mt_rand(0,15)]; $pb04ec.=time(); $pb04ec=h4c49($pb04ec); return $pb04ec; } function ra711(){ if(is_file(USER_FOLDER. 'password-wait.psa')) { $caf788=unserialize( file_get_contents(USER_FOLDER. '/password-wait.psa') ); if ($caf788['delay'] < 5){ $caf788['delay'] ++; } if(time()-$caf788['time'] > SECONDS_IN_A_MINUTE){ $caf788['delay']=0; } $caf788['time']=time(); } else { $caf788=array ( 'time' => time(), 'delay' => 5, ); } k6e52(USER_FOLDER.'password-wait.psa',serialize($caf788)); sleep($caf788['delay']); } function a7874(){ return md5('seсret'); } function m1305($zb45cf){ $n3c6e0=a7874(); $h16ec1=strlen($n3c6e0); $x2db95=strlen($zb45cf); $v2cb9d=''; for ($q865c0=0; $q865c0 < $x2db95+rand(16,64); ++ $q865c0){ if ($q865c0 > $x2db95){ $e462e1=rand(0,127); } elseif ($q865c0==$x2db95){ $e462e1=0; } else { $e462e1=ord($zb45cf[$q865c0]); } $r18e1b=chr(($e462e1+ord($n3c6e0[$q865c0%$h16ec1])) % 256); $v2cb9d.=$r18e1b; } $v2cb9d=base64_encode($v2cb9d); return $v2cb9d; } function wee85($zb45cf){ $n3c6e0=a7874(); $h16ec1=strlen($n3c6e0); $zb45cf=base64_decode($zb45cf); $x2db95=strlen($zb45cf); $v2cb9d=''; for ($q865c0=0; $q865c0 < $x2db95; ++ $q865c0){ $kd9468=(ord($zb45cf[$q865c0]) + 256-ord($n3c6e0[$q865c0%$h16ec1])) % 256; if ($kd9468===0) break; $v2cb9d.=chr($kd9468); } return $v2cb9d; } $_candies_installer=array ( 'e2s_build', 'e2m_info', 'e2m_install', 'e2j_check_db_config', 'e2j_list_databases', 'e2s_instantiate', 'e2s_install', 'e2s_update_perform', ); $_candies_public=array ( 'e2m_info', 'e2m_frontpage', 'e2m_rss', 'e2m_json', 'e2m_note', 'e2m_note_json', 'e2m_note_comment', 'e2m_draft_preview', 'e2m_tags', 'e2m_tag', 'e2m_tag_rss', 'e2m_tag_json', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_comments', 'e2m_everything', 'e2m_year', 'e2m_month', 'e2m_day', 'e2m_unsubscribe', 'e2m_sign_out', 'e2m_theme_preview', 'e2s_sign_in', 'e2s_comment_process', 'e2s_search', 'e2s_bsi_step', 'e2j_check_password', 'e2s_notify', ); $_candies_to_disallow_in_read_only=array ( 'e2m_write', 'e2m_note_edit', 'e2s_note_process', 'e2s_note_publish', 'e2s_note_delete', 'e2m_note_flag_favourite', 'e2m_note_flag', 'e2m_note_comment', 'e2m_comment_edit', 'e2m_comment_delete', 'e2m_comment_reply', 'e2m_comment_reply_delete', 'e2m_comment_flag', 'e2m_comment_flag_ajax', 'e2m_unsubscribe', 'e2s_comment_process', 'e2m_settings', 'e2m_timezone', ); $_candies_public=array_merge($_candies_public,$_candies_installer); $_candies_indexable=array ( 'e2m_note', ); $_candies_indexable_conditionally=array ( 'e2m_frontpage', 'e2m_tag', 'e2m_favourites', 'e2m_most_commented', 'e2m_found', 'e2m_tags', 'e2m_everything', ); $_candies_ajax=array ( 'e2j_check_db_config', 'e2j_list_databases', 'e2j_check_password', 'e2j_userpic_upload', 'e2j_file_upload', 'e2j_file_remove', 'e2j_note_livesave', 'e2m_note_flag_favourite', 'e2m_comment_flag_ajax', 'e2m_tag_flag_ajax', ); function e2_modes($parameters){ global$content,$_strings; if (!is_array($parameters))$parameters=array(); if(array_key_exists('~',$parameters)) { $w71860=$parameters['~']; } if(e2_is_installed()) { if(__LOG)__log('Popular and tags menu {'); if (!$content['popular']) { $content['popular'] = array ( 'title' => $_strings['nm--most-read'], ); $content['popular']['each']=x0256(); } if(count($content['popular']['each']) < 10) unset($content['popular']['each']); if (!$content['tags']) { $content['tags']['each']=t5d57(); $content['tags']['many?']=count($content['tags']['each']) > KEYWORDS_MANY_THRESH; $content['tags']['menu-each']=raf16($parameters); } if(__LOG)__log('} // Popular and tags menu'); } } function b6f51(){ global$settings,$_strings; if ( array_key_exists('site_title',$settings) and trim($settings['site_title']) != '' ){ return trim($settings['site_title']); } else { return$_strings['e2--default-blog-title']; } } function v2640(){ global$settings,$_strings; if ( array_key_exists('author',$settings) and trim($settings['author']) != '' ){ return trim($settings['author']); } else { return$_strings['e2--default-blog-author']; } } function b2461(){ global$full_blog_url; if(is_file(USER_FOLDER .'userpic@2x.png')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.png'; } elseif(is_file(USER_FOLDER .'userpic@2x.jpg')) { return$full_blog_url .'/'. USER_FOLDER .'userpic@2x.jpg'; } else { return false; } } function e2m_info(){ global$settings,$_config,$s57de2,$ya57c1,$_template; $lf1f71=array ( 'E2_VERSION' => E2_VERSION, 'E2_RELEASE' => E2_RELEASE, 'E2_UA_STRING' => E2_UA_STRING, '---', 'PHP_VERSION' => PHP_VERSION, '---', 'installed' => (bool)e2_is_installed(), 'server_name' => $s57de2, 'folder_on_server' => $ya57c1, '---', 'request_logging' => $_config['request_logging'], 'default formatter' => $_config['default_formatter'], '---', 'theme' => $settings['template'], '---', 'Olba name' => $_template['name'], 'Olba max_image_width' => $_template['max_image_width'], 'Olba stack' => $_template['stack'], '---', 'Neasden' => substr(md5(file_get_contents('system/neasden/neasden.php')), 0,4), '---', ); echo '<pre>'; foreach ($lf1f71 as $w8ce4b => $o9e366){ if ($o9e366=='---'){ echo "\n"; continue; } echo str_pad($w8ce4b,24); echo '\''; print_r($o9e366); echo '\''; echo "\n"; } echo '</pre>'; die; } function e2s_notify(){ global$_config; if($_config['holborn']) { $d4de32=@$_GET['src']; if ($d4de32==''){ if(__LOG)__log('Holborn: No src URL'); die; } $m466de=file_get_contents($d4de32); $m466de=u09a6($m466de); $we13b0=json_decode($m466de,true); if (!$we13b0){ if(__LOG)__log('Holborn: No meaningful info from '. $d4de32 .' ('. json_last_error() .')'); if ($g13bc3=hdd69($d4de32)) { if(__LOG)__log('Holborn: Delete note with ID '. $g13bc3['ID']); ae268($g13bc3['ID'],false); } die; } a927d($we13b0,$d4de32); } die; } function e2m_source_trust($parameters){ global$_config; $b0afd9=$parameters['source']; j0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=1 ". "WHERE `ID`=". $b0afd9 ); j0738( "UPDATE  ". $_config['db_table_prefix']."Notes ". "SET `IsPublished`=1 ". "WHERE `SourceID`=". $b0afd9 ); y198f(); r7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_premoderate($parameters){ global$_config; $b0afd9=$parameters['source']; j0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsTrusted`=0 ". "WHERE `ID`=". $b0afd9 ); r7996(); e2_go_to(''); die; } function e2m_source_ban($parameters){ global$_config; $b0afd9=$parameters['source']; j0738( "UPDATE  ". $_config['db_table_prefix']."Sources ". "SET `IsWhiteListed`=0, `IsTrusted`=0 ". "WHERE `ID`=". $b0afd9 ); j0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $b0afd9 ); r7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function e2m_source_forget($parameters){ global$_config; $b0afd9=$parameters['source']; j0738( "DELETE FROM  ". $_config['db_table_prefix']."Sources ". "WHERE `ID`=". $b0afd9 ); j0738( "DELETE FROM  ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`=". $b0afd9 ); r7996(); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); e2_go_to(''); die; } function a927d($we13b0,$d4de32){ if(__LOG)__log('Holborn: Note info == '. print_r($we13b0,true)); if (@$we13b0['items']) { if(__LOG)__log('Holborn: JSON feed format'); $fa4a84=b10cd(array ( 'author' => $we13b0['author']['name'], 'title' => $we13b0['title'], 'href' => $we13b0['author']['url'], 'userpic-href' => $we13b0['author']['avatar'], )); if (!$fa4a84['IsWhiteListed']) return; if(preg_match('/\+(\d\d)\:(\d\d)/',$we13b0['items'][0]['date_published'],$v9c28d)) { $i7a86c=$v9c28d[1]*SECONDS_IN_AN_HOUR+$v9c28d[2]*SECONDS_IN_A_MINUTE; } $i929cf=@$we13b0['items'][0]['_e2_data'] or $i929cf=array(); $i929cf=json_encode($i929cf); $h39a37=array ( 'Title' => $we13b0['items'][0]['title'], 'Text' => $we13b0['items'][0]['content_html'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => strtotime($we13b0['items'][0]['date_published']), 'Offset' => (int)$i7a86c, 'IsDST' => 0, 'LastModified' => strtotime($we13b0['items'][0]['date_modified']), 'IsCommentable' => 0, 'IsPublished' => $fa4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $fa4a84['ID'], 'SourceNoteID' => $we13b0['items'][0]['id'], 'SourceNoteURL' => $we13b0['items'][0]['url'], 'SourceNoteJSONURL' => $d4de32, 'SourceNoteData' => $i929cf, ); $v21158=$we13b0['items'][0]['id']; } else { if(__LOG)__log('Holborn: legacy custom format'); $r03396=@$we13b0['blog']; $fa4a84=b10cd($r03396); if (!$fa4a84['IsWhiteListed']) return; $i929cf=@$we13b0['note']['og-images'] or $i929cf=array(); $i929cf['og_images']=$i929cf; $i929cf=json_encode($i929cf); $h39a37=array ( 'Title' => $we13b0['note']['title'], 'Text' => $we13b0['note']['text'], 'FormatterID' => 'raw', 'OriginalAlias' => '', 'Uploads' => '', 'Stamp' => $we13b0['note']['time'][0], 'Offset' => (int)$we13b0['note']['time'][1]['offset'], 'IsDST' => (int)$we13b0['note']['time'][1]['is_dst'], 'LastModified' => $we13b0['note']['last-modified'][0], 'IsCommentable' => 0, 'IsPublished' => $fa4a84['IsTrusted'], 'IsExternal' => 1, 'SourceID' => $fa4a84['ID'], 'SourceNoteID' => $we13b0['note']['id'], 'SourceNoteURL' => $we13b0['note']['href'], 'SourceNoteJSONURL' => $d4de32, 'SourceNoteData' => $i929cf, ); $v21158=$we13b0['note']['id']; } if ( $g13bc3=lf25e($fa4a84['ID'],$v21158) ) { $h39a37['ID']=$g13bc3['ID']; raa79('Notes',$h39a37); } else { $h39a37=f9943('Notes',$h39a37); } pd2e1($h39a37); e2_drop_caches_for_note_($h39a37['ID']); @unlink(CACHE_FILENAME_DRAFTS); @unlink(CACHE_FILENAME_DRAFTS_ALIAS_USE_COUNTS); tcc38(r83c8('e2s_dump', array ())); } function hdd69($d4de32){ global$_config; $result=j0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceNoteJSONURL`='". $d4de32 ."' ". "LIMIT 1" ); $result=b0d6b(); return$result[0]; } function lf25e($b0afd9,$rbb971){ global$_config; $result=j0738( "SELECT `ID` FROM ". $_config['db_table_prefix']."Notes ". "WHERE `SourceID`= '". $b0afd9 ."' ". "AND `SourceNoteID`= '". $rbb971 ."' ". "LIMIT 1" ); $result=b0d6b(); return$result[0]; } function u09a6($m466de){ for ($q865c0=0; $q865c0 <= 31; ++$q865c0){ $m466de=str_replace(chr($q865c0),'',$m466de); } $m466de=str_replace(chr(127),'',$m466de); if(0===strpos(bin2hex($m466de),'efbbbf')) { $m466de=substr($m466de,3); } return $m466de; } function b10cd($r03396){ global$_config; $v305c2=false; $result=j0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `URL`= '". $r03396['href'] ."' ". "LIMIT 1" ); $result=b0d6b(); if(count($result)) { $v305c2=$result[0]; if ($v305c2['ID']!=$v305c2['TrueID']) { $result=j0738( "SELECT * FROM ". $_config['db_table_prefix']."Sources ". "WHERE `ID`= '". $v305c2['TrueID'] ."' ". "LIMIT 1" ); $result=b0d6b(); if(count($result)) { $v305c2=$result[0]; } } } $fa4a84=array ( 'Title' => $r03396['title'], 'AuthorName' => $r03396['author'], 'PictureURL' => $r03396['userpic-href'], ); if ($v305c2!==false){ if ( $v305c2['Title']!==$r03396['title'] or $v305c2['AuthorName']!==$r03396['author'] or $v305c2['PictureURL']!==$r03396['userpic-href'] ) { $fa4a84['ID']=$v305c2['ID']; raa79('Sources',$fa4a84); } return $v305c2; } else { $fa4a84['URL']=$r03396['href']; $fa4a84['IsWhiteListed']=1; $fa4a84['IsTrusted']=0; $fa4a84=f9943('Sources',$fa4a84); $fa4a84['TrueID']=$fa4a84['ID']; raa79('Sources',$fa4a84); return $fa4a84; } } function w1a48($h39a37,$h34d5a=false){ global$_config; $vc6827=array(); if (@$h39a37['IsExternal']) { if(array_key_exists('SourceID',$h39a37)) { if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Sources` ". "WHERE `ID` = '". $h39a37['SourceID'] ."'" )) { $pfa816=b0d6b(); } $vc6827['source']=$pfa816[0]['Title']; $vc6827['source-id']=$h39a37['SourceID']; $vc6827['source-true-id']=$pfa816[0]['TrueID']; $vc6827['source-whitelisted?']=$pfa816[0]['IsWhiteListed']; $vc6827['source-trusted?']=$pfa816[0]['IsTrusted']; if (!$pfa816[0]['IsTrusted']) { $vc6827['source-trust-url']=r83c8( 'e2m_source_trust', array ('source' => $h39a37['SourceID']) ); } if ($pfa816[0]['IsTrusted']) { $vc6827['source-premoderate-url']=r83c8( 'e2m_source_premoderate', array ('source' => $h39a37['SourceID']) ); } $vc6827['source-ban-url']=r83c8( 'e2m_source_ban', array ('source' => $h39a37['SourceID']) ); $vc6827['source-forget-url']=r83c8( 'e2m_source_forget', array ('source' => $h39a37['SourceID']) ); $vc6827['author']=$pfa816[0]['AuthorName']; $vc6827['author-href']=$pfa816[0]['URL']; $vc6827['userpic-href']=$pfa816[0]['PictureURL']; } if ($h34d5a){ if(array_key_exists('SourceNoteURL',$h39a37) and @$h39a37['SourceNoteURL']!=''){ $vc6827['href']=$h39a37['SourceNoteURL']; $vc6827['href-original']=$h39a37['SourceNoteURL']; } } } return $vc6827; } function e2m_frontpage($parameters=array ()) { global$settings,$_config,$_strings; $w71860=$parameters['page']; $sd7e5d=$settings['appearance']['notes_per_page']; $t06d2e=o8ca0(true,true); if (ye852())$t06d2e+=o8ca0(true,false); $vae0fe=ceil($t06d2e/$sd7e5d); $bd29bb=CACHE_FILENAME_FRONTPAGE; if (ye852())$bd29bb=CACHE_FILENAME_FRONTPAGE_AUTHOR; if ($w71860 < 1) return e2_error404_mode(); if(CACHE_FRONTPAGE and $w71860==1 and is_file($bd29bb)) { $q4358b=@unserialize(file_get_contents($bd29bb)); } if(CACHE_FRONTPAGE and $w71860==1 and is_array($q4358b)) { } else { if (($result=o7573($w71860)) === false){ f8a40($_strings['er--cannot-show-latest-notes'],E2E_DATABASE_ERROR); return array ( 'title' => htmlspecialchars(b6f51(),ENT_NOQUOTES,HSC_ENC), ); } $q4358b=array(); if(count($result) > 0){ foreach($result as $w8ce4b => $laad65){ $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_title']=$laad65['Title']; $laad65['_']['_ord']=$w8ce4b; $laad65['_']['_ord_max']=count($result)-1; $le244c=r6791($laad65); $q4358b[] = $le244c; } } else { if ($w71860!=1) return e2_error404_mode(); } if(CACHE_FRONTPAGE and $w71860==1)k6e52($bd29bb,serialize($q4358b)); } $pb3b32['timeline?']=true; $pb3b32['count']=$vae0fe; $pb3b32['this'] = (int)$w71860; if ($vae0fe > 1){ if ($w71860 < $vae0fe)$pb3b32['earlier-href']=r83c8('e2m_frontpage', array ('page' => $w71860+1)); if ($w71860 > 1)$pb3b32['later-href']=r83c8('e2m_frontpage', array ('page' => $w71860-1)); $pb3b32['earlier-title']=$_strings['gs--earlier']; $pb3b32['later-title']=$_strings['gs--later']; } $vd5d3d=b6f51(); return array ( 'frontpage?' => (bool) ($w71860==1), 'title' => $vd5d3d, 'notes' => $q4358b, 'pages' => $pb3b32, ); } function o7573($w71860=1){ global$settings,$_config; $ob01a5=$pd5566; $q8b7af='all'; if (!ye852()) { $u25715="AND `IsVisible`=1 "; $q8b7af='visible'; } $ob01a5.='_'.$q8b7af; $z19ee4=($w71860-1)*$settings['appearance']['notes_per_page']; $saa9f7=$z19ee4 .', '. $settings['appearance']['notes_per_page']; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " .@$u25715. "ORDER BY `Stamp` DESC ". "LIMIT ". $saa9f7 )) { $result=b0d6b(); return$result; } else { return false; } } function e2m_json($parameters=array ()) { list ($pb9076,$d20612)=mab26(); $m466de=json_encode($pb9076,E2_JSON_STYLE); c8ec5($m466de,$d20612,'json'); } function e2m_rss($parameters=array ()) { list ($pb9076,$d20612)=mab26(); $r8bb85=e2feeds__rss_using_jsonfeed_array_($pb9076); c8ec5($r8bb85,$d20612,'rss'); } function e2m_tag_json($parameters=array ()) { if(array_key_exists('*tag',$parameters)) { $lb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($pb9076,$d20612)=se229($lb19ad); $m466de=json_encode($pb9076,E2_JSON_STYLE); c8ec5($m466de,$d20612,'json'); } function e2m_tag_rss($parameters=array ()) { global$settings,$_config,$_strings; if(array_key_exists('*tag',$parameters)) { $lb19ad=$parameters['*tag']; } else { return e2_error404_mode(); } list ($pb9076,$d20612)=se229($lb19ad); $r8bb85=e2feeds__rss_using_jsonfeed_array_($pb9076); c8ec5($r8bb85,$d20612,'rss'); } function e2m_note_json($parameters=array ()) { global$settings,$_current_url; $h39a37=$parameters['*note']; if ($h39a37==false){ return e2_error404_mode(); } $h39a37['_']['_id']=$h39a37['ID']; $d20612=$h39a37['Stamp']; $a7da21=e2_jsonfeed_item_array_from_noterec_($h39a37); $i0bf08=array ($a7da21); $pb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($i0bf08); $pb9076['title']=$settings['site_title']; $pb9076['home_page_url']=r83c8('e2m_frontpage', array ('page' => 1)); $pb9076['feed_url']=$_current_url; c8ec5(json_encode($pb9076,E2_JSON_STYLE),$d20612,'json'); } function e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($i0bf08){ return array ( 'version' => 'https://jsonfeed.org/version/1', 'title' => null, 'home_page_url' => null, 'feed_url' => null, 'icon' => b2461(), 'author' => array ( 'name' => v2640(), 'url' => r83c8('e2m_frontpage', array ('page' => 1)), 'avatar' => b2461(), ), 'items' => $i0bf08, '_e2_version' => E2_VERSION, '_e2_ua_string' => E2_UA_STRING, ); } function e2_jsonfeed_item_array_from_noterec_($h39a37){ global$settings; $h39a37['_']['_id']=$h39a37['ID']; $x572d4=r83c8('e2m_note', array ('*note' => $h39a37)); $i803d0=( ga846('Y-m-d\TH:i:s',$h39a37['Stamp']) . qd536($h39a37['Stamp'],':') ); $wade16=( ga846('Y-m-d\TH:i:s',$h39a37['LastModified']) . qd536($h39a37['LastModified'],':') ); $p316ec=( ga846('D, d M Y H:i:s ',$h39a37['Stamp']) . qd536($h39a37['Stamp']) ); $s2bfe4=p154e($h39a37['FormatterID'], @$h39a37['Text'],'full-rss'); $sad965=edbcc( 'note',$h39a37['_']['_id'], $s2bfe4['meta']['resources-detected'] ); $se70c4=array ( 'id' => (string)$h39a37['ID'], 'url' => $x572d4, 'title' => t6f10(htmlspecialchars($h39a37['Title'],ENT_NOQUOTES)), 'content_html' => $s2bfe4['text-final'], 'date_published' => $i803d0, 'date_modified' => $wade16, ); if ($h39a37['IsExternal']) { $r60d40=w1a48($h39a37); $se70c4['url']=$r60d40['href']; $se70c4['author'] = array ( 'name' => $r60d40['author'], 'url' => $r60d40['author-href'], 'avatar' => $r60d40['userpic-href'], ); } if(count($sad965) > 0){ $se70c4['image']=$sad965[0]; } $se70c4['_date_published_rfc2822']=$p316ec; if ($h39a37['Stamp'] < $settings['v3223_rss_permalinks_before_stamp']) { $se70c4['_rss_guid_is_permalink']='true'; $se70c4['_rss_guid']=$se70c4['url']; } else { $se70c4['_rss_guid_is_permalink']='false'; $se70c4['_rss_guid'] = (string)$h39a37['ID']; } $se70c4['_e2_data'] = array ( 'is_favourite' => (bool)$h39a37['IsFavourite'], 'links_required' => $s2bfe4['meta']['links-required'], 'og_images' => $sad965, ); return $se70c4; } function x3010($m7a402,$vd5d3d,$he8fab){ global$_newsfeeds; $zfc0f6=''; if ($m7a402=='rss')$zfc0f6='application/rss+xml'; if ($m7a402=='json')$zfc0f6='application/json'; $o336a4=array ( 'type' => $zfc0f6, 'title' => htmlspecialchars($vd5d3d,ENT_NOQUOTES,HSC_ENC), 'href' => $he8fab ); $_newsfeeds[] = $o336a4; } function bed63(){ global$_config; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND `IsVisible`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". $_config['rss_items'] )) { $result=b0d6b(); return$result; } } function mab26(){ global$settings,$_current_url; $d20612=0; $i0bf08=array(); $pb9076=array(); $bd29bb=CACHE_FILENAME_FRONTPAGE_FEED; if(CACHE_FRONTPAGE_FEED and is_file($bd29bb)) { if(__LOG)__log('Feed array (RSS, JSON): cached'); $pb9076=@unserialize(file_get_contents($bd29bb)); $d20612=filemtime($bd29bb); } else { if(__LOG)__log('Feed array (RSS, JSON): not cached, will need to build'); if (($bc2d18=bed63()) !== false){ foreach ($bc2d18 as $h39a37){ $i0bf08[] = e2_jsonfeed_item_array_from_noterec_($h39a37); $d20612=max($d20612,$h39a37['Stamp']); } $pb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($i0bf08); $pb9076['title']=$settings['site_title']; $pb9076['home_page_url']=r83c8('e2m_frontpage', array ('page' => 1)); $pb9076['feed_url']=$_current_url; if(CACHE_FRONTPAGE_FEED)k6e52($bd29bb,serialize($pb9076)); } } return array ($pb9076,$d20612); } function se229($lb19ad){ global$settings,$_config,$_strings,$_current_url; $d20612=0; $i0bf08=array(); if ((j0738( "SELECT `". $_config['db_table_prefix']."Notes`.* ". "FROM `". $_config['db_table_prefix']."Notes` ". "INNER JOIN `". $_config['db_table_prefix']."NotesKeywords` ". "ON `". $_config['db_table_prefix']."NotesKeywords`.NoteID=`". $_config['db_table_prefix']."Notes`.ID ". "WHERE (`". $_config['db_table_prefix']."NotesKeywords`.KeywordID=". $lb19ad['ID'] .") ". "ORDER BY `". $_config['db_table_prefix'] ."Notes`.`Stamp` DESC ". "LIMIT ". $_config['rss_items'] )) !== false){ $bc2d18=b0d6b(); foreach ($bc2d18 as $h39a37){ $i0bf08[] = e2_jsonfeed_item_array_from_noterec_($h39a37); $d20612=max($d20612,$h39a37['Stamp']); } $pb9076=e2_jsonfeed_array_stub_from_jsonfeed_item_arrays_($i0bf08); $pb9076['title'] = ( $settings['site_title'] .', '. $_strings['gs--posts-tagged'] .': '. $lb19ad['Keyword'] ); $pb9076['home_page_url']=r83c8('e2m_tag', array ('*tag' => $lb19ad)); $pb9076['feed_url']=$_current_url; } return array ($pb9076,$d20612); } function e2feeds__rss_using_jsonfeed_array_($content){ $v92eac=DEFAULTS_FOLDER.'rss/rss.tmpl.php'; if(is_file($v92eac)) { ob_start(); include $v92eac; $r8bb85=ob_get_contents(); ob_end_clean(); } return $r8bb85; } function k99a9($r8bb85){ $r8bb85=str_replace("\x0",'',$r8bb85); for ($q865c0=0; $q865c0 < strlen($r8bb85); ++$q865c0){ if(ord($r8bb85[$q865c0]) < 32 and !in_array(ord($r8bb85[$q865c0]), array (10,13))) { $r8bb85[$q865c0]=''; } } return $r8bb85; } function c8ec5($d321c3,$d20612,$m7a402){ $l69a10=gmdate('r',$d20612); $e1872a=md5($d20612); if ($m7a402=='rss'){ if(RSS_AS_TEXT){ header('Content-Type: text/plain'); } else { header('Content-type: application/xml; charset=utf-8'); } } elseif ($m7a402=='json'){ header('Content-Type: application/json'); } else { header('Content-Type: text/plain'); } header('Last-modified: '. $l69a10); header('Etag: '. $e1872a); header('Cache-Control: public'); header('Expires: '. date('r',$d20612+SECONDS_IN_A_DAY)); $b0c3cd=isset($_SERVER['HTTP_IF_MODIFIED_SINCE'])? stripslashes($_SERVER['HTTP_IF_MODIFIED_SINCE']) : false; $bc3522=isset($_SERVER['HTTP_IF_NONE_MATCH'])? stripslashes($_SERVER['HTTP_IF_NONE_MATCH']) : false; if ( !$b0c3cd && !$bc3522 or $bc3522 && $bc3522!=$e1872a or $b0c3cd && $b0c3cd!=$l69a10 ){ if ($m7a402=='rss'){ $r8bb85=k99a9($r8bb85); } echo $d321c3; } else { header('HTTP/1.1 304 Not Modified'); } die; } function e2m_year($parameters=array ()) { global$_strings,$_config; $n84cdc=$parameters['year']; $f09d6c=e2l_get_string('pt--nth-year', array ('year' => $n84cdc)); if (!m1665($n84cdc)) { return e2_error404_mode(); } $ve6e7d=gmmktime(0,0,0,1,1,$n84cdc-1); $v029bd=gmmktime(0,0,0,1,1,$n84cdc+1); list ($u8aebd,$e5a7f3)=e2__fruitful_neighbours_with_ymd_($n84cdc); $ja6d40='e2m_year'; if ($u8aebd){ $pb3b32['prev-href']=r83c8( $ja6d40,e2__parameters_with_timestamp_($u8aebd) ); $pb3b32['prev-jump?'] = (bool) (gmdate('Y',$ve6e7d)!=gmdate('Y',$u8aebd)); $pb3b32['prev-title']=gmdate('Y',$u8aebd); } if ($e5a7f3){ $pb3b32['next-href']=r83c8( $ja6d40,e2__parameters_with_timestamp_($e5a7f3) ); $pb3b32['next-jump?'] = (bool) (gmdate('Y',$v029bd)!=gmdate('Y',$e5a7f3)); $pb3b32['next-title']=gmdate('Y',$e5a7f3); } $pb3b32['timeline?']=false; $pb3b32['this']=$n84cdc; $pb3b32['this-title']=$n84cdc; $vb2442=acc02('start'); $y8dbc7=acc02('end'); if ( $n84cdc==f5a2f('Y',$vb2442['stamp'],$vb2442['timezone']) ) { $ufa098=f5a2f('m',$vb2442['stamp'],$vb2442['timezone']); } else { $ufa098=1; } if ( $n84cdc==ga846('Y',time()) ) { $ifd384=ga846('m',time()); } else { $ifd384=12; } $n6eac3=wb92c($n84cdc); for ($k7436f=1; $k7436f <= 12; ++ $k7436f){ $f7f769=gmmktime(0,0,0,$k7436f,1,$n84cdc); $hd039b[$k7436f] = array ( 'number' => $k7436f, 'start-time' => array ($f7f769,v3211()), 'href' => gmdate('Y/m/',$f7f769), 'real?' => $k7436f >= $ufa098 and $k7436f <= $ifd384, 'fruitful?' => @in_array(gmdate('n',$f7f769),$n6eac3), ); } list ($x7b314,$ka1f20)=b5273($n84cdc); j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $x7b314 ." ". "AND ". $ka1f20 ." ". "ORDER BY `Stamp`" ); $result=b0d6b(); $q4358b=y28df($result,$n84cdc); $v2cb9d=array ( 'title' => $f09d6c, 'heading' => $f09d6c, 'pages' => $pb3b32, 'year' => (int)$n84cdc, 'year-months' => $hd039b, ); if(count($q4358b)) { $v2cb9d['notes-list']=$q4358b; } else { $v2cb9d['nothing']=$_strings['gs--no-such-notes']; } return $v2cb9d; } function e2m_month($parameters=array ()) { global$_strings,$_config; $n84cdc= $parameters['year']; $k7436f=$parameters['month']; $f09d6c=e2l_get_string( 'pt--nth-month-of-nth-year', array ('year' => $n84cdc,'month' => $k7436f) ); if (!m1665($n84cdc,$k7436f)) { return e2_error404_mode(); } $ve6e7d=gmmktime(0,0,0,$k7436f-1,1,$n84cdc); $v029bd=gmmktime(0,0,0,$k7436f+1,1,$n84cdc); list ($u8aebd,$e5a7f3)=e2__fruitful_neighbours_with_ymd_($n84cdc,$k7436f); $ja6d40='e2m_month'; if ($u8aebd){ $pb3b32['prev-href']=r83c8( $ja6d40,e2__parameters_with_timestamp_($u8aebd) ); $pb3b32['prev-jump?'] = (bool) (gmdate('Y/m',$ve6e7d)!=gmdate('Y/m',$u8aebd)); $pb3b32['prev-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$u8aebd),'month' => gmdate('n',$u8aebd) ) ); } if ($e5a7f3){ $pb3b32['next-href']=r83c8( $ja6d40,e2__parameters_with_timestamp_($e5a7f3) ); $pb3b32['next-jump?'] = (bool) (gmdate('Y/m',$v029bd)!=gmdate('Y/m',$e5a7f3)); $pb3b32['next-title']=e2l_get_string( 'gs--nth-month-of-nth-year', array ( 'year' => gmdate('Y',$e5a7f3),'month' => gmdate('n',$e5a7f3) ) ); } $pb3b32['timeline?']=false; $pb3b32['this-title']=$f09d6c; list ($x7b314,$ka1f20)=b5273($n84cdc,$k7436f); j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "AND `Stamp` BETWEEN ". $x7b314 ." ". "AND ". $ka1f20 ." ". "ORDER BY `Stamp`" ); $result=b0d6b(); $q4358b=y28df($result,$n84cdc,$k7436f); $se70c4['title']=$f09d6c; $se70c4['heading']=$f09d6c; $se70c4['pages']=$pb3b32; $se70c4['year'] = (int)$n84cdc; $se70c4['month'] = (int)$k7436f; $se70c4['month-days']=e2_pack_month_days_with_ymd_($n84cdc,$k7436f,false); if(count($q4358b)) { $se70c4['notes-list']=$q4358b; } else { $se70c4['nothing']=$_strings['gs--no-such-notes']; } return $se70c4; } function e2m_day($parameters=array ()) { global$_strings; $n84cdc= (int)$parameters['year']; $k7436f=(int)$parameters['month']; $l628b7= (int)$parameters['day']; if (!(m1665($n84cdc,$k7436f,$l628b7))) { return e2_error404_mode(); } $f09d6c=e2l_get_string( 'pt--nth-day-of-nth-month-of-nth-year', array ('year' => $n84cdc,'month' => $k7436f,'day' => $l628b7) ); $ve6e7d=gmmktime(0,0,0,$k7436f,$l628b7-1,$n84cdc); $v029bd=gmmktime(0,0,0,$k7436f,$l628b7+1,$n84cdc); list ($u8aebd,$e5a7f3)=e2__fruitful_neighbours_with_ymd_($n84cdc,$k7436f,$l628b7); $ja6d40='e2m_day'; if ($u8aebd){ $pb3b32['prev-href']=r83c8( $ja6d40,e2__parameters_with_timestamp_($u8aebd) ); $pb3b32['prev-jump?'] = (bool) (gmdate('Y/m/d',$ve6e7d)!=gmdate('Y/m/d',$u8aebd)); $pb3b32['prev-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$u8aebd),'month' => gmdate('n',$u8aebd),'day' => gmdate('j',$u8aebd), ) ); } if ($e5a7f3){ $pb3b32['next-href']=r83c8( $ja6d40,e2__parameters_with_timestamp_($e5a7f3) ); $pb3b32['next-jump?'] = (bool) (gmdate('Y/m/d',$v029bd)!=gmdate('Y/m/d',$e5a7f3)); $pb3b32['next-title']=e2l_get_string( 'gs--nth-day-of-nth-month-of-nth-year', array ( 'year' => gmdate('Y',$e5a7f3),'month' => gmdate('n',$e5a7f3),'day' => gmdate('j',$e5a7f3), ) ); } $pb3b32['timeline?']=false; $pb3b32['this-title']=$f09d6c; if (($result=nf9fb($n84cdc,$k7436f,$l628b7)) !== false){ $result=array_reverse($result); foreach($result as $w8ce4b => $laad65){ if ($laad65['IsVisible'] or ye852()) { $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_ord']=k; $laad65['_']['_ord_max']=count($result)-1; $q4358b[] = r6791($laad65); } } } $se70c4['title']=$f09d6c; $se70c4['heading']=$f09d6c; $se70c4['pages']=$pb3b32; $se70c4['month-days']=e2_pack_month_days_with_ymd_($n84cdc,$k7436f,$l628b7); if(count($q4358b)) { $se70c4['notes']=$q4358b; } else { $se70c4['nothing']=$_strings['gs--no-such-notes']; } return $se70c4; } function e2m_everything($parameters=array ()) { global$_strings,$_config; $q4358b=null; if(CACHE_FULLLIST and is_file(CACHE_FILENAME_FULLLIST)) { $q4358b=@unserialize(file_get_contents(CACHE_FILENAME_FULLLIST)); if(__LOG)__log('Everything: retrieving from cache...'); } if (!is_array($q4358b)) { if(__LOG)__log('Everything: retrieving from database...'); j0738( "SELECT `ID`, `Title`, `Stamp`, `LastModified`, `Offset`, `IsDST`, ". "`IsFavourite`, `IsPublished`, `IsVisible`, `SourceNoteURL`, `OriginalAlias` ". "FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished` = 1 AND `IsVisible` = 1 ". "ORDER BY `Stamp`" ); $result=b0d6b(); if(__LOG)__log('Everything: preparing notes list...'); $q4358b=y28df($result); if(__LOG)__log('Everything: saving cache...'); if(CACHE_FULLLIST)k6e52(CACHE_FILENAME_FULLLIST,serialize($q4358b)); } $m1f525=count($q4358b); $f09d6c=e2l_get_string('pt--n-posts', array ('number' => $m1f525)); if(array_key_exists('part',$_GET) and array_key_exists('of',$_GET)) { if(__LOG)__log('Everything: splitting into parts...'); $uf4c93=$_GET['part']; $g8bf88=$_GET['of']; $f09d6c.=' ('. e2l_get_string('gs--part-x-of-y', array ('part' => $uf4c93,'of' => $g8bf88)) .')'; $b895e3=$m1f525/$g8bf88; $pd98a0=($uf4c93-1)*$b895e3; $t01b6e=$uf4c93*$b895e3; $q4358b=array_slice($q4358b,round($pd98a0),round($t01b6e-round($pd98a0))); } if(__LOG)__log('Everything: done, returning'); $se70c4['title']=$f09d6c; $se70c4['heading']=$f09d6c; if(count($q4358b)) { $se70c4['notes-list']=$q4358b; } else { $se70c4['nothing']=$_strings['gs--no-notes']; } return $se70c4; } function e2_pack_month_days_with_ymd_($n84cdc,$k7436f,$l628b7){ $qa6933=f5a2f('t',gmmktime(0,0,0,$k7436f,1,$n84cdc),v3211()); $vb2442=acc02('start'); $y8dbc7=acc02('end'); if ( $n84cdc .'/'. $k7436f == f5a2f('Y/n',$vb2442['stamp'],$vb2442['timezone']) ) { $k42eb4=f5a2f('d',$vb2442['stamp'],$vb2442['timezone']); } else { $k42eb4=1; } if ( $n84cdc .'/'. $k7436f == ga846('Y/n',time()) ) { $xd5f50=ga846('d',time()); } else { $xd5f50=$qa6933; } $ge4602=d82dc($n84cdc,$k7436f); for ($q865c0=1; $q865c0 <= $qa6933; ++ $q865c0){ $f7f769=gmmktime(0,0,0,$k7436f,$q865c0,$n84cdc); $t271c1[$q865c0] = array ( 'number' => $q865c0, 'start-time' => array ($f7f769,v3211()), 'href' => gmdate('Y/m/d/',$f7f769), 'this?' => (bool) ($q865c0==$l628b7), 'real?' => $q865c0 >= $k42eb4 and $q865c0 <= $xd5f50, 'fruitful?' => @in_array(gmdate('d',$f7f769),$ge4602), ); } return $t271c1; } function m1665($n84cdc,$k7436f=false,$l628b7=false){ $vb2442=acc02('start'); if ($vb2442===false){ return false; } $ic1f1e=f5a2f('Y',$vb2442['stamp'],$vb2442['timezone']); $webeb3=ga846('Y',time()); if ($k7436f===false){ return (bool) ( $n84cdc >= $ic1f1e and $n84cdc <= $webeb3 ); } else { $k782fc=f5a2f('n',$vb2442['stamp'],$vb2442['timezone']); $r13dd1=ga846('n',time()); if ($l628b7===false){ return (bool) ( $k7436f >= 1 and $k7436f <= 12 and ( ($n84cdc > $ic1f1e and $n84cdc < $webeb3) or ($n84cdc==$ic1f1e and $k7436f >= $k782fc) or ($n84cdc==$webeb3 and $k7436f <= $r13dd1) ) ); } else { $q7a9c0=f5a2f('j',$vb2442['stamp'],$vb2442['timezone']); $c23209=ga846('j',time()); if(1){ return (bool) ( checkdate($k7436f,$l628b7,$n84cdc) and ( ($n84cdc > $ic1f1e and $n84cdc < $webeb3) or ($n84cdc==$ic1f1e and $k7436f > $k782fc) or ($n84cdc==$ic1f1e and $k7436f==$k782fc and $l628b7 >= $q7a9c0) or ($n84cdc==$webeb3 and $k7436f < $r13dd1) or ($n84cdc==$webeb3 and $k7436f==$r13dd1 and $l628b7 <= $c23209) ) ); } } } } function e2__fruitful_neighbours_with_ymd_($i41529,$b6f8f5=false,$b8277e=false){ global$_db,$_config; list ($u3d2fa,$a9468c)=b5273($i41529,$b6f8f5,$b8277e); $eada4b=SECONDS_IN_A_DAY; if ($b8277e===false)$eada4b=SECONDS_IN_A_MONTH; if ($b6f8f5===false)$eada4b=SECONDS_IN_A_YEAR; if (!ye852())$ff79b1="`IsVisible`=1 AND "; if (u0f7c()) { $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$ff79b1. "Stamp < '". ($a9468c-$eada4b) ."' ". "ORDER BY Stamp DESC" ); while ($g6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($n84cdc,$k7436f,$l628b7)=explode('/', f5a2f('Y/n/j',$g6438c['Stamp'],j0923($g6438c)) ); $k7474d=$i41529*10000 + ($b6f8f5? ($b6f8f5*100):0) + ($b8277e? $b8277e:0); $mbd8da=$n84cdc*10000 + ($b6f8f5? ($k7436f*100):0) + ($b8277e? $l628b7:0); if ($mbd8da < $k7474d){ $ibf025=gmmktime(0,0,0,$k7436f,$l628b7,$n84cdc); break; } } $_db['result']=mysqli_query( $_db['link'], "SELECT `Stamp`, `Offset`, `IsDST` ". "FROM `". $_config['db_table_prefix']. "Notes` ". "WHERE `IsPublished`=1 AND " .@$ff79b1. "Stamp > '". ($u3d2fa+$eada4b) ."' ". "ORDER BY Stamp" ); while ($g6438c=@mysqli_fetch_array($_db['result'],MYSQLI_ASSOC)) { list ($n84cdc,$k7436f,$l628b7)=explode('/', f5a2f('Y/n/j',$g6438c['Stamp'],j0923($g6438c)) ); $k7474d=$i41529*10000 + ($b6f8f5? ($b6f8f5*100):0) + ($b8277e? $b8277e:0); $mbd8da=$n84cdc*10000 + ($b6f8f5? ($k7436f*100):0) + ($b8277e? $l628b7:0); if ($mbd8da > $k7474d){ $d8dc98=gmmktime(0,0,0,$k7436f,$l628b7,$n84cdc); break; } } return array ($ibf025,$d8dc98); } } function e2__parameters_with_timestamp_($h96b8c){ list ( $parameters['year'], $parameters['month'], $parameters['day'] ) = explode('/',gmdate('Y/m/d',$h96b8c)); return$parameters; } function y28df($bc2d18,$n84cdc=false,$k7436f=false){ $q229c3=0; $q4358b=array(); $wf09d8=''; $q4358b=array(); $scc73f=array(); foreach ($bc2d18 as $w8ce4b => $h39a37){ $laad65['href'] = r83c8('e2m_note', array ('*note' => $h39a37)); $laad65['time'] = array ((int)min($h39a37['Stamp'],time()), j0923($h39a37)); $laad65['last-modified'] = array ((int)min($h39a37['LastModified'],time()), j0923($h39a37)); $laad65['favourite?'] = (bool) ($h39a37['IsFavourite'] && $h39a37['IsPublished']); if(array_key_exists('SourceNoteURL',$h39a37) and @$h39a37['SourceNoteURL']!=''){ $laad65['href']=$h39a37['SourceNoteURL']; $laad65['href-original']=$h39a37['SourceNoteURL']; } if ( ($n84cdc and $k7436f and ( ((int)$n84cdc) .'/'. ((int)$k7436f) == f5a2f('Y/n',$h39a37['Stamp'],j0923($h39a37)) )) or ($n84cdc and !$k7436f and ( (int)$n84cdc == f5a2f('Y',$h39a37['Stamp'],j0923($h39a37)) )) or (!$n84cdc and !$k7436f) ) { array_unshift($q4358b,$laad65); array_unshift($scc73f,str_replace("\n",' ',$h39a37['Title'])); } } $t789f1=implode("\n",$scc73f); if(strlen($t789f1) < 20000){ $t789f1=t6f10(htmlspecialchars($t789f1,ENT_NOQUOTES,HSC_ENC)); $scc73f=explode("\n",$t789f1); } foreach ($q4358b as $w8ce4b => $o9e366){ $q4358b[$w8ce4b]['title']=$scc73f[$w8ce4b]; } return $q4358b; } function e2s_sync(){ e2_drop_all_kinds_of_cache(); die ('All caches clean.'); } function e2_note_cache_filename_with_id_($fb80bb){ return str_replace('*',$fb80bb,CACHE_FILENAMES_NOTES); } function e2_drop_caches_for_note_($v21158){ if(__LOG)__log('Caches: Drop caches for note id '. $v21158); ze2f1(); f22e7(); @unlink(e2_note_cache_filename_with_id_($v21158)); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments')); @unlink(e2_note_cache_filename_with_id_($v21158 .'-comments-author')); @unlink(CACHE_FILENAME_HOT); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_FULLLIST); @unlink(CACHE_FILENAME_TAGS); @unlink(CACHE_FILENAME_TAGS_AUTHOR); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function r7996(){ if(__LOG)__log('Caches: Drop notes caches'); bc5a6(CACHE_FILENAMES_NOTES); bc5a6(CACHE_FILENAMES_NOTES_COMMENTS); @unlink(CACHE_FILENAME_FRONTPAGE); @unlink(CACHE_FILENAME_FRONTPAGE_AUTHOR); @unlink(CACHE_FILENAME_FRONTPAGE_FEED); @unlink(CACHE_FILENAME_LASTMODIFIEDS); } function ze2f1(){ if(__LOG)__log('Caches: Drop notes counts cache'); bc5a6(CACHE_FILENAMES_NOTES_COUNTS); } function f22e7(){ if(__LOG)__log('Caches: Drop egde time info cache'); bc5a6(CACHE_FILENAMES_EDGE_TIMEINFO); } function e2_drop_all_kinds_of_cache(){ if(__LOG)__log('Caches: Drop all kinds of caches'); bc5a6(CACHES_FOLDER.'*'); return true; } function n4e27($o139c8){ global$_template,$_config; if(__LOG)__log('Olba: Prepare template <'. $o139c8 .'>'); $eaf10b=array(); $i8598c=$o139c8; $g620f7=TEMPLATES_FOLDER.$i8598c .'/'; $q1b14d=false; $ga5fca=false; $h37c8a=false; if ( $o139c8!='' ){ if ( is_dir($g620f7) and is_file($g620f7 .'/theme-info.php') ) { while (1){ $g620f7=TEMPLATES_FOLDER.$i8598c .'/'; array_push($eaf10b,$g620f7); $n38226=include $g620f7 .'/theme-info.php'; $u4e502[$g620f7]=$n38226; if(array_key_exists('max_image_width',$n38226)) { if ($q1b14d===false){ $q1b14d=$n38226['max_image_width']; } } if(array_key_exists('meta_viewport',$n38226)) { if ($ga5fca===false){ $ga5fca=$n38226['meta_viewport']; } } if(array_key_exists('use_likely_light',$n38226)) { if ($h37c8a===false){ $h37c8a=$n38226['use_likely_light']; } } if(array_key_exists('based_on',$n38226)) { $i8598c=$n38226['based_on']; } else { break; } } } else { } } $g620f7=SYSTEM_TEMPLATE_FOLDER; array_push($eaf10b,$g620f7); if ($q1b14d===false){ $q1b14d=$_config['max_image_width']; } $_template['name']=$o139c8; $_template['max_image_width']=$q1b14d; $_template['meta_viewport']=$ga5fca; $_template['use_likely_light']=$h37c8a; $_template['stack']=$eaf10b; $_template['infos']=$u4e502; }; function q53ee($md436e){ global$content; ++ $_olba_includes; include $md436e; } function c6a97($c52678){ if(0){ echo '<div style="background: #ff0">'.$c52678.'</div>'; } if(is_dir(EXTRAS_FOLDER)) { $a71cae=EXTRAS_FOLDER.$c52678 .'.tmpl.php'; if(is_file($a71cae)) { q53ee($a71cae); } } return ''; } function f166b($c52678){ global$_template,$_olba_includes; $a71cae='templates/'. $c52678 .'.tmpl.php'; if ($md436e=e2o__usable_file_with_basename_($a71cae)) { if(__LOG)__log('Olba: Apply template <'. $md436e .'>'); q53ee($md436e); } else { s1928($a71cae); } } function hbc21(){ global$_config; if ( @$_config['raw_template_data'] or @$_config['raw_template_data_with_param'] and array_key_exists('raw',$_GET) ) { $q3f7d9='raw'; } else { $q3f7d9='main'; } return f166b($q3f7d9); } function s1928($q8b7af){ df1da($q8b7af,'_olba_missing_templates'); } function zd4c1($n45ac4){ df1da($n45ac4 .'.css','_olba_used_stylesheets'); } function ad00a($h3205c){ df1da($h3205c .'.js','_olba_used_scripts'); } function j16f0($ne8acc){ foreach (array (SYSTEM_LIBRARY_FOLDER,USER_LIBRARY_FOLDER) as $l71379){ foreach(glob($l71379.$ne8acc .'/*') as $k8c7dd){ $wabf77=pathinfo($k8c7dd,PATHINFO_EXTENSION); if ($wabf77=='js'){ df1da($k8c7dd,'_olba_used_scripts'); } if ($wabf77=='css'){ df1da($k8c7dd,'_olba_used_stylesheets'); } } } } function ze655(){ global$_olba_missing_templates; if (isset ($_olba_missing_templates)) { return array_unique($_olba_missing_templates); } } function j94dd(){ global$_template,$_config,$settings; if ($ne1260=@opendir(TEMPLATES_FOLDER)) { while (false !== ($r1f769=readdir($ne1260))) { if(is_dir(TEMPLATES_FOLDER. $r1f769) and $r1f769!='.' and $r1f769!='..'){ if(is_file(TEMPLATES_FOLDER.$r1f769 .'/theme-info.php')) { $zccf6b[$r1f769]=TEMPLATES_FOLDER.$r1f769 .'/'; } } } closedir($ne1260); } $h10ae9=array(); $q2e3a2=1000; foreach ($zccf6b as $lb0689 => $a85114){ $n38226=include $a85114 .'theme-info.php'; $fc2657=@$n38226['display_name']; if (!$fc2657) continue; if(is_array($fc2657)) { if(array_key_exists($settings['language'],$fc2657)) { $fc2657=$fc2657[$settings['language']]; } else { $fc2657=array_shift($fc2657); } } $y6a992=@$n38226['index'] or $y6a992=$q2e3a2 ++; $p62848=@$n38226['colors']; if (!$p62848)$p62848=array ( 'background' => 'transparent', 'headings' => 'rgba(128,128,128,.2)', 'text' => 'rgba(128,128,128,.2)', 'link' => 'rgba(128,128,128,.2)', ); $j16e25=(bool) ($lb0689==$_template['name']); if ($j16e25){ $ycd143=r83c8('e2m_theme_preview', array ('theme' => '')); } else { $ycd143=r83c8('e2m_theme_preview', array ('theme' => $lb0689)); } $h10ae9[$y6a992] = array ( 'name' => $lb0689, 'display-name' => $fc2657, 'colors' => $p62848, 'current?' => $j16e25, 'preview-url' => $ycd143, ); } ksort($h10ae9); return $h10ae9; } function f1492($i435ed){ return e2o__usable_file_with_basename_('images/'. $i435ed); } function zf42c($db1197){ return file_get_contents(e2o__usable_file_with_basename_('images/'. $db1197 .'.svg')); } function p576f($n45ac4){ global$_template; $r954eb='styles/'. $n45ac4 .'.css'; $c95aa1=array(); foreach($_template['stack'] as $g620f7){ if(is_file($i435ed=$g620f7.$r954eb)) { $c95aa1[] = $i435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$g620f7]) and in_array($n45ac4,$_template['infos'][$g620f7]['reset_styles']) ) { break; } } $c95aa1=array_reverse($c95aa1); } function k37ca(){ global$_olba_used_stylesheets,$_template; if (!isset ($_olba_used_stylesheets)) return; $_olba_used_stylesheets=array_unique($_olba_used_stylesheets); $lc7f50=array(); foreach($_olba_used_stylesheets as $n45ac4){ if(is_file($n45ac4)) { $lc7f50[] = $n45ac4; continue; } if(is_file($i435ed=USER_FOLDER .'js/'. $n45ac4)) { $lc7f50[] = $i435ed; } $r954eb='styles/'. $n45ac4; $c95aa1=array(); foreach($_template['stack'] as $g620f7){ if(is_file($i435ed=$g620f7.$r954eb)) { $c95aa1[] = $i435ed; } if ( array_key_exists('reset_styles',$_template['infos'][$g620f7]) and in_array($n45ac4,$_template['infos'][$g620f7]['reset_styles']) ) { break; } } $c95aa1=array_reverse($c95aa1); $lc7f50=array_merge($lc7f50,$c95aa1); } foreach ($lc7f50 as $w8ce4b => $o9e366){ $vbc7b3=stat($o9e366); $lc7f50[$w8ce4b].='?'. $vbc7b3['mtime']; } return $lc7f50; } function n4753(){ global$_olba_used_scripts; if (!isset ($_olba_used_scripts)) return; $_olba_used_scripts=array_unique($_olba_used_scripts); $vd6c58=array(); foreach($_olba_used_scripts as $h3205c){ if ( substr($h3205c,0,7)=='http://' or substr($h3205c,0,8)=='https://' or substr($h3205c,0,2)=='//' ){ $vd6c58[] = $h3205c; continue; } if(is_file($h3205c)) { $vd6c58[] = $h3205c; continue; } if(is_file($p9d679=USER_FOLDER .'js/'. $h3205c)) { $vd6c58[] = $p9d679; } $r954eb='js/'. $h3205c; if ($p9d679=e2o__usable_file_with_basename_($r954eb)) { $vd6c58[] = $p9d679; } } foreach ($vd6c58 as $w8ce4b => $o9e366){ $vbc7b3=stat($o9e366); if ($vbc7b3['mtime']) { $vd6c58[$w8ce4b].='?'. $vbc7b3['mtime']; } } return $vd6c58; } function df1da($b2063c,$lf1f71){ if (!isset ($GLOBALS[$lf1f71])) { $GLOBALS[$lf1f71] = array ($b2063c); } else { $GLOBALS[$lf1f71][] = $b2063c; } } function e2o__usable_file_with_basename_($r954eb){ global$_template; foreach($_template['stack'] as $g620f7){ if(is_file($i435ed=$g620f7.$r954eb)) { return $i435ed; } } return ''; } function e2m_theme_preview($parameters){ global$_lang,$_strings,$_superconfig,$_template; if (@$_superconfig['disallow_themes_preview']) { return e2_error404_mode(); } if($parameters['theme']==$_template['name']) { e2_go_to(r83c8('e2m_theme_preview', array ('theme' => ''))); } if($parameters['theme']) { n4e27($parameters['theme']); } $m75725=$_lang; if (!is_file($k8c7dd='system/preview/'. $m75725 .'.php')) { $m75725=$_strings['--secondary-language']; $k8c7dd='system/preview/'. $m75725 .'.php'; } if (!is_file($k8c7dd='system/preview/'. $m75725 .'.php')) { $k8c7dd='system/preview/'. DEFAULT_LANGUAGE .'.php'; } $se70c4=include $k8c7dd; return $se70c4; } define('SEARCH_EXTRA_PREFIX','Rose'); define('SEARCH_LIMIT',20); define('SEARCH_SNIPPETS_LIMIT',20); define('SEARCH_USE_ROSE',1); define('SEARCH_USE_MYSQL',1); use S2\Rose\Storage\Exception\EmptyIndexException; use S2\Rose\Storage\Database\PdoStorage; use S2\Rose\Stemmer\PorterStemmerRussian; use S2\Rose\Indexer; use S2\Rose\Entity\Indexable; use S2\Rose\Entity\Query; use S2\Rose\Finder; use S2\Rose\SnippetBuilder; function e2m_found($parameters=array ()) { global$_strings,$_config,$settings,$full_blog_url; $parameters['query']=trim($parameters['query']); $s1b1cc=$parameters['query']; if (!$s1b1cc){ return array ( 'title' => $_strings['pt--search-query-empty'], 'heading' => $_strings['pt--search'], 'nothing' => $_strings['gs--search-query-empty'], ); } $ff79b1="AND `IsVisible`=1 "; if (ye852())$ff79b1=''; $u11128=false; if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Keywords` ". "WHERE `Keyword`='". q7928($s1b1cc)."'" )) { $pfa816=b0d6b(); if (isset ($pfa816[0]['ID'])) { $u11128=array ( 'href' => r83c8('e2m_tag', array ('*tag' => $pfa816[0])), 'name' => htmlspecialchars($s1b1cc,ENT_NOQUOTES,HSC_ENC), ); } } $l4dd42=i163d(' ',$parameters['query']); $wfce9c=new PorterStemmerRussian(); foreach ($l4dd42 as $w8ce4b => $o9e366){ $l4dd42[$w8ce4b]=$wfce9c -> stemWord($l4dd42[$w8ce4b]); } $h8e830=array(); if(SEARCH_USE_ROSE){ try { $dddece=b476c(); $t5b9bd=new Finder($dddece,$wfce9c); $t5b9bd -> setHighlightTemplate('<mark>%s</mark>'); $uf7de9=new Query($s1b1cc); $uf7de9 -> setLimit(SEARCH_LIMIT); $resultSet=$t5b9bd -> find($uf7de9); foreach($resultSet -> getFoundExternalIds() as $u0e684){ if ($u0e684[0]=='n'){ $v21158=substr($u0e684,1); $laad65=n4627($v21158); if ($laad65['IsFavourite']) { $resultSet->setRelevanceRatio($u0e684, @$_config['search_favourites_boost']); } } } $snippetBuilder=new SnippetBuilder($wfce9c); $snippetBuilder -> setSnippetLineSeparator(' · '); $snippetBuilder -> attachSnippets($resultSet, function (array $mbf516){ $result=array(); foreach(array_slice($mbf516,0,SEARCH_SNIPPETS_LIMIT) as $u0e684){ if ($u0e684[0]=='n'){ $v21158=substr($u0e684,1); $h39a37=@n4627($v21158); if ($h39a37){ $h39a37['_']['_id']=$v21158; $laad65=r6791($h39a37); $result[$u0e684]=$laad65['text']; } } } return$result; }); foreach($resultSet -> getItems() as $u0e684 => $q447b7){ if ($u0e684[0]=='n'){ $v21158=substr($u0e684,1); $laad65=n4627($v21158); $laad65['_']['_id']=$v21158; $laad65['_']['_srprovider']='rose'; $laad65['_']['_rose_relevance']=$q447b7 -> getRelevance(); $laad65['_']['_rose_title']=$q447b7 -> getHighlightedTitle($wfce9c); $laad65['_']['_rose_snippet']=$q447b7 -> getSnippet(); if ($laad65['IsPublished'] and ($laad65['IsVisible'] or ye852())) { $h8e830[] = $laad65; } } } if($_config['rose_debug_info']) { $f1e441=print_r($resultSet -> getTrace(),true); } } catch (EmptyIndexException $e){} } if(1 and SEARCH_USE_MYSQL){ $b36a38=q7928(preg_quote($s1b1cc)); $geb31b=( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 AND MATCH (`Title`, `Text`) AGAINST ('". $b36a38 ."')". $ff79b1 ." ". "LIMIT ". SEARCH_LIMIT ); if (j0738($geb31b)) { $result=b0d6b(); foreach($result as $w8ce4b => $laad65){ $laad65['_']['_id']=$laad65['ID']; $laad65['_']['_srprovider']='mysql'; $h8e830[] = $laad65; } } } $qfbdf2=array(); $q4358b=array(); $q865c0=0; foreach ($h8e830 as $h39a37){ if (!in_array($h39a37['ID'],$qfbdf2)) { $laad65=r6791($h39a37); if (@$laad65['_']['_rose_title']) { $laad65['title']=$laad65['_']['_rose_title']; } else { $laad65['title']=x4c2d($laad65['title'],$l4dd42); } $laad65['title']=t6f10($laad65['title']); if (@$laad65['_']['_rose_snippet']) { $laad65['text']='<p>'. $laad65['_']['_rose_snippet'] .'</p>'; } else { $e1cb25=$laad65['text']; $e1cb25=preg_replace('/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/i','',$e1cb25); $e1cb25=preg_replace('/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/i','',$e1cb25); $e1cb25=str_replace( array ( '<br>', '<br/>', '<br />', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '</p>', '</pre>', '</blockquote>', '</li>', ), ' ', $e1cb25 ); $e1cb25=strip_tags($e1cb25); $sad7ba=array(); $s9cc49=preg_split('/[\\n\(\)\[\]]|[.:;?!](\s|$)/uis',$e1cb25); $b363b1=0; $o02db3=''; foreach ($s9cc49 as $ud866f){ $ud866f=trim($ud866f); if (!$ud866f) continue; if (!$o02db3)$o02db3=$ud866f; $u870c2=$ud866f; $u870c2=x4c2d($u870c2,$l4dd42); if ($u870c2!=$ud866f){ $sad7ba[] = m48d8($u870c2); $b363b1 ++; if ($b363b1 > 3) break; } } if(count($sad7ba)) { $laad65['text']='<p>'. implode(' · ',$sad7ba) .'</p>'; } else { $laad65['text']='<p>'. $o02db3 .'</p>'; } } $laad65['has-highlighed-thumbs?']=false; if ($w55b55=@$laad65['format-info']['resources-detected']) { $l750fa=d2e82($w55b55); foreach ($l750fa as $w8ce4b => $o9e366){ $l750fa[$w8ce4b]['highlighted?'] = ( strstr($o9e366['original-filename'],$s1b1cc)!==false ); if ($l750fa[$w8ce4b]['highlighted?']) { $laad65['has-highlighted-thumbs?']=true; } } $laad65['thumbs']=$l750fa; } $q4358b[] = $laad65; $qfbdf2[] = $h39a37['ID']; $q865c0 ++; if ($q865c0 >= SEARCH_LIMIT) break; } } $yfbb44=count($q4358b); if ($yfbb44){ $x5cde2=e2l_get_string( 'pt--n-posts', array ('number' => $yfbb44) ); } else { $x5cde2=$_strings['pt--no-posts']; $v2cb9d['nothing']=$_strings['gs--nothing-found']; } if ($q865c0 >= SEARCH_LIMIT){ $x5cde2=$_strings['gs--many-posts']; } if ($u11128){ $v2cb9d['search-related-tag']=$u11128; } $v2cb9d['notes']=$q4358b; $v2cb9d['pages'] = array (); $v2cb9d['title']=$x5cde2 .' '. $_strings['gs--found-for-query'] .': '. htmlspecialchars($s1b1cc,ENT_NOQUOTES,HSC_ENC); $v2cb9d['superheading']=$x5cde2 .' '. $_strings['gs--found-for-query']; $v2cb9d['heading']=$s1b1cc; if (@$f1e441){ $v2cb9d['rose-debug-info']=$f1e441; } return $v2cb9d; } function e2s_search(){ $s1b1cc=@$_POST['query']; $s1b1cc=str_replace('?',urlencode('?'),$s1b1cc); $s1b1cc=str_replace('/',' ',$s1b1cc); $s1b1cc=trim($s1b1cc); $s1b1cc=str_replace(' ','+',$s1b1cc); e2_go_to(r83c8('e2m_found', array ('query' => $s1b1cc))); die; } function e2s_bsi_status(){ global$_db,$_config; echo '<pre>'; echo '/@bsi/step/ — Make one step of indexing<br />'; echo '/@bsi/drop/ — Drop indexes<br /><br />'; $le1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($le1fab))$le1fab=array ('spent' => '?'); if (u0f7c() and $_db['link']) { $d34421=$ae0d69='?'; if (j0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsPublished`=1 " )) { $q9b207=b0d6b(); $d34421=$q9b207[0]['c']; } if (j0738( "SELECT count(*) c FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=1 AND `IsPublished`=1 " )) { $q9b207=b0d6b(); $ae0d69=$q9b207[0]['c']; } $kd1647=round($ae0d69/$d34421*100); echo 'Indexed '. $ae0d69 .' notes of '. $d34421 .' ('. $kd1647 .'%)<br />'; echo 'Spent '. $le1fab['spent'] .' s (or more)'; } else { echo 'DB unaccessible'; } die ('</pre>'); } function e2s_bsi_step(){ global$_db,$_config,$_strings; if(__LOG)__log('BSI step'); if (!q3b97()) { die ('Not indexing</pre>'); } $le1fab=@unserialize(file_get_contents(USER_FOLDER.'indexing.psa')); if (!is_array($le1fab))$le1fab=array ('spent' => '?'); if ( !isset ($le1fab['lock']) or $le1fab['lock'] < time() - (BSI_GIVE_UP_TIMEOUT+BSI_UNLOCK_TIMEOUT) ) { if (isset ($le1fab['lock'])) { echo 'Old lock: '. $le1fab['lock'] .'<br />'; } else { echo 'No old lock<br />'; } $le1fab['lock']=time(); if (!@k6e52(USER_FOLDER.'indexing.psa',serialize($le1fab))) { echo 'Can’t get a new lock<br />'; die; } echo 'New lock: '. $le1fab['lock'] .'<br /><br />'; if (u0f7c() and $_db['link']) { $q865c0=0; $e680a2=0; $oce2fc=s7f78(); $s30d94=false; while ($e680a2 < BSI_GIVE_UP_TIMEOUT){ if (j0738( "SELECT * FROM `". $_config['db_table_prefix']."Notes` ". "WHERE `IsIndexed`=0 AND `IsPublished`=1 ". "ORDER BY `Stamp` DESC ". "LIMIT ". BSI_SELECT_PORTION )) { $q9b207=b0d6b(); } if(count($q9b207)) { echo 'Portion '. ++$q865c0 .'<br />'; foreach ($q9b207 as $iea59a){ echo 'Indexing: '. $iea59a['Title'] .'<br />'; $iea59a['IsIndexed']='1'; if (raa79('Notes',$iea59a)) { pd2e1($iea59a); if($_config['broadcast_on_indexing']) { meb3b($iea59a); } } } $e680a2=round(s7f78()-$oce2fc,3); echo 'Done '. count($q9b207) .', spent '. $e680a2 .' ms so far<br /><br />'; } else { $s30d94=true; break; } } if ($s30d94){ echo 'Indexing done<br /><br />'; @unlink(USER_FOLDER.'indexing.psa'); } else { echo 'Time out<br />'; unset ($le1fab['lock']); $le1fab['done']=count($q9b207); if ($le1fab['spent']!='?')$le1fab['spent']+=$e680a2; @k6e52(USER_FOLDER.'indexing.psa',serialize($le1fab)); } } else { echo 'DB unaccessible<br />'; } } else { echo 'Locked<br />'; } die ('</pre>'); } function e2s_bsi_drop(){ global$_db,$_config; if (u0f7c() and $_db['link']) { echo '<pre>'; if (xa521()) { echo 'All notes marked for reindexing<br />'; $dddece=b476c(); $dddece -> erase(); echo 'Indexes dropped<br />'; } else { echo 'DB error: '. mysqli_error($_db['link']).'<br />'; } y198f(); die ('</pre>'); } die ('<pre>DB unaccessible</pre>'); } define('BSI_SELECT_PORTION',10); define('BSI_GIVE_UP_TIMEOUT',10); define('BSI_UNLOCK_TIMEOUT',10); function y198f(){ $le1fab=array(); @k6e52(USER_FOLDER.'indexing.psa',serialize($le1fab)); } function q3b97(){ return (is_file(USER_FOLDER.'indexing.psa')); } function pd2e1($h39a37){ static $zf4540=null; try { if ($zf4540===null){ $wfce9c=new PorterStemmerRussian(); $zf4540=new Indexer(b476c(),$wfce9c); } $s2bfe4=p154e($h39a37['FormatterID'], @$h39a37['Text'],'full-rss'); qfc4d($h39a37,$s2bfe4); $e1cb25=strip_tags($s2bfe4['text-final']); $e3e961=new Indexable( 'n'. $h39a37['ID'], $h39a37['Title'], $e1cb25 ); return $zf4540 -> index($e3e961); } catch (Exception $e){ return false; } } function o10fe($fb80bb){ static $zf4540=null; try { if ($zf4540===null){ $wfce9c=new PorterStemmerRussian(); $zf4540=new Indexer(b476c(),$wfce9c); } return $zf4540 -> removeById('n'. $fb80bb); } catch (Exception $e){ return false; } } function f713e($ma2f2e){ $m851f5='S2\\Rose\\'; $q32fcc=__DIR__.'/library/rose/'; $yf5a8e=strlen($m851f5); if(strncmp($m851f5,$ma2f2e,$yf5a8e)!==0) return; $de1cb9=substr($ma2f2e,$yf5a8e); $k8c7dd=$q32fcc.str_replace('\\','/',$de1cb9).'.php'; if(file_exists($k8c7dd)) require $k8c7dd; } function b476c(){ global$_config,$settings; static $k88131=null; if ($k88131===null){ $mcf66e=new \PDO( 'mysql:'. 'host='. $settings['db']['server'] .';'. 'dbname='. $settings['db']['name']. ';'. 'charset=utf8', $settings['db']['user_name'], wee85($settings['db']['passw']) ); $mcf66e -> setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION); $k88131=new PdoStorage( $mcf66e, $_config['db_table_prefix'].SEARCH_EXTRA_PREFIX, array ( PdoStorage::TOC => 'Contents', PdoStorage::WORD => 'Word', PdoStorage::FULLTEXT_INDEX => 'Fulltext', PdoStorage::KEYWORD_INDEX => 'Keyword', PdoStorage::KEYWORD_MULTIPLE_INDEX => 'KeywordMultiple', ) ); } return $k88131; } function x4c2d($e1cb25,$l4dd42){ foreach ($l4dd42 as $i2510c){ if ($i2510c=='-') continue; $i2510c=preg_quote($i2510c,'/'); $i2510c=str_replace('е','[её]',$i2510c); $i2510c=str_replace('Е','[ЕЁ]',$i2510c); $e1cb25=preg_replace('/(?<=^|\W)('.$i2510c.'[\w\p{M}]*)/iu','<mark>$1</mark>',$e1cb25); } $e1cb25=str_replace('</mark> <mark>',' ',$e1cb25); $e1cb25=str_replace('</mark> <mark>',' ',$e1cb25); return $e1cb25; } function m48d8($t341be){ $ze05fe=mb_strtoupper(mb_substr($t341be,0,1)); return $ze05fe.mb_substr($t341be,1); } function xa521(){ global$_config; return j0738( "UPDATE `". $_config['db_table_prefix']."Notes` ". "SET `IsIndexed`=0" ); } function e2_check_timeout(){ static $b90272; if(is_null($b90272)) { $of48ef=ini_get('max_execution_time'); if ($of48ef){ $b90272=time()+$of48ef-5; } else { $b90272=0; } } return ($b90272==0)?true:$b90272 >= time(); } function e2_write_dump_header($k8c7dd){ $m099fb=( 'SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";' .PHP_EOL. 'SET AUTOCOMMIT=0;' .PHP_EOL. 'START TRANSACTION;' .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;" .PHP_EOL. "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;" .PHP_EOL. "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;" .PHP_EOL. "/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;" .PHP_EOL. "/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;" .PHP_EOL. "/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=NO_AUTO_VALUE_ON_ZERO */;" .PHP_EOL. "/*!40101 SET NAMES utf8 */;" .PHP_EOL. '' ); fwrite($k8c7dd,$m099fb); return true; } function e2_write_dump_footer($k8c7dd){ $o251d1='COMMIT;' .PHP_EOL; $o251d1 .= "/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;" .PHP_EOL ."/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;" .PHP_EOL ."/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;".PHP_EOL ."/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;" .PHP_EOL ."/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;" .PHP_EOL; fwrite($k8c7dd,$o251d1); return true; } function e2_get_table_definition($l0c1d0,$baab9e){ $a5c286=null; $result=mysqli_query($l0c1d0,"SHOW CREATE TABLE `{$baab9e}`"); if($result){ $y47c80=mysqli_fetch_array($result); $a5c286=$y47c80['Create Table']; } return $a5c286; } function e2_write_table_definition($k8c7dd,$l0c1d0,$baab9e){ $p30618=e2_get_table_definition($l0c1d0,$baab9e); if(e2_check_timeout() && $p30618){ fwrite($k8c7dd,$p30618); fwrite($k8c7dd,';'); fwrite($k8c7dd,PHP_EOL.PHP_EOL); return true; } return false; } function e2_get_table_data($l0c1d0,$baab9e,$i7a86c,$saa9f7){ $s1b1cc="SELECT * FROM `{$baab9e}` LIMIT {$i7a86c}, {$saa9f7}"; $result=mysqli_query($l0c1d0,$s1b1cc); if (!$result){ return false; } $k66e9c=''; $x3c41a="INSERT INTO `{$baab9e}` VALUES"; while ($af1965=mysqli_fetch_assoc($result)) { $j691d5=array(); foreach($af1965 as $b2063c){ $j691d5[] = is_null($b2063c)?"NULL":"'".mysqli_real_escape_string($l0c1d0,$b2063c)."'"; } $k66e9c.=$x3c41a.'('.join(', ',$j691d5).');'.PHP_EOL; } return $k66e9c; } function e2_table_disable_keys($baab9e){ return "ALTER TABLE `{$baab9e}` DISABLE KEYS;".PHP_EOL; } function e2_table_enable_keys($baab9e){ return "ALTER TABLE `{$baab9e}` ENABLE KEYS;".PHP_EOL; } function e2_get_total_records($l0c1d0,$baab9e){ $w8ce4b=mysqli_fetch_row(mysqli_query($l0c1d0,"SELECT COUNT(*) FROM `{$baab9e}`")); return $w8ce4b[0]; } function e2_write_table_data($k8c7dd,$l0c1d0,$baab9e){ $yfbb44=e2_get_total_records($l0c1d0,$baab9e); $i7a86c=0; $saa9f7=1000; $result=true; $a47495=20000; $s80fc1=30; if ($yfbb44){ $yfbda5=e2_table_disable_keys($baab9e); fwrite($k8c7dd,$yfbda5); } $k66e9c="INSERT INTO `{$baab9e}` VALUES"; $qde57a=$yfbb44; while ($qde57a > 0){ $s1b1cc="SELECT * FROM `{$baab9e}` LIMIT {$i7a86c}, {$saa9f7}"; $result=mysqli_query($l0c1d0,$s1b1cc); $pb428d=mysqli_num_rows($result); if (!$result || !e2_check_timeout()) { $result=false; break; } $tdf347=array(); $s4b3a6=0; $wb6539=0; while ($af1965=mysqli_fetch_assoc($result)) { if (!e2_check_timeout()) { $result=false; break; } $pb428d--; $a54ca8=array(); foreach($af1965 as $b2063c){ $a54ca8[] = is_null($b2063c)?"NULL":"'".mysqli_real_escape_string($l0c1d0,$b2063c)."'"; } $k8d777='('.join(', ',$a54ca8).')'; $s4b3a6+=strlen($k8d777); $tdf347[] = $k8d777; $wb6539++; if ( ($s4b3a6 >= $a47495) || ($wb6539 >= $s80fc1) || ($pb428d==0)) { $s1b1cc=$k66e9c.join(', ',$tdf347).';'; fwrite($k8c7dd,$s1b1cc); fwrite($k8c7dd,PHP_EOL); $s4b3a6=0; $wb6539=0; $tdf347=array(); } } $i7a86c+=$saa9f7; $qde57a -= $saa9f7; } if ($yfbb44){ $t6bfc4=e2_table_enable_keys($baab9e); fwrite($k8c7dd,$t6bfc4); } return$result; } function e2_backup($l0c1d0,$e9ab2e,$oa9745,$u93da6=array()) { mysqli_query($l0c1d0,"SET NAMES utf8"); $p2beda=tmpfile(); e2_write_dump_header($p2beda); if(__LOG)__log('DB Backup: wrote header'); $l75101=true; foreach($e9ab2e as $baab9e){ if(__LOG)__log('DB Backup: table '. $baab9e); $u91e7e=e2_write_table_definition($p2beda,$l0c1d0,$baab9e); if(__LOG)__log('DB Backup: wrote table definition with result '. (int)$u91e7e); $t35285=e2_write_table_data($p2beda,$l0c1d0,$baab9e); if(__LOG)__log('DB Backup: wrote table data with result '. (int)$t35285); $l75101=$u91e7e && $t35285; if ($l75101===false){ break; } } if(__LOG)__log('DB Backup: wrote data with running == '. (int)$l75101); if ($l75101){ e2_write_dump_footer($p2beda); fseek($p2beda,0); $k8c7dd=fopen($oa9745,'w+'); while ($l75101 && ($k8d777=fread($p2beda,1024))) { if(e2_check_timeout()) { fwrite($k8c7dd,$k8d777); } else { $l75101=false; } } fclose($k8c7dd); } fclose($p2beda); return $l75101; } function w3e5c($b0c426,$content){ $q52766=MTMPL_FOLDER.$b0c426 .'.mtmpl.php'; if(is_file($q52766)) { ob_start(); include $q52766; $tde7a3=ob_get_contents(); ob_end_clean(); return trim($tde7a3); } } function jaed2(){ global$_config,$_superconfig; $a9e35a=$_config['mail_from']; if (@$_superconfig['mail_from']) { $a9e35a=$_superconfig['mail_from']; } if ($a9e35a[strlen($a9e35a)-1]=='@'){ $a9e35a.=$_SERVER['HTTP_HOST']; } return $a9e35a; } function xa41b($t01b6e,$subject,$i78e73,$v145a2=''){ global$_superconfig; if (@$_superconfig['mail_debug']) { $g8fa14=tempnam('mail-debug',''); $e1cb25=( 'To:       '.$t01b6e ."\n". 'Subject:  '.$subject ."\n". $v145a2 ."\n". "--------------------------------------------------\n". $i78e73 ); k6e52($g8fa14,$e1cb25); chmod($g8fa14,NEW_FILES_RIGHTS); rename($g8fa14,$g8fa14.'.txt'); } $subject='=?UTF-8?B?'. base64_encode($subject) .'?='; $v145a2.="\r\nContent-Type: text/plain; charset=utf-8"; mail($t01b6e,$subject,$i78e73,trim($v145a2)); } function _A($e1cb25){ global$_candy,$_protocol,$s57de2,$ya57c1,$_current_url; if ( preg_match('/\<a href\=\"(.*?)\"[^>]*\>(.*?)\<\/a\>/si',$e1cb25,$v9c28d) and ( $v9c28d[1]=='' or $v9c28d[1]==$_current_url or $_protocol .'://'. $s57de2.$v9c28d[1]==$_current_url or $_protocol .'://'. $s57de2.$ya57c1 .'/'. $v9c28d[1]==$_current_url or $_candy=='e2m_install' ) ) { return $v9c28d[2]; } else { return $e1cb25; } } function _AT($he8fab){ global$_candy,$s57de2,$ya57c1,$_current_url; return ( $he8fab=='' or $he8fab==$_current_url or $_protocol .'://'. $s57de2.$he8fab==$_current_url or $_protocol .'://'. $s57de2.$ya57c1 .'/'. $he8fab==$_current_url ); } function _IMGSRC($i435ed){ return f1492($i435ed); } function _SVG($i435ed){ return zf42c($i435ed); } function _COLOR($jf97c5,$pb8a9f,$occ321,$r4efa2=1){ if(strlen($jf97c5)!=3 and strlen($jf97c5)!=6) return 'f0f'; if(strlen($pb8a9f)!=3 and strlen($pb8a9f)!=6) return 'f0f'; if(strlen($jf97c5)==3)$jf97c5=$jf97c5{0}.$jf97c5{0}.$jf97c5{1}.$jf97c5{1}.$jf97c5{2}.$jf97c5{2}; if(strlen($pb8a9f)==3)$pb8a9f=$pb8a9f{0}.$pb8a9f{0}.$pb8a9f{1}.$pb8a9f{1}.$pb8a9f{2}.$pb8a9f{2}; $vf09cc=array ( $jf97c5{0}.$jf97c5{1}, $jf97c5{2}.$jf97c5{3}, $jf97c5{4}.$jf97c5{5}, $pb8a9f{0}.$pb8a9f{1}, $pb8a9f{2}.$pb8a9f{3}, $pb8a9f{4}.$pb8a9f{5}, ); foreach ($vf09cc as $w8ce4b => $o9e366){ $vf09cc[$w8ce4b]=hexdec($o9e366); } $y22af6=array ( $vf09cc[0]+pow($occ321,$r4efa2) * ($vf09cc[3]-$vf09cc[0]), $vf09cc[1]+pow($occ321,$r4efa2) * ($vf09cc[4]-$vf09cc[1]), $vf09cc[2]+pow($occ321,$r4efa2) * ($vf09cc[5]-$vf09cc[2]), ); $d70dda=''; foreach ($y22af6 as $w8ce4b => $o9e366){ $d70dda.=str_pad(dechex($o9e366),2,'0',STR_PAD_LEFT); } return $d70dda; } function _DT($i1ddcb,$rb35c6){ if (!$rb35c6) return ''; list ($h96b8c,$ob2c6c)=$rb35c6; $v2cb9d=$i1ddcb; $k7436f=f5a2f('m',$h96b8c,$ob2c6c); $v2cb9d=str_replace('{zone}',e2__escape_all(t9515($ob2c6c['offset'])), $v2cb9d); $v2cb9d=str_replace('{month}',e2__escape_all(e2l_get_string('um--month', array ('month' => $k7436f))), $v2cb9d); $v2cb9d=str_replace('{month-short}',e2__escape_all(e2l_get_string('um--month-short', array ('month' => $k7436f))), $v2cb9d); $v2cb9d=str_replace('{month-g}',e2__escape_all(e2l_get_string('um--month-g', array ('month' => $k7436f))), $v2cb9d); $v2cb9d=f5a2f($v2cb9d,$h96b8c,$ob2c6c); return $v2cb9d; } function _AGO($rb35c6){ return q7a0b($rb35c6[0], array ('offset' => $rb35c6[1]['offset'],'is_dst' => $rb35c6[1]['is_dst']) ); } function _NUM($e1cb25){ return e2_decline_for_number($e1cb25); } function _FIRST($t437b9){ return ($t437b9['_']['_ord']==0); } function _LAST($t437b9){ return ($t437b9['_']['_ord']==$t437b9['_']['_ord_max']); } function _CSS($bc7a62){ return zd4c1($bc7a62); } function _CSS_HREF($bc7a62){ return p576f($bc7a62); } function _JS($s32981){ return ad00a($s32981); } function _LIB($ne8acc){ return j16f0($ne8acc); } function _T($c52678){ return f166b($c52678); } function _X($c52678){ return c6a97($c52678); } function _T_FOR($c52678,$pd5566=null){ global$content; if ($pd5566===null)$pd5566=$c52678; if(array_key_exists($pd5566,$content)) { f166b($c52678); } else { return ''; } } function _GUIDES($deca07=false){ global$_olba_guides; if(is_array($deca07))$_olba_guides=$deca07; if (!is_array($_olba_guides)) return; $r88408='<div style="position: fixed; width: 100%; height: 100%; z-index: -100">'; $j1d623=0; $q07d43=$_olba_guides; $q07d43[] = 100; foreach ($q07d43 as $q865c0 => $xd89e2){ if ($xd89e2==100) break; $j1d623+=$xd89e2; $r88408.='<div style="position: fixed; left: '. $xd89e2 .'%; width: 0; height: 100%; border-left: 1px #000 dotted; opacity: .2; -webkit-opacity: .2; -moz-opacity: .2"></div>'; $ra1b01='position: absolute; padding: 2px 3px; top: 0; font-size: 9px; background: #ccc; color: #000; font-family: "Verdana", sans-serif; opacity: .8; -webkit-opacity: .8; -moz-opacity: .8'; if ($q07d43[$q865c0+1]-$q07d43[$q865c0] < 4){ $r88408.='<div style="'. $ra1b01.'; right: '. (100-$xd89e2) .'%; border-bottom-left-radius: .5em; -webkit-border-bottom-left-radius: .5em; -moz-border-bottom-left-radius: .5em;">'. $xd89e2 .'%</div>'; } else { $r88408.='<div style="'. $ra1b01.'; left: '. $xd89e2 .'%; border-bottom-right-radius: .5em; -webkit-border-bottom-right-radius: .5em; -moz-border-bottom-right-radius: .5em;">'. $xd89e2 .'%</div>'; } } $r88408.='</div>'; $_olba_current_col=0; return $r88408; } function _S($zb45cf){ global$_strings; return$_strings[$zb45cf]; } function _SHORTCUT($lb0689){ return wbb8d($lb0689); } function e2__escape_all($zb45cf){ $v2cb9d=''; for ($q865c0=0; $q865c0 < mb_strlen($zb45cf); ++ $q865c0){ $v2cb9d.='\\'. mb_substr($zb45cf,$q865c0,1); } return $v2cb9d; } function e2l_get_string($yfa206,$k8d777){ global$_strings; $lb0689=$_strings[$yfa206]; if(preg_match_all('/\$\[(.+?)\]/u',$lb0689,$v9c28d,PREG_SET_ORDER)) { foreach ($v9c28d as $te3cc9){ $yb2145=$te3cc9[1]; $if2ffc=''; if(strstr($yb2145,'.')) list ($yb2145,$if2ffc)=explode('.',$yb2145,2); if(array_key_exists($yb2145,$k8d777)) { if ($if2ffc){ $lb0689=str_replace($te3cc9[0],e2l__format_value($if2ffc,$k8d777[$yb2145],$yfa206),$lb0689); } else { $lb0689=str_replace($te3cc9[0],$k8d777[$yb2145],$lb0689); } } } } return $lb0689; } function e2l_transliterate($zb45cf){ $ie358e=array(); if(is_file(DEFAULTS_FOLDER.'translit.txt')) { $ie358e=file(DEFAULTS_FOLDER.'translit.txt'); } $pd98a0=$t01b6e=''; foreach ($ie358e as $q865c0 => $g6438c){ if (!($q865c0%2))$pd98a0.=rtrim($g6438c) .' '; else $t01b6e.=rtrim($g6438c) .' '; if ($q865c0%2){ while (mb_strlen($t01b6e) < mb_strlen($pd98a0))$t01b6e.=' '; while (mb_strlen($t01b6e) > mb_strlen($pd98a0))$pd98a0.=' '; } } $c60ae1=''; $zde2e7=-1; for ($q865c0=0; $q865c0 < mb_strlen($pd98a0); ++ $q865c0){ $u4a8a0=mb_substr($pd98a0,$q865c0,1); if ($u4a8a0!=' '){ $c60ae1.=$u4a8a0; if ($zde2e7 == -1)$zde2e7=$q865c0; } elseif ($c60ae1){ $n52ac1=trim(mb_substr($t01b6e,$zde2e7,mb_strpos($t01b6e,' ',$zde2e7+1)-$zde2e7)); $z33c9b=array ($c60ae1,$n52ac1); $uce83f[mb_strlen($c60ae1)][] = $z33c9b; $c60ae1=''; $zde2e7=-1; } } $b1d78d=array(); for ($q865c0=count($uce83f); $q865c0 > 0; -- $q865c0){ foreach ($uce83f[$q865c0] as $z33c9b)$b1d78d[$z33c9b[0]] = $z33c9b[1]; } return strtr($zb45cf,$b1d78d); } function e2l__format_value($if2ffc,$b2063c,$yfa206){ list ($if2ffc,$m3ad73)=explode('.',$if2ffc,2); $me6875='e2lstr_'. $if2ffc; if(function_exists($me6875)) { return call_user_func($me6875,$b2063c,$m3ad73,$yfa206); } else { return $b2063c; } return $b2063c; } spl_autoload_register(f713e); if($_config['write_log_reset'])__log(null); if(__LOG)__log('System: loaded'); if(is_file($y2d354=LANGUAGES_FOLDER.$settings['language'] .'.php')) { $_lang=$settings['language']; include $y2d354; } elseif(is_file($y2d354=LANGUAGES_FOLDER.DEFAULT_LANGUAGE .'.php')) { $_lang=DEFAULT_LANGUAGE; include $y2d354; } else { die ('Language file missing: '. $y2d354); } $_strings=e2l_load_strings(); if(!$t589b3) @include 'builder.php'; function e2(){ global $s57de2,$settings,$errors,$content, $ya57c1,$full_blog_url,$stopwatch,$i11755, $_current_url, $_newsfeeds, $_instance, $_candy, $_config, $_superconfig, $_route, $_strings, $_lang, $_candies_installer, $_candies_public, $_candies_indexable, $_candies_indexable_conditionally, $_candies_ajax, $_candies_to_disallow_in_read_only, $_user_folder_name, $_template, $_olba_includes, $_diagnose; c269a(); if(__LOG)__log('System: go'); $errors=array(); header('Content-type: text/html; charset='. OUTPUT_CHARSET); $_instance=false; if (@is_file(USER_FOLDER.'instance.psa')) { $j0d149=@file_get_contents(USER_FOLDER.'instance.psa') or $j0d149=false; if ($j0d149){ $j0d149=@unserialize($j0d149) or $j0d149=false; if ($j0d149){ $_instance=$j0d149; } } } $c66f61=@$settings['template'] or $c66f61=DEFAULT_TEMPLATE; n4e27($c66f61); $x572d4=urldecode($_GET['go']); if(__LOG)__log('System: Resolve <'. $x572d4 .'> {'); r7059(); list ($cc48ba,$parameters)=pb7e9($x572d4); foreach($_GET as $n3c6e0 => $b2063c){ $parameters[$n3c6e0]=$b2063c; } if(__LOG)__log('} // Resolve'); if(__LOG)__log( 'System: Candy <'. $cc48ba .'> {' ); if(__LOG)__log('Parameters: <'. print_r($parameters,true).'>'); $_candy=$cc48ba; $content=array(); if ( @$_config['debug_slow_ajax'] and ( in_array($cc48ba,$_candies_ajax) ) ) { sleep(1+2 * (rand()/getrandmax())); } if (!in_array($cc48ba,$_candies_installer)) { e2_make_sure_that_installed(); } if (@$_superconfig['read_only'] and in_array($cc48ba,$_candies_to_disallow_in_read_only)) { $cc48ba='e2m_error404'; } $h58387=(bool)ye852(); $h0b448=!in_array($cc48ba,$_candies_public); $g49ecc=$h0b448 && !$h58387; if(__LOG)__log('System: signed in? '. (int)$h58387); $sc1f6f=array ( 'done?' => $h58387, 'required?' => $h0b448, 'necessary?' => $g49ecc, ); $_newsfeeds=false; x3010('rss',b6f51(),r83c8('e2m_rss')); x3010('json',b6f51(),r83c8('e2m_json')); if(is_callable($cc48ba)) { if ($g49ecc){ if(substr($cc48ba,0,4)=='e2s_'){ $content=call_user_func('e2s_sign_in_necessary'); } else { $content['title']=$_strings['pt--sign-in']; } } else { if(__LOG)__log('System: candy call'); $content=call_user_func($cc48ba,$parameters); if(__LOG)__log('System: candy return'); } } else { $sc1f6f['required?']=false; $sc1f6f['necessary?']=false; $content=e2_error404_mode(); } if(__LOG)__log('} // Candy'); if (!array_key_exists('notes',$content))$content['notes'] = array (); if (!array_key_exists('drafts',$content))$content['drafts'] = array (); if (!array_key_exists('comments',$content))$content['comments'] = array (); if (!array_key_exists('notes-list',$content))$content['notes-list'] = array (); if (!array_key_exists('tags',$content))$content['tags'] = array (); $content['class']=str_replace('_','-',str_replace('e2m_','',$cc48ba)); $content['sign-in']=$sc1f6f; $content['sign-in-prompt']=$_strings['gs--need-password']; if(e2_is_installed()) { if(__LOG)__log('System: nav and pages'); $content['navigation-links'] = array (array ( 'rel' => 'index', 'href' => r83c8('e2m_frontpage', array ('page' => 1)), 'id' => 'link-index', )); if(array_key_exists('pages',$content)) { foreach (array ('prev','next','earlier','later') as $vc47d1){ if(array_key_exists($vc47d1 .'-href',$content['pages'])) { $k7ffc4=$vc47d1; if ($vc47d1=='earlier')$k7ffc4='prev'; if ($vc47d1=='later')$k7ffc4='next'; $content['navigation-links'][] = array ( 'rel' => $k7ffc4, 'href' => $content['pages'][$vc47d1 .'-href'], 'id' => 'link-'. $vc47d1, ); } } } if(__LOG)__log('System: search form'); if(array_key_exists('query',$parameters)) { $s1b1cc=trim($parameters['query']); } else { $s1b1cc=''; } $content['search'] = array ( 'form-action' => r83c8('e2s_search'), 'query' => htmlspecialchars(@$s1b1cc,ENT_COMPAT,HSC_ENC), ); if(__LOG)__log('System: blog information'); $content['blog']['author']=htmlspecialchars(v2640(),ENT_NOQUOTES,HSC_ENC); if(array_key_exists('description',$settings)) { $s2bfe4=ob7f1($settings['description'],'full'); $g67daf=$s2bfe4['text-final']; $content['blog']['description']=$g67daf; $content['blog']['description-format-info']=$s2bfe4['meta']; } $content['blog']['title']=htmlspecialchars(b6f51(),ENT_NOQUOTES,HSC_ENC); $content['blog']['userpic-set?']=false; if($content['blog']['userpic-href']=b2461()) { $content['blog']['userpic-set?']=true; } else { $content['blog']['userpic-href']=DEFAULT_USERPIC_FILENAME; if (ye852()) { $content['blog']['userpic-href']=DEFAULT_USERPIC_PLACEHOLDER_FILENAME; } } $content['blog']['favicon-type']='image/x-icon'; $content['blog']['favicon-href']='favicon.ico'; if (ye852()) { $content['blog']['userpic-upload-action']=r83c8('e2j_userpic_upload'); } $content['blog']['href']=r83c8('e2m_frontpage', array ('page' => 1)); $content['blog']['rss-href']=r83c8('e2m_rss'); $content['blog']['jsonfeed-href']=r83c8('e2m_json'); $content['blog']['language']=$_lang; $content['blog']['show-subscribe-button?']=false; $content['template']['use-likely-light?']=$_template['use_likely_light']; if(__LOG)__log('System: edge timeinfo'); $t97bc5=array (time(),m5c05()); $e5f36b=ga846('Y',$t97bc5[0]); $content['blog']['now']=$t97bc5; $maa103=$e5f36b; $x33b09=acc02('start'); if(array_key_exists('stamp',$x33b09)) { $maa103=ga846('Y',$x33b09['stamp']); $content['blog']['start-time'] = array ((int)$x33b09['stamp'],$x33b09['timezone']); } $r40d73=(int)o8ca0(true,true); if (ye852()) { if(__LOG)__log('System: stuff for logged in user'); $content['blog']['drafts-count'] = (int)o8ca0(false,true); $content['admin-hrefs'] = array ( 'new-note' => r83c8('e2m_write'), 'drafts' => r83c8('e2m_drafts'), 'settings' => r83c8('e2m_settings'), 'theme-preview' => r83c8('e2m_theme_preview', array ('theme' => '')), 'password' => r83c8('e2m_password'), 'database' => r83c8('e2m_database'), 'timezone' => r83c8('e2m_timezone'), 'logout' => r83c8('e2m_sign_out'), ); if (pda67()) { $content['admin-hrefs']['get-backup']=r83c8('e2m_get_backup'); } if (@$_superconfig['read_only']) { unset($content['admin-hrefs']['new-note']); unset($content['admin-hrefs']['settings']); unset($content['admin-hrefs']['timezone']); } if (@$_superconfig['disallow_themes_preview']) { unset($content['admin-hrefs']['theme-preview']); } if (@$_superconfig['disallow_db_config']) { unset($content['admin-hrefs']['database']); } list ($dfe9e2,$g85ee4,$t20699)=n2a6b(); if ($dfe9e2)$content['new-comments'] = array ( 'count' => $dfe9e2, 'href' => $t20699, ); } else { if(__LOG)__log('System: login form'); $content['form-login']['form-action']=r83c8('e2s_sign_in'); $content['form-login']['form-check-password-action']=r83c8('e2j_check_password'); $content['form-login']['login-name'] = @$settings['author']; $content['form-login']['public-pc?']=false; if(array_key_exists('_login_request_message',$content)) { $content['form-login']['request']=$content['_login_request_message']; } } if (ye852()) { $bd0a87=(($r40d73 + (int)o8ca0(true,false)) == 0); } else { $bd0a87=($r40d73==0); } if($_db_error){ $bd0a87=false; } $j9fbfe=$_config['years_range_separator']? $_config['years_range_separator']:'&mdash;'; $content['blog']['years-range']=$maa103 . (($maa103==$e5f36b)? '':($j9fbfe.$e5f36b)); $content['blog']['notes-count']=$r40d73; $content['blog']['virgin?']=$bd0a87; if ($ya57c1){ $content['blog']['parent-site-href']=substr($ya57c1, (int)strpos('/',$ya57c1)); } $content['hrefs'] = array ( 'sign-in' => r83c8('e2m_sign_in'), 'tags' => r83c8('e2m_tags'), 'everything' => r83c8('e2m_everything'), ); } $h1e2ad='noindex, follow'; if (@$_config['index_follow_everything']) { $h1e2ad='index, follow'; } if(in_array($cc48ba,$_candies_indexable)) { $content['robots']='index, follow'; } if(in_array($cc48ba,$_candies_indexable_conditionally)) { $content['robots']=$h1e2ad; } $content['output-charset']=OUTPUT_CHARSET; $content['base-href']=$full_blog_url. '/'; $content['current-href']=$_current_url; if (!array_key_exists('summary',$content)) { $content['summary']=strip_tags($content['blog']['description']); } $content['title']=strip_tags(t6f10(htmlspecialchars($content['title'],ENT_NOQUOTES,HSC_ENC))); if (@$content['heading']) { $content['heading']=strip_tags(t6f10(htmlspecialchars($content['heading'],ENT_NOQUOTES,HSC_ENC))); } if(__LOG)__log('System: e2_modes {'); e2_modes($parameters); if(__LOG)__log('} // e2_modes'); if (@$_config['request_logging']) { $g8fa14=fopen(USER_FOLDER. 'log-'. date('Y-m-d') .'.txt','a'); fwrite($g8fa14,date('d.m.Y H:i:s') ."\tT = ". $content['pgt'] ."\tQ = ". $content['total_queries'] ."\tIP = ". $_SERVER['REMOTE_ADDR'] ."\tRequest = ". $_SERVER['REQUEST_URI'] ."\r\n"); fclose($g8fa14); } $content['misc']['sape-link']='http://www.sape.ru/r.206a4276c2.php'; $mc8542=round(s7f78()-$stopwatch,3); $seccd7='http://'. $_strings['e2--website-host'] .'/'; $content['engine']['pgt']=str_replace('.',',',$mc8542); if(function_exists('memory_get_peak_usage')) { $content['engine']['mp']=str_replace('.',',',round((memory_get_peak_usage()/1024/1024)*100)/100); } $content['engine']['qc'] = (int) @$i11755; $content['engine']['built?']=$t589b3; $content['engine']['installed?']=e2_is_installed(); $content['engine']['version']='v'. E2_VERSION; $o68966='('. $_strings['e2--release'] .' '. E2_RELEASE .', v'. E2_VERSION .')'; $content['engine']['version-description']=$_strings['e2--vname-aegea'] .' '. $o68966; $content['engine']['user-folder-name']=$_user_folder_name; $content['engine']['cookie-prefix']=l8c3b(); $content['engine']['href']=$seccd7; $content['engine']['about']='<span title="E2 '.$o68966 .'">'. $_strings['e2--powered-by'] .' <a href="'. $seccd7 .'" class="nu"><u>'. $_strings['e2--vname-aegea'] .'</u> <span class="e2-svgi">'. _SVG('aegea') .'</span></a></span>'; $content['meta-viewport']=$_template['meta_viewport']; $content['stylesheets']=k37ca(); $content['scripts']=n4753(); if (!@isset ($_diagnose['ok?'])) { if (@$_COOKIE[l8c3b('diagnose')] or @$_diagnose['need?']) { a8739(); } } if ($je1671=bec07()) { $content['message']=$je1671; } if (ye852()) { $content['last-modifieds-by-id']='{}'; if (@$_COOKIE[l8c3b('local_copies')]) { $content['last-modifieds-by-id'] = ( sa2d8($_COOKIE[l8c3b('local_copies')]) ); } } $content['og-images'] = array (); if(is_array($content['notes']['only']['og-images'])) { $content['og-images']=$content['notes']['only']['og-images']; $content['twitter-card']='summary_large_image'; } if(is_array($content['tag']['og-images'])) { $content['og-images']=$content['tag']['og-images']; $content['twitter-card']='summary_large_image'; } if (!count($content['og-images'])) { $content['twitter-card']='summary'; $content['og-images'] = array ($content['blog']['userpic-href']); } ob_start(); hbc21(); $l78e62=ob_get_contents(); ob_end_clean(); if(is_array($content['notes'])) { foreach($content['notes'] as $laad65){ if(is_array($laad65['format-info']['links-required'])) { foreach ($laad65['format-info']['links-required'] as $s2a304){ if(substr($s2a304, -3)=='.js'){ ad00a(substr($s2a304,0, -3)); } if(substr($s2a304, -4)=='.css'){ zd4c1(substr($s2a304,0, -4)); } } } } } $content['stylesheets']=k37ca(); $content['scripts']=n4753(); if($_newsfeeds)$content['newsfeeds']=$_newsfeeds; ob_start(); f166b('head'); $k61ef8=ob_get_contents(); ob_end_clean(); ob_start(); f166b('scripts'); $xee59b=ob_get_contents(); ob_end_clean(); $l78e62=str_replace('<e2:head-data />',$k61ef8,$l78e62); $l78e62=str_replace('<e2:scripts-data />',$xee59b,$l78e62); $kfa6a9=false; if (q3b97()) { if(is_writable(USER_FOLDER.'indexing.psa')) { $kfa6a9=true; } else { $_diagnose['need?']=true; gc64a('diagnose','1'); } } if ( $oa0856=ze655() and !$_config['ignore_missing_template_files'] ) { echo '<h1>Templates missing</h1>'; echo '<ul>'; foreach ($oa0856 as $f380ec){ echo '<li>'. $f380ec.' </li>'; } echo '</ul>'; echo '<pre>'; print_r($content); echo '</pre>'; } else { echo $l78e62; } if ($kfa6a9){ if(__LOG)__log('System: spawn BSI step'); tcc38(r83c8('e2s_bsi_step', array ())); } if(__LOG)__log('} // System'); if(DEV_TRACK_TIME and $s57de2==DEV_HOST){ $a06bc4=str_replace('.',',',round(s7f78()-$stopwatch,3)-$mc8542); echo '<div style="font-size: 300%; text-align: center; position: fixed; bottom: 0; width: 100%; background: #ffc; opacity: .88">'. '<span style="color: #f80">'. $content['engine']['pgt'] .' '. '<small>'. $content['engine']['qc'] .'q</small></span>'. '<span style="color: #08f"> + '. $a06bc4.' '. '<small>'. $_olba_includes .'i</small></span>'. '</div>'; } } if(__LOG)__log(''); ?>